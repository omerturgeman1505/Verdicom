<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>verdicom.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  
  <!-- File Viewer Libraries -->
  <!-- JSZip is required by docx-preview for handling ZIP files (DOCX is a ZIP archive) -->
  <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
<style>
    :root {
      --bg-dark: #060b16;
      --bg-light: rgba(17, 25, 40, 0.9);
      --border-color: rgba(94, 234, 212, 0.14);
      --panel-border: rgba(148, 163, 184, 0.2);
      --panel-bg: rgba(12, 18, 33, 0.95);
      --panel-bg-solid: rgba(12, 18, 33, 0.95);
      --text-primary: #E6F1FF;
      --text-secondary: #9BAAC5;
      --accent-blue: #3B82F6;
      --accent-teal: #14B8A6;
      --accent-blue-hover: #2563EB;
      --accent-gradient: linear-gradient(135deg, #5EEAD4 0%, #0891B2 45%, #2563EB 100%);
      --danger-bg: rgba(239, 68, 68, 0.1);
      --danger-border: #EF4444;
      --danger-text: #F87171;
      --success-text: #34D399;
      --glow-shadow: 0 24px 45px rgba(20, 184, 166, 0.18);
      --shadow-soft: 0 8px 16px rgba(8, 112, 184, 0.12);
    }

    body {
      font-family: 'Montserrat', 'Segoe UI', sans-serif;
      background:
        radial-gradient(1400px 800px at 10% -10%, rgba(20, 184, 166, 0.12), transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, rgba(37, 99, 235, 0.18), transparent 60%),
        linear-gradient(180deg, #04070f 0%, #0A1120 45%, #050910 100%);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(94, 234, 212, 0.02) 0%, rgba(37, 99, 235, 0.01) 100%);
      opacity: 0.6;
      pointer-events: none;
      mix-blend-mode: lighten;
    }

    header {
      /* HEADER BACKGROUND UPDATED to blend with page bg */
      background: linear-gradient(180deg, #0D1620 0%, var(--bg-light) 100%);
      color: #FFF;
      padding: 30px 20px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      cursor: default;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(20, 184, 166, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }

    .header-content {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 1;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Brand logo + text */
    .brand-logo {
      height: 62px;
      width: auto;
      display: block;
      filter: drop-shadow(0 14px 30px rgba(20, 184, 166, 0.5));
      pointer-events: none;
      user-select: none;
      transition: transform 0.3s ease, filter 0.3s ease;
      animation: logoFloat 6s ease-in-out infinite;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      margin-right: -15px;
    }

    .header-content:hover .brand-logo {
      filter: drop-shadow(0 20px 40px rgba(20, 184, 166, 0.6));
    }

    .brand-text {
      display: inline-block;
      margin: 0;
      font-size: 39px;
      font-weight: 700;
      letter-spacing: 4px;
      text-transform: lowercase;
      background: linear-gradient(138deg, #a2fff3 0%, #5eead4 24%, #2ebfd0 52%, #1d90ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      position: relative;
      padding-left: 2px;
      filter: drop-shadow(0 14px 30px rgba(20, 184, 166, 0.45));
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      transition: filter 0.3s ease, transform 0.3s ease;
    }

    .brand-text::after {
      content: '.io';
      font-size: 25px;
      letter-spacing: 2.2px;
      margin-left: 8px;
      background: linear-gradient(135deg, #dbe7ff 0%, #a9b8ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      opacity: 0.75;
    }

    .brand-text::before {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 140%;
      height: 4px;
      background: linear-gradient(90deg,
        rgba(20, 184, 166, 0) 0%,
        rgba(20, 184, 166, 0.55) 20%,
        rgba(59, 130, 246, 0.6) 50%,
        rgba(20, 184, 166, 0.55) 80%,
        rgba(20, 184, 166, 0) 100%);
      opacity: 0.7;
      border-radius: 999px;
      animation: shimmer 4s ease-in-out infinite;
    }

    @keyframes logoFloat {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-6px);
      }
    }

    .header-content:hover .brand-text {
      filter: drop-shadow(0 14px 30px rgba(20, 184, 166, 0.55));
    }

    @keyframes shimmer {
      0%, 100% {
        opacity: 0.4;
        transform: translateX(-50%) scaleX(0.8);
      }
      50% {
        opacity: 0.8;
        transform: translateX(50%) scaleX(1.2);
      }
    }

    /* Responsive design for header */
    @media (max-width: 768px) {
      header {
        padding: 20px 15px;
      }
      .brand-text {
        font-size: 26px;
        letter-spacing: 2px;
      }
      .brand-logo {
        height: 44px;
      }
      .header-content {
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .brand-text {
        font-size: 22px;
        letter-spacing: 1.5px;
      }
      .brand-logo {
        height: 38px;
      }
      .header-content {
        gap: 10px;
      }
    }

    .content-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 48px 32px 96px;
      display: grid;
      gap: 32px;
      position: relative;
      z-index: 5; /* Higher than background overlays to ensure content is clickable */
    }

    .neon-panel {
      position: relative;
      border-radius: 18px;
      padding: 28px 32px;
      background: rgba(10, 18, 32, 0.96);
      border: 1px solid var(--panel-border);
      box-shadow: var(--shadow-soft);
      transition: border 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
    }

    .neon-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, rgba(94, 234, 212, 0.55), rgba(37, 99, 235, 0.4));
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      opacity: 0.45;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .neon-panel:hover {
      box-shadow: 0 12px 24px rgba(8, 112, 184, 0.18);
    }

    .neon-panel:hover::before {
      opacity: 0.8;
    }
    
    /* Disable hover animation for Threat Constellation Map panel */
    .threat-map-panel:hover {
      transform: none !important;
      box-shadow: var(--shadow-soft) !important;
    }
    .threat-map-panel:hover::before {
      opacity: 0.45 !important;
    }

    .hero-grid {
      display: grid;
      gap: 24px;
    }

    .search-suite {
      display: grid;
      gap: 18px;
    }

    .lookup-form {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .lookup-form .control {
      flex: 1;
      min-width: 240px;
      position: relative;
    }

    .lookup-form input {
      width: 100%;
      padding: 16px 18px;
      border-radius: 12px;
      border: 1px solid rgba(94, 234, 212, 0.18);
      background: rgba(14, 23, 42, 0.85);
      color: var(--text-primary);
      font-size: 16px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
      outline: none;
    }

    .lookup-form input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    .lookup-form input:focus {
      border-color: rgba(94, 234, 212, 0.6);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
    }

    .log-textarea {
      width: 100%;
      min-height: 170px;
      background: rgba(14, 23, 42, 0.88);
      border: 1px solid rgba(94, 234, 212, 0.18);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 15px;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      resize: vertical;
      transition: border 0.2s ease, box-shadow 0.2s ease;
      outline: none;
    }

    .log-textarea:focus {
      border-color: rgba(94, 234, 212, 0.55);
      box-shadow: 0 10px 30px rgba(8, 112, 184, 0.18);
    }

    .btn-primary {
      padding: 16px 28px;
      border-radius: 12px;
      border: none;
      background: var(--accent-gradient);
      color: #0b1220;
      font-weight: 600;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.28);
      letter-spacing: 0.5px;
      z-index: 10; /* Ensure it's above background */
    }

    /* Ensure all direct children (icons, text) are above the shine effect but don't block clicks */
    .btn-primary > * {
      position: relative;
      z-index: 2;
      pointer-events: none; /* Allow clicks to pass through to the button */
    }

    .btn-primary::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s ease;
      z-index: 1;
      pointer-events: none; /* The shine effect must not capture mouse events */
    }

    .btn-primary:hover {
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover::after {
      transform: translateX(100%);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(94, 234, 212, 0.25);
      color: var(--text-primary);
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      letter-spacing: 0.4px;
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .btn-secondary:hover {
      background: rgba(20, 184, 166, 0.12);
      border-color: rgba(94, 234, 212, 0.55);
    }

    .surface-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .metric-tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .metric-card {
      position: relative;
      padding: 16px 20px;
      border-radius: 14px;
      background: rgba(12, 21, 37, 0.78);
      border: 1px solid rgba(94, 234, 212, 0.18);
      box-shadow: 0 10px 28px rgba(8, 112, 184, 0.18);
      overflow: hidden;
      transition: transform 0.3s ease, border-color 0.3s ease;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle, rgba(94, 234, 212, 0.18) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .metric-card:hover {
      border-color: rgba(94, 234, 212, 0.45);
    }

    .metric-card:hover::before {
      opacity: 1;
    }

    .metric-card .label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: rgba(148, 163, 184, 0.7);
      margin-bottom: 8px;
    }

    .metric-card .value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 1px;
      color: #e9faff;
      text-shadow: 0 12px 24px rgba(20, 184, 166, 0.2);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, rgba(94,234,212,0.4) 0%, transparent 90%);
      border-radius: 999px;
    }

    .section-subtitle {
      font-size: 14px;
      color: rgba(148, 163, 184, 0.78);
      letter-spacing: 0.4px;
      max-width: 620px;
      line-height: 1.6;
    }

    .lookup-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .lookup-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 24px;
      justify-content: center;
    }

    .card {
      margin-top: 0;
      padding: 24px;
      border-radius: 16px;
      background: rgba(10, 18, 32, 0.96);
      border: 1px solid rgba(94, 234, 212, 0.18);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: -40%;
      right: -20%;
      width: 60%;
      height: 140%;
      background: radial-gradient(circle, rgba(37, 99, 235, 0.18) 0%, transparent 70%);
      opacity: 0.6;
      pointer-events: none;
      transform: rotate(25deg);
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #9bd8ff;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.18);
    }

    .detections-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }

    .detections-table thead th {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      color: rgba(148, 163, 184, 0.75);
      font-weight: 600;
      padding: 10px 8px;
      border-bottom: 1px solid rgba(94, 234, 212, 0.14);
    }

    .detections-table tbody tr {
      border-bottom: 1px solid rgba(94, 234, 212, 0.1);
      transition: background 0.2s ease;
    }

    .detections-table tbody tr:last-child {
      border-bottom: none;
    }

    .detections-table tbody tr:hover {
      background: rgba(37, 99, 235, 0.1);
    }

    .detections-table th,
    .detections-table td {
      padding: 12px 8px;
      vertical-align: top;
    }

    .detections-table th {
      color: rgba(148, 163, 184, 0.8);
      font-weight: 500;
      text-align: left;
      width: 38%;
      font-size: 14px;
    }

    .detections-table td {
      color: var(--text-primary);
      font-weight: 500;
      text-align: left;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 14px;
      word-break: break-word;
    }

    .err {
      margin-top: 10px;
      padding: 12px;
      border-radius: 6px;
      background: var(--danger-bg);
      color: var(--danger-text);
      border: 1px solid var(--danger-border);
      white-space: pre-wrap;
      font-family: 'Calibri', monospace;
      font-size: 14px;
    }
    
    .chart-card {
        grid-column: 1 / -1;
        overflow: hidden;
    }

    .chart-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 22px;
    }

    .chart-card-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: rgba(224, 241, 255, 0.92);
    }

    .critical-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.22), rgba(220, 53, 69, 0.38));
      color: rgba(255, 236, 239, 0.95);
      border: 1px solid rgba(220, 53, 69, 0.45);
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-weight: 700;
      box-shadow: 0 0 18px rgba(220, 53, 69, 0.15);
      white-space: nowrap;
    }

    .risk-distribution {
      display: grid;
      grid-template-columns: minmax(260px, 360px) 1fr;
      gap: 32px;
      align-items: center;
    }

    .risk-ring {
      position: relative;
      width: clamp(240px, 34vw, 320px);
      aspect-ratio: 1 / 1;
      margin: 0 auto;
    }

    .risk-ring svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      overflow: visible;
      filter: drop-shadow(0 0 22px rgba(55, 206, 179, 0.18));
    }

    .risk-ring circle.risk-track {
      fill: none;
      stroke: rgba(10, 25, 45, 0.68);
      stroke-width: 22;
    }

    .risk-ring circle.risk-segment {
      fill: none;
      stroke-width: 22;
      stroke-linecap: round;
      stroke: var(--segment-color, #5fe0c5);
      transition: stroke-dashoffset 0.45s ease, opacity 0.35s ease;
      opacity: 0.96;
    }

    .risk-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .risk-center-label {
      font-size: 14px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: rgba(152, 180, 210, 0.88);
    }

    .risk-center-value {
      font-size: clamp(32px, 4vw, 44px);
      font-weight: 800;
      color: rgba(94, 234, 212, 0.92);
      letter-spacing: 1px;
    }

    .risk-center-caption {
      font-size: 13px;
      color: rgba(203, 220, 239, 0.7);
      letter-spacing: 0.8px;
    }

    .risk-breakdown {
      display: grid;
      gap: 18px;
      align-self: stretch;
    }

    .risk-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 14px;
      background: rgba(10, 23, 41, 0.55);
      border: 1px solid rgba(46, 139, 198, 0.18);
      box-shadow: inset 0 0 0 1px rgba(12, 30, 52, 0.55);
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .risk-item:hover {
      border-color: rgba(94, 234, 212, 0.35);
    }

    .risk-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-top: 4px;
      background: var(--dot-color, rgba(94, 234, 212, 0.92));
      box-shadow: 0 0 12px rgba(94, 234, 212, 0.4);
    }

    .risk-item-info {
      display: grid;
      gap: 6px;
    }

    .risk-item-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .risk-item-label {
      font-size: 15px;
      font-weight: 650;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: rgba(214, 236, 255, 0.92);
    }

    .risk-item-count {
      font-size: 18px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.92);
    }

    .risk-item-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .risk-item-percent {
      font-size: 13px;
      letter-spacing: 0.8px;
      color: rgba(158, 186, 214, 0.82);
    }

    .risk-item-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 32, 54, 0.6);
      overflow: hidden;
      position: relative;
    }

    .risk-item-bar-fill {
      position: absolute;
      inset: 0;
      width: var(--bar-percent, 0%);
      max-width: 100%;
      background: linear-gradient(90deg, rgba(94, 234, 212, 0.9), rgba(37, 173, 235, 0.9));
      background-color: var(--bar-color, rgba(94, 234, 212, 0.9));
      border-radius: inherit;
      transition: width 0.4s ease;
    }

    .risk-empty {
      text-align: center;
      padding: 40px 20px;
      border-radius: 18px;
      background: rgba(9, 20, 36, 0.8);
      border: 1px dashed rgba(94, 234, 212, 0.25);
      color: rgba(147, 176, 210, 0.85);
      letter-spacing: 0.6px;
      font-size: 14px;
    }

    @media (max-width: 1024px) {
      .risk-distribution {
        grid-template-columns: 1fr;
        justify-items: center;
      }

      .risk-breakdown {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .chart-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .critical-badge {
        font-size: 11px;
        padding: 6px 12px;
      }

      .risk-ring {
        width: clamp(220px, 60vw, 280px);
      }
    }

    .result-card {
        text-align: center;
        font-weight: 500;
        font-size: 16px;
        color: #f8fafc;
        background: rgba(37, 99, 235, 0.18);
        border: 1px solid rgba(59,130,246,0.35);
        border-radius: 12px;
        padding: 16px;
        letter-spacing: 0.8px;
    }
    
    /* --- CSS FOR DETECTIONS --- */
    .toggle-btn {
      width: 100%;
      margin-top: 18px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.6px;
      background: rgba(15, 23, 42, 0.78);
      border: 1px solid rgba(94, 234, 212, 0.25);
      color: var(--text-primary);
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease;
      position: relative;
      z-index: 10; /* Ensure button is above overlays */
    }

    .toggle-btn:hover {
      border-color: rgba(94, 234, 212, 0.55);
      background: rgba(20, 184, 166, 0.14);
    }

    /* Simple expand/collapse button - no complex layering */
    .expand-toggle-btn {
      padding: 6px 12px;
      background: rgba(94, 234, 212, 0.15);
      border: 1px solid rgba(94, 234, 212, 0.4);
      border-radius: 6px;
      color: var(--accent-blue);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
      z-index: 101 !important; /* Must be above Recent History container (z-index: 100) */
      pointer-events: auto !important;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-user-select: none;
    }

    .expand-toggle-btn:hover {
      background: rgba(94, 234, 212, 0.25);
      border-color: rgba(94, 234, 212, 0.6);
      transform: translateY(-1px);
    }

    .expand-toggle-btn:active {
      transform: translateY(0);
      background: rgba(94, 234, 212, 0.2);
    }

    .expand-toggle-btn * {
      pointer-events: none;
    }
    
    #vt-detections {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-top: 10px;
    }
    
    #vt-detections .detections-table {
      table-layout: fixed;
      width: 100%;
    }
    
    #vt-detections .detections-table th,
    #vt-detections .detections-table td {
        font-size: 13px;
        padding: 8px;
        overflow-wrap: break-word;
        vertical-align: top;
        text-align: left; /* Default align left */
    }
    
    #vt-detections .detections-table thead th {
        color: var(--text-secondary);
        font-weight: 400;
    }
    #vt-detections .detections-table tbody th {
        color: var(--text-primary);
        font-weight: 500;
    }
     #vt-detections .detections-table tbody td {
        color: var(--text-primary);
        font-weight: 500;
    }

    .col-engine { width: 35%; }
    .col-category { width: 25%; }
    .col-detection { width: 40%; }
    
    /* --- CSS FOR IPDB REPORTS --- */
    #ipdb-reports {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-top: 10px;
    }
    
    #ipdb-reports .detections-table {
      table-layout: fixed;
      width: 100%;
    }
    
    #ipdb-reports .detections-table th,
    #ipdb-reports .detections-table td {
        font-size: 13px;
        padding: 8px;
        overflow-wrap: break-word;
        vertical-align: top;
        text-align: left;
        color: var(--text-primary);
        font-weight: 500;
    }
    
    #ipdb-reports .detections-table thead th {
        color: var(--text-secondary);
        font-weight: 400;
    }

    .col-ipdb-date { width: 30%; }
    .col-ipdb-cat { width: 30%; }
    .col-ipdb-comment { width: 40%; }

    /* --- CSS FOR SCORE CHART --- */
    .score-chart-container {
      position: relative;
      width: 140px;
      height: 140px;
      margin: 0 auto 20px;
    }
    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      line-height: 1;
    }
    .score-numerator {
      display: block;
      font-size: 36px;
      font-weight: 500;
      font-family: 'Calibri', monospace;
    }
    .score-denominator {
      display: block;
      font-size: 16px;
      color: var(--text-secondary);
    }
    
    /* --- CSS for News Cards --- */
    .news-card {
        margin-bottom: 28px;
        position: relative;
        overflow: hidden;
    }
    .news-card h3 {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.14);
        border: 1px solid rgba(37, 99, 235, 0.35);
        color: #97c1ff;
        font-size: 14px;
        text-transform: uppercase;
    }
    .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
    }
    .news-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 12px;
        letter-spacing: 1px;
        background: rgba(10, 18, 32, 0.8);
        border: 1px solid rgba(94, 234, 212, 0.28);
        border-radius: 999px;
        cursor: pointer;
        transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease;
    }
    .news-toggle:hover {
        border-color: rgba(94, 234, 212, 0.6);
        background: rgba(20, 184, 166, 0.18);
    }
    .news-toggle .icon {
        width: 14px;
        height: 14px;
        display: inline-flex;
    }
    .news-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 260px;
        overflow-y: auto;
    }
    .news-list::-webkit-scrollbar,
    #vt-detections::-webkit-scrollbar,
    #ipdb-reports::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .news-list::-webkit-scrollbar-track,
    #vt-detections::-webkit-scrollbar-track,
    #ipdb-reports::-webkit-scrollbar-track {
        background: rgba(10, 18, 32, 0.5);
        border-radius: 999px;
    }
    .news-list::-webkit-scrollbar-thumb,
    #vt-detections::-webkit-scrollbar-thumb,
    #ipdb-reports::-webkit-scrollbar-thumb {
        background: rgba(94, 234, 212, 0.35);
        border-radius: 999px;
    }
    .news-list::-webkit-scrollbar-thumb:hover,
    #vt-detections::-webkit-scrollbar-thumb:hover,
    #ipdb-reports::-webkit-scrollbar-thumb:hover {
        background: rgba(94, 234, 212, 0.55);
    }
    .news-body {
        margin-top: 16px;
        overflow: hidden;
        max-height: 280px;
        transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
    }
    .news-body.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        pointer-events: none;
    }
    .news-item {
        border-bottom: 1px solid rgba(94, 234, 212, 0.12);
        padding: 12px 6px;
        transition: background 0.2s ease;
    }
    .news-item:last-child {
        border-bottom: none;
    }
    .news-item a {
        text-decoration: none;
        color: var(--text-primary);
        font-weight: 500;
        transition: color 0.2s ease, letter-spacing 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .news-item a:hover {
        color: #7ecdfc;
        letter-spacing: 0.3px;
    }
    /* --- End CSS --- */
    
    /* --- Enhanced CSS for Animation --- */
    .animation-container {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-top: 25px;
      margin-bottom: 20px;
    }

    .computer-icon {
      width: 90px;
      height: 90px;
      color: var(--text-primary);
      background-color: var(--bg-light);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-size: 13px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      z-index: 10;
      position: relative;
      padding: 5px;
    }
    .computer-icon .ip-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 5px;
        word-break: break-all;
    }

    .animation-line {
      flex: 1;                 /* Takes all available space between icons */
      height: 2px;
      background-color: var(--border-color);
      position: relative;      /* So the dot can be positioned inside */
      z-index: 5;
    }

    .animation-dot {
      width: 12px;
      height: 12px;
      background-color: var(--accent-blue);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 0%;
      transform: translateY(-50%); /* Vertically centered */
      animation: transfer-data 2s infinite linear;
      box-shadow: 0 0 8px var(--accent-blue);
      z-index: 15; /* Above the line */
    }

    @keyframes starTwinkle {
      0%, 100% {
        opacity: 0.2;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.2);
      }
    }
    
    @keyframes transfer-data {
      0% {
        left: 0%;
        background-color: var(--accent-blue);
        box-shadow: 0 0 8px var(--accent-blue);
      }
      100% {
        left: 100%;
        background-color: var(--danger-text);
        box-shadow: 0 0 12px var(--danger-text);
      }
    }
    /* --- End CSS for Animation --- */

    /* --- CSS for Log Analysis Cards --- */
    .log-card {
      background: rgba(10, 18, 32, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: 0 8px 16px rgba(8, 112, 184, 0.12);
      position: relative;
      overflow: hidden;
    }

    .log-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(14, 165, 233, 0.05));
      opacity: 0.4;
      pointer-events: none;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .risk-banner {
      box-shadow: 0 24px 48px rgba(8, 112, 184, 0.25);
      border-radius: 14px;
      padding: 18px 20px;
      display: grid;
      gap: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(10, 18, 32, 0.9);
      transition: border 0.3s ease;
    }

    .risk-banner.low {
      border-color: rgba(45, 212, 191, 0.45);
      background: linear-gradient(135deg, rgba(45, 212, 191, 0.18), rgba(10, 18, 32, 0.9));
    }

    .risk-banner.medium {
      border-color: rgba(59, 130, 246, 0.35);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(10, 18, 32, 0.9));
    }

    .risk-banner.high {
      border-color: rgba(239, 68, 68, 0.45);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(10, 18, 32, 0.9));
    }

    .risk-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .risk-tag {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.6px;
      background: rgba(12, 23, 42, 0.65);
      border: 1px solid rgba(94, 234, 212, 0.3);
    }

    .log-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
    }
    /* --- End Log Analysis CSS --- */
    
    /* History Items Hover - Instant, no delay */
    #recent-history-sidebar .history-item {
      transition: none !important;
      will-change: background, border-color;
    }
    
    #recent-history-sidebar .history-item:hover {
      background: rgba(94, 234, 212, 0.1) !important;
      border-color: rgba(94, 234, 212, 0.3) !important;
    }
    
    /* Ensure only one item is highlighted at a time */
    #recent-history-sidebar .history-item:not(:hover) {
      background: rgba(6, 11, 22, 0.6) !important;
      border-color: rgba(94, 234, 212, 0.1) !important;
    }

    footer {
      text-align: center;
      padding: 40px 20px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
</style>
</head>
<body>
  <header>
    <div class="header-content">
      <img src="{{ url_for('static', filename='V.png') }}" alt="Verdicom Logo" class="brand-logo">
      <h2 class="brand-text">erdicom</h2>
    </div>
  </header>

  <main class="content-shell">
    {# Email Forensics Drop Zone - Phase 5 #}
    <section class="neon-panel" style="margin-bottom: 20px;">
      <div id="email-drop-zone" style="
        border: 2px dashed var(--accent-blue);
        background: rgba(10, 18, 32, 0.6);
        padding: 40px;
        text-align: center;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      " onmouseover="this.style.borderColor='rgba(94, 234, 212, 0.8)'; this.style.background='rgba(10, 18, 32, 0.8)';" onmouseout="this.style.borderColor='var(--accent-blue)'; this.style.background='rgba(10, 18, 32, 0.6)';">
        <input type="file" id="file-input" accept=".msg,.eml,application/vnd.ms-outlook,application/x-msmsg" hidden>
        <i data-feather="upload" style="width: 48px; height: 48px; color: var(--accent-blue); margin-bottom: 16px;"></i>
        <h3 style="color: var(--text-primary); margin: 0 0 8px 0; font-size: 18px;">Analyze Email Files</h3>
        <p style="color: var(--text-secondary); margin: 0; font-size: 14px;">Drag & Drop .msg or .eml files for forensic analysis</p>
      </div>
    </section>

    {# File Viewer Modal - Hidden by default #}
    <div id="file-viewer-modal" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      overflow: hidden;
    ">
      <div style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 1200px;
        height: 90%;
        max-height: 800px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: var(--glow-shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      ">
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 16px 20px;
          border-bottom: 1px solid var(--border-color);
          background: var(--panel-bg);
        ">
          <div style="display: flex; align-items: center; gap: 12px;">
            <i data-feather="file-text" style="width: 20px; height: 20px; color: var(--accent-blue);"></i>
            <h3 id="viewer-filename" style="
              margin: 0;
              color: var(--text-primary);
              font-size: 18px;
              font-weight: 600;
            ">File Viewer</h3>
          </div>
          <button id="close-viewer-btn" onclick="closeFileViewer()" style="
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
          " onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.color='var(--accent-blue)';" 
             onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-secondary)';">
            <i data-feather="x" style="width: 16px; height: 16px;"></i>
            Close
          </button>
        </div>
        <div id="viewer-content" style="
          flex: 1;
          overflow: auto;
          padding: 20px;
          background: white;
          color: #000;
        ">
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <i data-feather="loader" style="width: 32px; height: 32px; animation: spin 1s linear infinite;"></i>
            <p>Loading file...</p>
          </div>
        </div>
      </div>
    </div>

    {# Email Report Container - Hidden by default #}
    <div id="email-report-container" style="display: none; margin-bottom: 20px; width: 100%; max-width: 100%; overflow-x: hidden; box-sizing: border-box;">
      <div class="neon-panel" style="width: 100%; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div class="section-title">
            <i data-feather="mail"></i> Email Forensics Report
          </div>
          <button id="close-email-report" style="
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          " onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.color='var(--accent-blue)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-secondary)';">
            <i data-feather="x"></i> Close
          </button>
        </div>

        {# Verdict Banner #}
        <div id="email-verdict-banner" style="
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          text-align: center;
        ">
          <h2 id="email-verdict-text" style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;"></h2>
          <p id="email-score-text" style="margin: 0; font-size: 16px; opacity: 0.9;"></p>
        </div>
        
        {# Threat Score Reasons #}
        <div id="score-reasons-container" style="display: none; margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="bar-chart-2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Threat Score Breakdown
          </h4>
          <div id="score-reasons-list" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
          ">
          </div>
        </div>
        
        {# Verdict Reasons #}
        <div id="verdict-reasons-container" style="display: none; margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="info" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Analysis Verdict Reasons
          </h4>
          <div id="verdict-reasons-list" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
          ">
          </div>
        </div>

        {# Metadata Table #}
        <div style="margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="info" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Email Metadata
          </h4>
          <table class="detections-table" id="email-metadata-table">
            <tr><th>From</th><td id="email-from">—</td></tr>
            <tr><th>To</th><td id="email-to">—</td></tr>
            <tr><th>Subject</th><td id="email-subject">—</td></tr>
            <tr><th>Date</th><td id="email-date">—</td></tr>
          </table>
        </div>

        {# Sender Domain Analysis #}
        <div id="sender-domain-section" style="display: none; margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="globe" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Sender Domain Analysis
          </h4>
          <div id="sender-domain-info" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">Analyzing sender domain...</p>
          </div>
        </div>

        {# DKIM Analysis #}
        <div id="dkim-section" style="display: none; margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="shield" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            DKIM Configuration Analysis
          </h4>
          <div id="dkim-info" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">Checking DKIM configuration...</p>
          </div>
        </div>

        {# Email Spoofing Analysis Section #}
        <div id="spoofing-analysis-section" style="display: none; margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="shield-off" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Email Spoofing Analysis
          </h4>
          <div id="spoofing-analysis-info" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">Analyzing email authentication...</p>
          </div>
        </div>

        {# Message Details Section - Improved Format #}
        <div id="message-details-section" style="display: none; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: var(--text-primary); margin: 0; font-size: 16px;">
              <i data-feather="file-text" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
              Message Details (Full Headers)
            </h4>
            <button 
              id="toggle-message-details" 
              type="button"
              class="expand-toggle-btn"
            >
              <i data-feather="maximize-2" id="message-details-icon" style="width: 14px; height: 14px;"></i>
              <span id="message-details-toggle-text">Expand</span>
            </button>
          </div>
          <div id="message-details-info" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">Loading message details...</p>
          </div>
        </div>

        {# SPF Analysis Section #}
        <div id="spf-section" style="display: none; margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="shield" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            SPF Analysis (All Domains from Received Headers)
          </h4>
          <div id="spf-info" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">Checking SPF configuration...</p>
          </div>
        </div>

        {# All Links Section - Prominent Display #}
        <div style="margin-bottom: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 18px; font-weight: 600;">
            <i data-feather="link" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"></i>
            All Links Found (<span id="email-links-count">0</span>)
            <span id="email-links-note" style="font-size: 12px; font-weight: normal; color: var(--text-secondary); margin-left: 8px;"></span>
          </h4>
          <div id="email-all-links" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            word-break: break-all;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No links found in email.</p>
          </div>
        </div>

        {# Analysis Grid #}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; width: 100%; max-width: 100%; box-sizing: border-box;">
          {# Left: Suspicious Indicators #}
          <div>
            <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
              <i data-feather="alert-triangle" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
              Suspicious Indicators
            </h4>
            <div id="email-keywords-list" style="
              background: var(--bg-light);
              border: 1px solid var(--border-color);
              border-radius: 6px;
              padding: 12px;
              min-height: 100px;
              width: 100%;
              max-width: 100%;
              box-sizing: border-box;
              overflow-x: hidden;
              word-wrap: break-word;
            ">
              <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No suspicious keywords found.</p>
            </div>
          </div>

          {# Right: IP Addresses #}
          <div>
            <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
              <i data-feather="map-pin" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
              IP Addresses Found
            </h4>
            <div id="email-ips-list" style="
              background: var(--bg-light);
              border: 1px solid var(--border-color);
              border-radius: 6px;
              padding: 12px;
              min-height: 100px;
              max-height: 300px;
              overflow-y: auto;
              overflow-x: hidden;
              width: 100%;
              max-width: 100%;
              box-sizing: border-box;
              word-wrap: break-word;
            ">
              <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No IP addresses found.</p>
            </div>
          </div>
        </div>

        {# Attachments Analysis #}
        <div style="margin-top: 20px;">
          <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
            <i data-feather="paperclip" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Attachments Analysis
          </h4>
          <div id="email-attachments-list" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
          ">
            <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No attachments found.</p>
          </div>
        </div>

        {# Body Preview #}
        <div style="margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: var(--text-primary); margin: 0; font-size: 16px;">
            <i data-feather="file-text" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
            Email Body Preview
          </h4>
            <button 
              id="toggle-body-preview" 
              type="button"
              class="expand-toggle-btn"
            >
              <i data-feather="maximize-2" id="body-preview-icon" style="width: 14px; height: 14px;"></i>
              <span id="body-preview-toggle-text">Expand</span>
            </button>
          </div>
          <div id="email-body-preview" style="
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            word-break: break-word;
            transition: max-height 0.3s ease;
          ">—</div>
        </div>
      </div>
    </div>

    <section class="neon-panel search-suite">
      <div class="lookup-meta">
        <div class="section-title">
          <i data-feather="crosshair"></i> Threat Lookup Console
        </div>
        <p class="section-subtitle">
          Investigate indicators across global intelligence feeds. Paste an IP, domain, or hash to assemble a real-time threat dossier.
        </p>
      </div>
      <form method="post" action="/lookup" class="lookup-form">
        <div class="control">
          <input name="query" id="lookup-query-input" placeholder="Enter IP / Domain / URL / Hash (MD5 / SHA1 / SHA256)" value="{{ query|default('', true) }}">
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="submit" class="btn-primary">
          <i data-feather="search"></i> Run Lookup
        </button>
          <button type="button" class="btn-secondary" onclick="checkDomainDossier()" style="
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(168, 85, 247, 0.4);
            color: #C084FC;
          " onmouseover="this.style.borderColor='rgba(168, 85, 247, 0.6)'; this.style.background='linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(168, 85, 247, 0.15))';" onmouseout="this.style.borderColor='rgba(168, 85, 247, 0.4)'; this.style.background='linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1))';">
            <i data-feather="target"></i> Domain Dossier
          </button>
        </div>
      </form>

      <div class="metric-tiles">
        <div class="metric-card">
          <span class="label">Malicious Hits</span>
          <span class="value">{{ malicious|default(0, true) }}</span>
        </div>
        <div class="metric-card">
          <span class="label">Suspicious Signals</span>
          <span class="value">{{ suspicious|default(0, true) }}</span>
        </div>
        <div class="metric-card">
          <span class="label">Harmless Verdicts</span>
          <span class="value">{{ harmless|default(0, true) }}</span>
        </div>
        <div class="metric-card">
          <span class="label">News Signals</span>
          <span class="value">{{ news|length if news else 0 }}</span>
        </div>
      </div>

      <div class="lookup-actions">
        <button type="button" class="btn-secondary toggle-btn" onclick="toggleLogAnalyzer()">
          <i data-feather="file-text"></i> Open Advanced Log Analyzer
        </button>
      </div>
    </section>

    <section id="log-analyzer-section" class="neon-panel" style="display: {% if log_analysis_results %}block{% else %}none{% endif %};">
      <div class="section-title">
        <i data-feather="cpu"></i> SIEM Log Intelligence
      </div>
      <p class="section-subtitle">
        Drop raw SIEM entries to automatically extract entities, tag risk indicators, and pivot into enriched intelligence feeds.
      </p>
      
      <form method="post" action="/analyze_log" class="log-form">
        <textarea class="log-textarea" name="log_text" placeholder="Paste your SIEM log entry here (JSON, Syslog, Windows Event Log, key/value pairs, etc.)">{% if log_analysis_results and log_analysis_results.text %}{{ log_analysis_results.text }}{% endif %}</textarea>
        <div class="log-actions">
          <button type="submit" class="btn-primary">
            <i data-feather="play-circle"></i> Analyze Log
          </button>
        </div>
      </form>

      {% if log_analysis_results %}
        {% set risk_level = log_analysis_results.risk_level | default('low') %}
        
        {# Kill Chain / MITRE ATT&CK Tactics Bar #}
        {% if log_analysis_results.mitre_tactics and log_analysis_results.mitre_tactics|length > 0 %}
          <div class="kill-chain-bar" style="margin-bottom: 20px; padding: 12px; background: rgba(10, 18, 32, 0.96); border: 1px solid rgba(94, 234, 212, 0.2); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
              <span style="color: #5EEAD4; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">MITRE ATT&CK:</span>
              {% for tactic in log_analysis_results.mitre_tactics %}
                <span class="tactic-badge" style="
                  display: inline-block;
                  padding: 6px 12px;
                  background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(249, 115, 22, 0.1) 100%);
                  border: 1px solid rgba(249, 115, 22, 0.4);
                  border-radius: 6px;
                  color: #F97316;
                  font-size: 11px;
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  box-shadow: 0 0 8px rgba(249, 115, 22, 0.3), 0 2px 4px rgba(0, 0, 0, 0.3);
                  transition: all 0.2s ease;
                ">{{ tactic }}</span>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        {% set risk_icon = 'check-circle' if risk_level == 'low' else 'alert-circle' if risk_level == 'medium' else 'alert-triangle' %}
        
        <div class="risk-banner {{ risk_level }}">
          <div class="lookup-meta" style="gap:16px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <i data-feather="{{ risk_icon }}" style="width: 24px; height: 24px;"></i>
              <strong style="font-size: 18px; letter-spacing:1px;">Risk Level: {{ risk_level.upper() }}</strong>
            </div>
            {% if log_analysis_results.activity_summary %}
              <span style="color: rgba(148,163,184,0.8); font-size:14px;">{{ log_analysis_results.activity_summary }}</span>
            {% endif %}
          </div>
          
          {# Hypothetical Explanation #}
          {% if log_analysis_results.hypothetical_explanation %}
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <i data-feather="info" style="width: 18px; height: 18px; color: var(--accent-blue);"></i>
                <strong style="font-size: 14px; color: var(--text-primary);">Hypothetical Analysis:</strong>
              </div>
              <div style="
                color: var(--text-primary);
                font-size: 13px;
                line-height: 1.6;
                padding: 12px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 6px;
              ">
                {{ log_analysis_results.hypothetical_explanation|safe }}
              </div>
            </div>
          {% endif %}
          {% if log_analysis_results.risk_indicators %}
            <div class="risk-tags">
              {% for indicator in log_analysis_results.risk_indicators %}
                <span class="risk-tag">{{ indicator }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        {# Office 365 Alert Information #}
        {% if log_analysis_results.o365_alert %}
          {% set o365 = log_analysis_results.o365_alert %}
          <div style="
            margin-top: 20px;
            padding: 20px;
            background: rgba(10, 18, 32, 0.96);
            border: 1px solid rgba(94, 234, 212, 0.3);
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <i data-feather="shield" style="width: 24px; height: 24px; color: var(--accent-blue);"></i>
              <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                Office 365 Security & Compliance Alert
              </h3>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 16px;">
              {% if o365.operation_description %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Operation</strong>
                  <div style="color: var(--text-primary); font-size: 14px; font-weight: 600;">{{ o365.operation_description }}</div>
                </div>
              {% endif %}
              
              {% if o365.alert_name %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Alert Name</strong>
                  <div style="color: var(--text-primary); font-size: 14px; font-weight: 600;">{{ o365.alert_name }}</div>
                </div>
              {% endif %}
              
              {% if o365.user_email %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">User Email</strong>
                  <div style="color: var(--accent-blue); font-size: 14px; font-weight: 600;">{{ o365.user_email }}</div>
                </div>
              {% endif %}
              
              {% if o365.category %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Category</strong>
                  <div style="color: var(--text-primary); font-size: 14px;">{{ o365.category }}</div>
                </div>
              {% endif %}
              
              {% if o365.alert_type %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Alert Type</strong>
                  <div style="color: var(--text-primary); font-size: 14px;">{{ o365.alert_type }}</div>
                </div>
              {% endif %}
              
              {% if o365.status %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Status</strong>
                  <div style="color: var(--text-primary); font-size: 14px;">{{ o365.status }}</div>
                </div>
              {% endif %}
              
              {% if o365.creation_time %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Creation Time</strong>
                  <div style="color: var(--text-primary); font-size: 14px;">{{ o365.creation_time }}</div>
                </div>
              {% endif %}
              
              {% if o365.start_time %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">Start Time</strong>
                  <div style="color: var(--text-primary); font-size: 14px;">{{ o365.start_time }}</div>
                </div>
              {% endif %}
              
              {% if o365.end_time %}
                <div>
                  <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px;">End Time</strong>
                  <div style="color: var(--text-primary); font-size: 14px;">{{ o365.end_time }}</div>
                </div>
              {% endif %}
            </div>
            
            {% if o365.alert_description %}
              <div style="margin-top: 16px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                <strong style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Alert Description</strong>
                <div style="color: var(--text-primary); font-size: 13px; line-height: 1.6;">{{ o365.alert_description }}</div>
              </div>
            {% endif %}
            
            {% if o365.alert_id or o365.object_id or o365.policy_id %}
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                <strong style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Identifiers</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px; font-family: monospace;">
                  {% if o365.alert_id %}
                    <span style="color: var(--text-secondary);">Alert ID: <span style="color: var(--text-primary);">{{ o365.alert_id }}</span></span>
                  {% endif %}
                  {% if o365.object_id %}
                    <span style="color: var(--text-secondary);">Object ID: <span style="color: var(--text-primary);">{{ o365.object_id }}</span></span>
                  {% endif %}
                  {% if o365.policy_id %}
                    <span style="color: var(--text-secondary);">Policy ID: <span style="color: var(--text-primary);">{{ o365.policy_id }}</span></span>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {# Data Exfiltration Probability Model Banner #}
        {% if log_analysis_results.exfil_score is defined %}
          {% set exfil_level = log_analysis_results.exfil_level | default('low') %}
          {% set exfil_score = log_analysis_results.exfil_score | default(0) %}
          {% set exfil_confidence = log_analysis_results.exfil_confidence | default(0) %}
          {% set exfil_confidence_level = log_analysis_results.exfil_confidence_level | default('low') %}
          {% set exfil_icon = 'shield' if exfil_level == 'low' else 'shield-off' if exfil_level == 'medium' else 'alert-octagon' %}
          {% set exfil_color = 'var(--success-text)' if exfil_level == 'low' else 'var(--warning-text)' if exfil_level == 'medium' else 'var(--danger-text)' %}
          {% set confidence_color = 'var(--success-text)' if exfil_confidence_level == 'high' else 'var(--warning-text)' if exfil_confidence_level == 'medium' else 'var(--text-secondary)' %}
          
          <div class="risk-banner {{ exfil_level }}" style="margin-top: 15px; border-left: 4px solid {{ exfil_color }};">
            <div class="lookup-meta" style="gap:16px;">
              <div style="display:flex; align-items:center; gap:12px; flex-wrap: wrap;">
                <i data-feather="{{ exfil_icon }}" style="width: 24px; height: 24px;"></i>
                <strong style="font-size: 18px; letter-spacing:1px;">Data Exfiltration Probability: {{ exfil_score }}% ({{ exfil_level.upper() }})</strong>
                <div style="
                  background: {{ confidence_color }};
                  color: white;
                  padding: 4px 10px;
                  border-radius: 12px;
                  font-size: 12px;
                  font-weight: 600;
                  margin-left: 8px;
                ">Confidence: {{ exfil_confidence_level.upper() }} ({{ exfil_confidence|int }}%)</div>
              </div>
            </div>
            
            {# Component Scores Breakdown #}
            {% if log_analysis_results.exfil_component_scores %}
              {% set components = log_analysis_results.exfil_component_scores %}
              <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                <strong style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display: block;">Component Scores:</strong>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 11px;">
                  <div>
                    <span style="color: var(--text-secondary);">Base:</span>
                    <span style="color: var(--text-primary); font-weight: 600; margin-left: 4px;">{{ components.base }}</span>
                  </div>
                  <div>
                    <span style="color: var(--text-secondary);">Infrastructure:</span>
                    <span style="color: var(--accent-blue); font-weight: 600; margin-left: 4px;">{{ components.infrastructure }}</span>
                  </div>
                  <div>
                    <span style="color: var(--text-secondary);">Content:</span>
                    <span style="color: var(--warning-text); font-weight: 600; margin-left: 4px;">{{ components.content }}</span>
                  </div>
                  <div>
                    <span style="color: var(--text-secondary);">Behavior:</span>
                    <span style="color: var(--danger-text); font-weight: 600; margin-left: 4px;">{{ components.behavior }}</span>
                  </div>
                  <div>
                    <span style="color: var(--text-secondary);">Raw Total:</span>
                    <span style="color: var(--text-primary); font-weight: 600; margin-left: 4px;">{{ components.raw_total }}</span>
                  </div>
                </div>
              </div>
            {% endif %}
            
            {% if log_analysis_results.exfil_factors %}
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <strong style="font-size: 14px; color: var(--text-primary); margin-bottom: 12px; display: block;">
                  <i data-feather="info" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
                  Explainable Factors (Why this score?):
                </strong>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  {% for factor in log_analysis_results.exfil_factors %}
                    <div style="
                      background: rgba(239, 68, 68, 0.05);
                      border-left: 3px solid {{ exfil_color }};
                      padding: 10px 12px;
                      border-radius: 4px;
                      font-size: 13px;
                      color: var(--text-primary);
                      display: flex;
                      align-items: flex-start;
                      gap: 8px;
                    ">
                      <i data-feather="arrow-up-circle" style="width: 14px; height: 14px; margin-top: 2px; color: {{ exfil_color }}; flex-shrink: 0;"></i>
                      <span>{{ factor }}</span>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {# Threat Constellation Map #}
        {% if graph_data %}
        <div class="neon-panel threat-map-panel" style="margin-top: 20px; padding: 20px;">
          <div class="section-title" style="margin-bottom: 15px;">
            <i data-feather="git-branch"></i> Threat Constellation Map
          </div>
          <p class="section-subtitle" style="margin-bottom: 15px;">
            Interactive network visualization showing relationships between entities found in the analyzed log.
          </p>
          <div style="position: relative; width: 100%;">
            <div id="cy" style="width: 100%; height: 450px; background: 
              linear-gradient(135deg, rgba(2, 6, 16, 0.99) 0%, rgba(6, 10, 20, 0.99) 100%),
              repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(94, 234, 212, 0.015) 50px, rgba(94, 234, 212, 0.015) 51px),
              repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(94, 234, 212, 0.015) 50px, rgba(94, 234, 212, 0.015) 51px);
              border-radius: 6px; 
              border: 1px solid rgba(94, 234, 212, 0.2); 
              box-shadow: 
                inset 0 0 40px rgba(94, 234, 212, 0.06),
                inset 0 0 80px rgba(37, 99, 235, 0.03),
                0 0 30px rgba(0, 0, 0, 0.7),
                0 4px 20px rgba(0, 0, 0, 0.5);
              position: relative; 
              overflow: hidden;
            ">
              <!-- Stars background -->
              <div id="cy-stars" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 1;"></div>
              <!-- 3D depth effect overlay -->
              <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: 
                radial-gradient(ellipse at center, transparent 0%, rgba(94, 234, 212, 0.02) 50%, transparent 100%);
                pointer-events: none; z-index: 2;"></div>
              <!-- Subtle scanline overlay -->
              <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(0deg, transparent, transparent 4px, rgba(94, 234, 212, 0.01) 4px, rgba(94, 234, 212, 0.01) 5px); pointer-events: none; z-index: 3; mix-blend-mode: overlay;"></div>
              <!-- Corner tactical brackets - more subtle -->
              <div style="position: absolute; top: 0; left: 0; width: 25px; height: 25px; border-top: 1px solid rgba(94, 234, 212, 0.3); border-left: 1px solid rgba(94, 234, 212, 0.3); pointer-events: none; z-index: 4;"></div>
              <div style="position: absolute; top: 0; right: 0; width: 25px; height: 25px; border-top: 1px solid rgba(94, 234, 212, 0.3); border-right: 1px solid rgba(94, 234, 212, 0.3); pointer-events: none; z-index: 4;"></div>
              <div style="position: absolute; bottom: 0; left: 0; width: 25px; height: 25px; border-bottom: 1px solid rgba(94, 234, 212, 0.3); border-left: 1px solid rgba(94, 234, 212, 0.3); pointer-events: none; z-index: 4;"></div>
              <div style="position: absolute; bottom: 0; right: 0; width: 25px; height: 25px; border-bottom: 1px solid rgba(94, 234, 212, 0.3); border-right: 1px solid rgba(94, 234, 212, 0.3); pointer-events: none; z-index: 4;"></div>
            </div>
            {# Zoom Control Buttons - Completely separate from Cytoscape container #}
            <div id="cy-zoom-controls" style="
              position: absolute; 
              bottom: 15px; 
              right: 15px; 
              display: flex; 
              flex-direction: column; 
              gap: 8px; 
              z-index: 99999; 
              pointer-events: none;
            ">
              <button 
                id="cy-zoom-in" 
                type="button"
                onclick="if(window.cyZoomIn) { window.cyZoomIn(); return false; }"
                onmousedown="event.stopPropagation(); return false;"
                style="
                  width: 44px;
                  height: 44px;
                  min-width: 44px;
                  min-height: 44px;
                  padding: 0;
                  margin: 0;
                  background: rgba(3, 7, 18, 0.98);
                  border: 2px solid rgba(94, 234, 212, 0.4);
                  border-radius: 6px;
                  color: #5EEAD4;
                  font-size: 20px;
                  font-weight: 700;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(94, 234, 212, 0.15);
                  transition: all 0.2s ease;
                  font-family: 'Courier New', monospace;
                  line-height: 1;
                  pointer-events: auto;
                  user-select: none;
                  -webkit-user-select: none;
                  -moz-user-select: none;
                  -ms-user-select: none;
                  touch-action: manipulation;
                " 
                onmouseover="this.style.background='rgba(94, 234, 212, 0.15)'; this.style.borderColor='rgba(94, 234, 212, 0.7)'; this.style.transform='scale(1.05)';" 
                onmouseout="this.style.background='rgba(3, 7, 18, 0.98)'; this.style.borderColor='rgba(94, 234, 212, 0.4)'; this.style.transform='scale(1)';"
                onmouseup="this.style.transform='scale(1.05)';"
                onmousedown="this.style.transform='scale(0.95)';"
              >+</button>
              <button 
                id="cy-zoom-reset" 
                type="button"
                onclick="if(window.cyZoomReset) { window.cyZoomReset(); return false; }"
                onmousedown="event.stopPropagation(); return false;"
                style="
                  width: 44px;
                  height: 32px;
                  min-width: 44px;
                  min-height: 32px;
                  padding: 0;
                  margin: 0;
                  background: rgba(3, 7, 18, 0.98);
                  border: 2px solid rgba(94, 234, 212, 0.4);
                  border-radius: 6px;
                  color: #5EEAD4;
                  font-size: 14px;
                  font-weight: 700;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(94, 234, 212, 0.15);
                  transition: all 0.2s ease;
                  font-family: 'Courier New', monospace;
                  line-height: 1;
                  pointer-events: auto;
                  user-select: none;
                  -webkit-user-select: none;
                  -moz-user-select: none;
                  -ms-user-select: none;
                  touch-action: manipulation;
                " 
                onmouseover="this.style.background='rgba(94, 234, 212, 0.15)'; this.style.borderColor='rgba(94, 234, 212, 0.7)'; this.style.transform='scale(1.05)';" 
                onmouseout="this.style.background='rgba(3, 7, 18, 0.98)'; this.style.borderColor='rgba(94, 234, 212, 0.4)'; this.style.transform='scale(1)';"
                onmouseup="this.style.transform='scale(1.05)';"
                onmousedown="this.style.transform='scale(0.95)';"
              >⌂</button>
              <button 
                id="cy-zoom-out" 
                type="button"
                onclick="if(window.cyZoomOut) { window.cyZoomOut(); return false; }"
                onmousedown="event.stopPropagation(); return false;"
                style="
                  width: 44px;
                  height: 44px;
                  min-width: 44px;
                  min-height: 44px;
                  padding: 0;
                  margin: 0;
                  background: rgba(3, 7, 18, 0.98);
                  border: 2px solid rgba(94, 234, 212, 0.4);
                  border-radius: 6px;
                  color: #5EEAD4;
                  font-size: 20px;
                  font-weight: 700;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(94, 234, 212, 0.15);
                  transition: all 0.2s ease;
                  font-family: 'Courier New', monospace;
                  line-height: 1;
                  pointer-events: auto;
                  user-select: none;
                  -webkit-user-select: none;
                  -moz-user-select: none;
                  -ms-user-select: none;
                  touch-action: manipulation;
                " 
                onmouseover="this.style.background='rgba(94, 234, 212, 0.15)'; this.style.borderColor='rgba(94, 234, 212, 0.7)'; this.style.transform='scale(1.05)';" 
                onmouseout="this.style.background='rgba(3, 7, 18, 0.98)'; this.style.borderColor='rgba(94, 234, 212, 0.4)'; this.style.transform='scale(1)';"
                onmouseup="this.style.transform='scale(1.05)';"
                onmousedown="this.style.transform='scale(0.95)';"
              >−</button>
            </div>
            
            {# Intel Card HUD - Hidden by default, shown on node click #}
            <div id="intel-card" style="display: none; position: absolute; top: 15px; right: 15px; width: 320px; background: rgba(10, 18, 32, 0.96); border: 1px solid rgba(94, 234, 212, 0.3); border-radius: 8px; padding: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 20px rgba(94, 234, 212, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.05); z-index: 1000; font-family: 'Courier New', monospace;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(94, 234, 212, 0.2);">
                <h4 style="margin: 0; color: #5EEAD4; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">INTEL</h4>
                <button id="intel-card-close" style="background: transparent; border: none; color: #5EEAD4; cursor: pointer; font-size: 18px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(94, 234, 212, 0.1)'" onmouseout="this.style.background='transparent'">×</button>
              </div>
              <div id="intel-card-content" style="color: #E2E8F0; font-size: 12px; line-height: 1.6;">
                <!-- Content populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {# Activity Summary Cards #}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
          
          {# Network Flow Animation #}
          {% if log_analysis_results.src_ip or log_analysis_results.dst_ip %}
            <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.1s both;">
              <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <i data-feather="activity"></i> Network Flow
              </h4>
              <div class="animation-container" style="margin: 15px 0;">
                <div class="computer-icon">
                  <i data-feather="server" style="width: 24px; height: 24px;"></i>
                  <strong style="font-size: 12px;">Source</strong>
                  <span class="ip-label" style="font-size: 11px;">{{ log_analysis_results.src_ip | default('Unknown', true) }}</span>
                </div>
                <div class="animation-line">
                  <div class="animation-dot"></div>
                </div>
                <div class="computer-icon">
                  <i data-feather="database" style="width: 24px; height: 24px;"></i>
                  <strong style="font-size: 12px;">Destination</strong>
                  <span class="ip-label" style="font-size: 11px;">{{ log_analysis_results.dst_ip | default('Unknown', true) }}</span>
                </div>
              </div>
              {% if log_analysis_results.protocol or log_analysis_results.dst_port %}
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 15px; font-size: 13px;">
                  {% if log_analysis_results.protocol %}
                    <span><strong>Protocol:</strong> {{ log_analysis_results.protocol }}</span>
                  {% endif %}
                  {% if log_analysis_results.dst_port %}
                    <span><strong>Port:</strong> {{ log_analysis_results.dst_port }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endif %}

          {# Event Information #}
          {% if log_analysis_results.event_type or log_analysis_results.timestamp %}
            <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.2s both;">
              <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <i data-feather="clock"></i> Event Details
              </h4>
              <table class="detections-table">
                {% if log_analysis_results.timestamp %}
                  <tr><th>Timestamp</th><td style="font-family: monospace; font-size: 13px;">{{ log_analysis_results.timestamp }}</td></tr>
                {% endif %}
                {% if log_analysis_results.event_type %}
                  <tr><th>Event Type</th><td>{{ log_analysis_results.event_type }}</td></tr>
                {% endif %}
                {% if log_analysis_results.action %}
                  <tr><th>Action</th><td>{{ log_analysis_results.action }}</td></tr>
                {% endif %}
                {% if log_analysis_results.log_format %}
                  <tr><th>Log Format</th><td>{{ log_analysis_results.log_format }}</td></tr>
                {% endif %}
              </table>
            </div>
          {% endif %}

          {# User Information #}
          {% set user_info = log_analysis_results.user_information if log_analysis_results.user_information is defined else None %}
          {% set all_usernames = [] %}
          {% if log_analysis_results.identifiers and log_analysis_results.identifiers.usernames %}
            {% for uname in log_analysis_results.identifiers.usernames %}
              {% if uname and uname not in all_usernames %}
                {% set _ = all_usernames.append(uname) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if log_analysis_results.username and log_analysis_results.username not in all_usernames %}
            {% set _ = all_usernames.append(log_analysis_results.username) %}
          {% endif %}
          {% if user_info and user_info.username and user_info.username not in all_usernames %}
            {% set _ = all_usernames.append(user_info.username) %}
          {% endif %}
          
          {% if all_usernames|length > 0 or log_analysis_results.user_agent or (user_info and user_info.email) %}
            <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.3s both;">
              <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <i data-feather="user"></i> User Information
              </h4>
              
              {% if all_usernames|length > 0 %}
                <div style="margin-bottom: 12px;">
                  <strong style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; display: block;">Users ({{ all_usernames|length }}):</strong>
                  <div style="
                    display: flex;
                    overflow-x: auto;
                    gap: 10px;
                    padding: 8px 0;
                    scrollbar-width: thin;
                    scrollbar-color: var(--border-color) transparent;
                  " onmouseover="this.style.scrollbarColor='var(--accent-blue) transparent'" onmouseout="this.style.scrollbarColor='var(--border-color) transparent'">
                    {% for username in all_usernames %}
                      <div style="
                        background: var(--bg-light);
                        border: 1px solid var(--border-color);
                        border-radius: 6px;
                        padding: 10px 14px;
                        min-width: fit-content;
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                        flex-shrink: 0;
                      ">
                        <div style="display: flex; align-items: center; gap: 6px;">
                          <i data-feather="user" style="width: 14px; height: 14px; color: var(--accent-blue);"></i>
                          <span style="
                            font-family: monospace;
                            font-size: 13px;
                            font-weight: 600;
                            color: var(--text-primary);
                          ">{{ username }}</span>
                        </div>
                        {% if user_info and user_info.username == username and user_info.email %}
                          <div style="
                            font-size: 11px;
                            color: var(--text-secondary);
                            font-family: monospace;
                            margin-left: 20px;
                          ">{{ user_info.email }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                  <style>
                    div[style*="overflow-x: auto"]::-webkit-scrollbar {
                      height: 6px;
                    }
                    div[style*="overflow-x: auto"]::-webkit-scrollbar-track {
                      background: transparent;
                    }
                    div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb {
                      background: var(--border-color);
                      border-radius: 3px;
                    }
                    div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb:hover {
                      background: var(--accent-blue);
                    }
                  </style>
                </div>
              {% endif %}
              
              <table class="detections-table">
                {% if user_info and user_info.email %}
                  {% set email_shown = false %}
                  {% for username in all_usernames %}
                    {% if user_info.username == username %}
                      {% set email_shown = true %}
                    {% endif %}
                  {% endfor %}
                  {% if not email_shown %}
                    <tr><th>Mobileye Email</th><td style="font-family: monospace;">{{ user_info.email }}</td></tr>
                  {% endif %}
                {% endif %}
                {% if log_analysis_results.user_agent %}
                  <tr><th>User Agent</th><td style="font-size: 12px; word-break: break-all;">{{ log_analysis_results.user_agent[:80] }}{% if log_analysis_results.user_agent|length > 80 %}...{% endif %}</td></tr>
                {% endif %}
              </table>
            </div>
          {% endif %}

          {# HTTP Information #}
          {% if log_analysis_results.http_method or log_analysis_results.http_status or log_analysis_results.url %}
            <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.4s both;">
              <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <i data-feather="globe"></i> HTTP Request
              </h4>
              <table class="detections-table">
                {% if log_analysis_results.http_method %}
                  <tr><th>Method</th><td>{{ log_analysis_results.http_method }}</td></tr>
                {% endif %}
                {% if log_analysis_results.http_status %}
                  <tr>
                    <th>Status</th>
                    <td style="color: {% if log_analysis_results.http_status.startswith('2') %}var(--success-text){% elif log_analysis_results.http_status.startswith('4') or log_analysis_results.http_status.startswith('5') %}var(--danger-text){% else %}var(--text-primary){% endif %};">
                      {{ log_analysis_results.http_status }}
                    </td>
                  </tr>
                {% endif %}
                {% if log_analysis_results.url %}
                  <tr><th>URL</th><td style="font-size: 12px; word-break: break-all;">{{ log_analysis_results.url[:60] }}{% if log_analysis_results.url|length > 60 %}...{% endif %}</td></tr>
                {% endif %}
              </table>
            </div>
          {% endif %}

          {# File/Process Information #}
          {% if log_analysis_results.file_path or log_analysis_results.process_name %}
            <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.5s both;">
              <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <i data-feather="file"></i> File/Process
              </h4>
              <table class="detections-table">
                {% if log_analysis_results.file_path %}
                  <tr><th>File Path</th><td style="font-family: monospace; font-size: 12px; word-break: break-all;">{{ log_analysis_results.file_path }}</td></tr>
                {% endif %}
                {% if log_analysis_results.process_name %}
                  <tr><th>Process</th><td style="font-family: monospace;">{{ log_analysis_results.process_name }}</td></tr>
                {% endif %}
              </table>
            </div>
          {% endif %}

        </div>

        {# IP Addresses List with VT Results #}
        {% if log_analysis_results.ips %}
          <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.6s both; margin-bottom: 20px;">
            <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
              <i data-feather="map-pin"></i> IP Addresses ({{ log_analysis_results.ips|length }})
            </h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              {% for ip_info in log_analysis_results.ips %}
                {% set ip = ip_info.ip %}
                {% set vt_result = log_analysis_results.vt_results.ips.get(ip) if log_analysis_results.vt_results else None %}
                <div style="
                  background: var(--bg-light);
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  padding: 12px;
                ">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="
                      background: {% if ip_info.type == 'Source' %}rgba(59, 130, 246, 0.2){% elif ip_info.type == 'Destination' %}rgba(239, 68, 68, 0.2){% else %}rgba(148, 163, 184, 0.2){% endif %};
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-size: 10px;
                      font-weight: 600;
                    ">{{ ip_info.type }}</span>
                    <span style="font-family: monospace; font-size: 14px; font-weight: 600; color: var(--text-primary);">{{ ip }}</span>
                    <button onclick="searchIndicator('{{ ip }}')" style="
                      background: transparent;
                      border: 1px solid var(--border-color);
                      color: var(--accent-blue);
                      padding: 4px 8px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 11px;
                      margin-left: auto;
                    ">Search</button>
                  </div>
                  {% if vt_result and vt_result.error is not defined %}
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px;">
                      {% if vt_result.malicious > 0 %}
                        <span style="color: var(--danger-text); font-weight: 600;">
                          <i data-feather="alert-triangle" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                          {{ vt_result.malicious }} Malicious
                        </span>
                      {% endif %}
                      {% if vt_result.suspicious > 0 %}
                        <span style="color: var(--warning-text); font-weight: 600;">
                          <i data-feather="alert-circle" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                          {{ vt_result.suspicious }} Suspicious
                        </span>
                      {% endif %}
                      {% if vt_result.harmless > 0 %}
                        <span style="color: var(--success-text);">
                          {{ vt_result.harmless }} Harmless
                        </span>
                      {% endif %}
                      {% if vt_result.malicious == 0 and vt_result.suspicious == 0 %}
                        <span style="color: var(--text-secondary);">No threats detected</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {# URLs and Domains #}
        {% if log_analysis_results.urls or log_analysis_results.domains %}
          <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.7s both; margin-bottom: 20px;">
            <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
              <i data-feather="link"></i> URLs & Domains
            </h4>
            {% if log_analysis_results.urls %}
              <div style="margin-bottom: 12px;">
                <strong style="font-size: 13px; color: var(--text-secondary);">URLs:</strong>
                <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                  {% for url in log_analysis_results.urls[:5] %}
                    <span style="
                      color: var(--accent-blue);
                      font-size: 12px;
                      word-break: break-all;
                      padding: 4px 8px;
                      background: rgba(59, 130, 246, 0.1);
                      border-radius: 4px;
                      display: inline-block;
                      cursor: not-allowed;
                      user-select: text;
                    " title="Suspicious URL - Clicking disabled for security">{{ url[:50] }}{% if url|length > 50 %}...{% endif %}</span>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if log_analysis_results.domains %}
              <div>
                <strong style="font-size: 13px; color: var(--text-secondary);">Domains:</strong>
                <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
                  {% for domain in log_analysis_results.domains[:10] %}
                    {% set vt_result = log_analysis_results.vt_results.domains.get(domain) if log_analysis_results.vt_results else None %}
                    <div style="
                      background: var(--bg-light);
                      border: 1px solid var(--border-color);
                      border-radius: 6px;
                      padding: 10px;
                    ">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <span style="font-family: monospace; font-size: 13px; font-weight: 600; color: var(--text-primary);">{{ domain }}</span>
                        <button onclick="searchIndicator('{{ domain }}')" style="
                          background: transparent;
                          border: 1px solid var(--border-color);
                          color: var(--accent-blue);
                          padding: 4px 8px;
                          border-radius: 4px;
                          cursor: pointer;
                          font-size: 11px;
                        ">Search</button>
                        <button onclick="openDossier('{{ domain }}')" style="
                          background: transparent;
                          border: 1px solid var(--border-color);
                          color: #A855F7;
                          padding: 4px 8px;
                          border-radius: 4px;
                          cursor: pointer;
                          font-size: 11px;
                          display: flex;
                          align-items: center;
                          gap: 4px;
                          margin-left: auto;
                        " title="View Intelligence Dossier">
                          <i data-feather="target" style="width: 12px; height: 12px;"></i>
                          Dossier
                        </button>
                      </div>
                      {% if vt_result and vt_result.error is not defined %}
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px;">
                          {% if vt_result.malicious > 0 %}
                            <span style="color: var(--danger-text); font-weight: 600;">
                              <i data-feather="alert-triangle" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                              {{ vt_result.malicious }} Malicious
                            </span>
                          {% endif %}
                          {% if vt_result.suspicious > 0 %}
                            <span style="color: var(--warning-text); font-weight: 600;">
                              <i data-feather="alert-circle" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                              {{ vt_result.suspicious }} Suspicious
                            </span>
                          {% endif %}
                          {% if vt_result.harmless > 0 %}
                            <span style="color: var(--success-text);">
                              {{ vt_result.harmless }} Harmless
                            </span>
                          {% endif %}
                          {% if vt_result.malicious == 0 and vt_result.suspicious == 0 %}
                            <span style="color: var(--text-secondary);">No threats detected</span>
                          {% endif %}
                        </div>
                      {% elif vt_result and vt_result.error %}
                        <div style="color: var(--text-secondary); font-size: 11px;">VT Error: {{ vt_result.error[:50] }}</div>
                      {% else %}
                        <div style="color: var(--text-secondary); font-size: 11px;">No VT data available</div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {# Hashes with VT Results #}
        {% if log_analysis_results.hashes %}
          <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.8s both; margin-bottom: 20px;">
            <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
              <i data-feather="hash"></i> Hashes ({{ log_analysis_results.hashes|length }})
            </h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              {% for hash_info in log_analysis_results.hashes %}
                {% set hash_val = hash_info.hash %}
                {% set vt_result = log_analysis_results.vt_results.hashes.get(hash_val) if log_analysis_results.vt_results else None %}
                <div style="
                  background: var(--bg-light);
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  padding: 12px;
                ">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="
                      background: var(--accent-blue);
                      color: white;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 11px;
                      font-weight: 600;
                      text-transform: uppercase;
                    ">{{ hash_info.type }}</span>
                    <button onclick="searchIndicator('{{ hash_val }}')" style="
                      background: transparent;
                      border: 1px solid var(--border-color);
                      color: var(--accent-blue);
                      padding: 4px 8px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 11px;
                      margin-left: auto;
                    ">Search</button>
                  </div>
                  <div style="font-family: monospace; font-size: 12px; color: var(--text-primary); word-break: break-all; margin-bottom: 8px;">
                    {{ hash_val }}
                  </div>
                  {% if vt_result and vt_result.error is not defined %}
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px;">
                      {% if vt_result.malicious > 0 %}
                        <span style="color: var(--danger-text); font-weight: 600;">
                          <i data-feather="alert-triangle" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                          {{ vt_result.malicious }} Malicious
                        </span>
                      {% endif %}
                      {% if vt_result.suspicious > 0 %}
                        <span style="color: var(--warning-text); font-weight: 600;">
                          <i data-feather="alert-circle" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                          {{ vt_result.suspicious }} Suspicious
                        </span>
                      {% endif %}
                      {% if vt_result.harmless > 0 %}
                        <span style="color: var(--success-text);">
                          {{ vt_result.harmless }} Harmless
                        </span>
                      {% endif %}
                      {% if vt_result.malicious == 0 and vt_result.suspicious == 0 %}
                        <span style="color: var(--text-secondary);">No threats detected</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
          </div>
        </div>
        {% endif %}


        {# Files #}
        {% if log_analysis_results.files %}
          <div class="log-card" style="animation: fadeInUp 0.6s ease-out 0.9s both; margin-bottom: 20px;">
            <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 8px;">
              <i data-feather="file"></i> Files Detected ({{ log_analysis_results.files|length }})
            </h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              {% for file_info in log_analysis_results.files %}
                {% set file_type = file_info.type | default('other') %}
                {% set type_colors = {
                  'executable': 'var(--danger-text)',
                  'script': 'var(--warning-text)',
                  'document': 'var(--accent-blue)',
                  'archive': 'var(--text-secondary)',
                  'image': 'var(--success-text)',
                  'video': 'var(--text-secondary)',
                  'audio': 'var(--text-secondary)',
                  'database': 'var(--warning-text)',
                  'config': 'var(--accent-blue)',
                  'log': 'var(--text-secondary)',
                  'other': 'var(--text-secondary)'
                } %}
                {% set type_color = type_colors.get(file_type, 'var(--text-secondary)') %}
                <div style="
                  background: var(--bg-light);
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  padding: 12px;
                  display: flex;
                  align-items: flex-start;
                  justify-content: space-between;
                  gap: 12px;
                ">
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                      <span style="
                        background: {{ type_color }};
                        color: white;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: capitalize;
                      ">{{ file_type }}</span>
                      {% if file_info.location %}
                        <span style="
                          background: rgba(148, 163, 184, 0.2);
                          color: var(--text-secondary);
                          padding: 2px 6px;
                          border-radius: 4px;
                          font-size: 10px;
                          text-transform: capitalize;
                        ">{{ file_info.location.replace('_', ' ') }}</span>
                      {% endif %}
                    </div>
                    <div style="
                      font-family: monospace;
                      font-size: 13px;
                      color: var(--text-primary);
                      word-break: break-all;
                      margin-bottom: 4px;
                    ">{{ file_info.name }}</div>
                    {% if file_info.path != file_info.name %}
                      <div style="
                        font-size: 11px;
                        color: var(--text-secondary);
                        word-break: break-all;
                        font-family: monospace;
                      ">{{ file_info.path[:80] }}{% if file_info.path|length > 80 %}...{% endif %}</div>
                    {% endif %}
                  </div>
                  <button onclick="searchIndicator('{{ file_info.name }}')" style="
                    background: transparent;
                    border: 1px solid var(--border-color);
                    color: var(--accent-blue);
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.2s ease;
                    flex-shrink: 0;
                  " onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.background='rgba(59, 130, 246, 0.1)'" 
                     onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='transparent'">
                    <i data-feather="search" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                  </button>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

      {% endif %}
    </section>
    {% if news or result %}
    <section class="surface-grid">
      {% if news %}
      <div class="neon-panel news-card">
        <div class="panel-header">
          <h3><i data-feather="rss"></i> Latest Cyber News</h3>
          <button type="button" class="news-toggle" id="news-toggle" data-state="open" onclick="toggleNews()">
            <span class="icon" data-feather="chevron-up"></span>
            <span class="label">Hide</span>
          </button>
        </div>
        <div class="news-body" id="news-body">
          <ul class="news-list">
            {% for item in news %}
              <li class="news-item">
                <a href="{{ item.link }}" target="_blank" rel="noopener noreferrer">
                  <i data-feather="external-link" style="width:14px;height:14px;"></i>
                  {{ item.title }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      
      {# VirusTotal Comments Section #}
      {% if vt_comments and vt_comments.data %}
      <div class="neon-panel news-card">
        <div class="panel-header">
          <h3><i data-feather="message-circle"></i> Latest VirusTotal Comments</h3>
        </div>
        <div class="news-body">
          <ul class="news-list">
            {% for comment in vt_comments.data[:10] %}
              <li class="news-item" style="padding: 12px; margin-bottom: 8px; background: rgba(10, 18, 32, 0.5); border-left: 3px solid var(--accent-teal); border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 8px; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                      <i data-feather="clock" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                      {% if comment.attributes.date %}
                        {% set ts = comment.attributes.date | int %}
                        {{ ts | timestamp_to_date }}
                      {% else %}
                        Unknown date
                      {% endif %}
                    </div>
                    <div style="color: var(--text-primary); font-size: 13px; line-height: 1.5; word-wrap: break-word; margin-bottom: 8px;">
                      {{ comment.attributes.text or comment.attributes.html or 'No text' }}
                    </div>
                    {% if comment.attributes.tags %}
                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
                      {% for tag in comment.attributes.tags %}
                        {% if not tag.startswith('_:') %}
                        <span style="padding: 3px 8px; background: rgba(20, 184, 166, 0.2); border: 1px solid rgba(20, 184, 166, 0.4); border-radius: 12px; font-size: 10px; color: var(--accent-teal);">
                          #{{ tag }}
                        </span>
                        {% endif %}
                      {% endfor %}
                    </div>
                    {% endif %}
                    {% if comment.attributes.votes %}
                    <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
                      {% if comment.attributes.votes.positive > 0 %}
                      <span><i data-feather="thumbs-up" style="width: 11px; height: 11px; vertical-align: middle; color: #22C55E;"></i> +{{ comment.attributes.votes.positive }}</span>
                      {% endif %}
                      {% if comment.attributes.votes.negative > 0 %}
                      <span><i data-feather="thumbs-down" style="width: 11px; height: 11px; vertical-align: middle; color: #EF4444;"></i> -{{ comment.attributes.votes.negative }}</span>
                      {% endif %}
                      {% if comment.attributes.votes.abuse > 0 %}
                      <span><i data-feather="flag" style="width: 11px; height: 11px; vertical-align: middle; color: #F59E0B;"></i> {{ comment.attributes.votes.abuse }} abuse</span>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                  {% if comment.links and comment.links.self %}
                  <a href="{{ comment.links.self }}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; flex-shrink: 0;">
                    <i data-feather="external-link" style="width: 14px; height: 14px;"></i>
                  </a>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
          {% if vt_comments.links and vt_comments.links.next %}
          <div style="margin-top: 12px; text-align: center;">
            <a href="{{ vt_comments.links.next }}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; font-size: 12px;">
              View More Comments <i data-feather="arrow-right" style="width: 12px; height: 12px; vertical-align: middle;"></i>
            </a>
          </div>
          {% endif %}
        </div>
      </div>
      {% elif comments_error %}
      <div class="neon-panel result-banner">
        <div class="section-title"><i data-feather="alert-circle"></i> VirusTotal Comments</div>
        <p class="result-card" style="color: var(--text-secondary);">Unable to load comments: {{ comments_error }}</p>
      </div>
      {% endif %}
      
      {% if result %}
        <div class="neon-panel result-banner">
          <div class="section-title"><i data-feather="info"></i> Notice</div>
          <p class="result-card">{{ result }}</p>
        </div>
      {% endif %}
    </section>
    {% endif %}

    {% if vt or ipdb %}
      <section class="neon-panel analytics-suite">
        <div class="section-title">
          <i data-feather="shield"></i> Threat Intelligence Stack
        </div>
        <div class="cards-container">
        {% if ipdb %} 
<div class="card ipdb-card">
          <h3>IPDB Summary</h3>
          <table class="detections-table">
            <tr><th>Abuse Score</th><td>{{ ipdb.abuseScore }}</td></tr>
            <tr><th>Total Reports</th><td>{{ ipdb.totalReports }}</td></tr>
            <tr>
              <th>Country</th>
              <td>
                {% if ipdb.flag_url %}
                  <img src="{{ ipdb.flag_url }}" alt="{{ ipdb.country }} flag" style="width: 20px; height: auto; vertical-align: middle; margin-right: 8px;">
                {% endif %}
                {{ ipdb.country }}
              </td>
            </tr>
            <tr><th>ISP</th><td>{{ ipdb.isp }}</td></tr>
            <tr><th>Domain</th><td>{{ ipdb.domain }}</td></tr>
          </table>
          {% if ipdb.error %}
            <div class="err">IPDB Error: {{ ipdb.error }}</div>
          {% endif %}

          {% if ipdb.reports %}
            <button class="btn-secondary toggle-btn" onclick="toggleIpdbReports()">
              Show/Hide {{ ipdb.reports|length }} Recent Reports
            </button>
            <div id="ipdb-reports" style="display: none;">
              <table class="detections-table">
                <thead>
                  <tr>
                    <th class="col-ipdb-date">Reported</th>
                    <th class="col-ipdb-cat">Categories</th>
                    <th class="col-ipdb-comment">Comment</th>
                  </tr>
                </thead>
                <tbody>
                  {% for report in ipdb.reports %}
                  <tr>
                    <td class="col-ipdb-date">{{ report.reportedAt }}</td>
                    <td class="col-ipdb-cat">{{ report.categories | join(', ') }}</td>
                    <td class="col-ipdb-comment">{{ report.comment }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
          </div>
        {% endif %}

        {% if vt %}
          <div class="card vt-card">
            <h3>VIRUSTOTAL Summary</h3>
            
            <div class="score-chart-container">
                <canvas id="vtScoreChart"></canvas>
                <div class="score-text">
                    {% set total_bad = (malicious|default(0) + suspicious|default(0)) %}
                    {% set total_all = (malicious|default(0) + suspicious|default(0) + harmless|default(0) + undetected|default(0) + timeout|default(0)) %}
                    <span class="score-numerator" style="color: {% if total_bad > 0 %}var(--danger-text){% else %}var(--success-text){% endif %};">
                        {{ total_bad }}
                    </span>
                    <span class="score-denominator">/ {{ total_all }}</span>
                </div>
            </div>

            <table class="detections-table">
              <tr><th>Name</th><td>{{ vt.name }}</td></tr>
              <tr><th>Malicious</th><td>{{ vt.malicious }}</td></tr>
              <tr><th>Suspicious</th><td>{{ vt.suspicious }}</td></tr>
              <tr>
                <th>Community Score</th>
                {% set score_color = '' %}
                {% if vt.community_score > 0 %}
                    {% set score_color = 'color: var(--success-text) !important;' %} {# Green #}
                {% elif vt.community_score < 0 %}
                    {% set score_color = 'color: var(--danger-text) !important;' %} {# Red #}
                {% endif %}
                <td style="{{ score_color }}">{{ vt.community_score }}</td>
              </tr>
            </table>
            {% if vt.error %}
              <div class="err">VT Error: {{ vt.error }}</div>
            {% endif %}
            
            {% if vt.kind in ('file', 'ip_address', 'domain') and vt.detections %}
              <button class="btn-secondary toggle-btn" onclick="toggleDetections()">
                Show/Hide {{ vt.detections|length }} Engine Results
              </button>
              <div id="vt-detections" style="display: none;">
                <table class="detections-table">
                  <thead>
                    <tr>
                      <th class="col-engine">Engine</th>
                      <th class="col-category">Category</th>
                      <th class="col-detection">Detection</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for det in vt.detections %}
                      {% set color_style = '' %}
                      {% if det.result|lower == 'clean' or det.category == 'harmless' %}
                          {% set color_style = 'color: var(--success-text) !important;' %} {# Green #}
                      {% elif det.category == 'undetected' or det.category == 'type-unsupported' %}
                          {% set color_style = 'color: var(--text-secondary) !important;' %} {# Gray #}
                      {% else %}
                          {% set color_style = 'color: var(--danger-text) !important;' %} {# Red for all others #}
                      {% endif %}
                    <tr>
                      <th class="col-engine">{{ det.engine }}</th>
                      <td class="col-category" style="{{ color_style }}">{{ det.category }}</td>
                      <td class="col-detection" style="{{ color_style }}">{{ det.result|default('clean', true) }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
            </div>
        {% endif %}
        
        {% set critical_total = malicious|default(0, true) + suspicious|default(0, true) %}
        {% set risk_total = malicious|default(0, true) + suspicious|default(0, true) + harmless|default(0, true) + undetected|default(0, true) + timeout|default(0, true) %}
        {% set risk_segments = [
          {'label': 'Malicious', 'value': malicious|default(0, true), 'color': '#5eead4'},
          {'label': 'Suspicious', 'value': suspicious|default(0, true), 'color': '#38bdf8'},
          {'label': 'Harmless', 'value': harmless|default(0, true), 'color': '#2ad397'},
          {'label': 'Undetected', 'value': undetected|default(0, true), 'color': '#4b5f80'},
          {'label': 'Timeout', 'value': timeout|default(0, true), 'color': '#24324d'}
        ] %}
        <div class="card chart-card">
            <div class="chart-card-header">
              <h3>Scan Analysis</h3>
              <span class="critical-badge">
                Critical: {{ critical_total }} {{ 'event' if critical_total == 1 else 'events' }}
              </span>
            </div>
            {% if risk_total > 0 %}
            {% set radius = 78 %}
            {% set circumference = 2 * 3.14159265 * radius %}
            {% set arc = namespace(offset=0.0) %}
            <div class="risk-distribution">
              <div class="risk-ring">
                <svg class="risk-ring-visual" viewBox="0 0 220 220" role="presentation">
                  <circle class="risk-track" cx="110" cy="110" r="{{ radius }}" />
                  {% for segment in risk_segments if segment.value > 0 %}
                    {% set percent = (segment.value / risk_total) * 100 %}
                    {% set dash = circumference * percent / 100 %}
                    <circle
                      class="risk-segment"
                      cx="110"
                      cy="110"
                      r="{{ radius }}"
                      style="--segment-color: {{ segment.color }}; stroke-dasharray: {{ dash|round(2) }} {{ (circumference - dash)|round(2) }}; stroke-dashoffset: {{ -arc.offset|round(2) }};"
                    />
                    {% set arc.offset = arc.offset + dash %}
                  {% endfor %}
                </svg>
                <div class="risk-center">
                  <span class="risk-center-label">Total Events</span>
                  <span class="risk-center-value">{{ risk_total }}</span>
                  <span class="risk-center-caption">Scanned distribution</span>
                </div>
              </div>
              <div class="risk-breakdown">
                {% for segment in risk_segments %}
                  {% set value = segment.value %}
                  {% set percent = risk_total and (value / risk_total * 100) or 0 %}
                  {% set percent_display = percent|round(1) %}
                  <div class="risk-item">
                    <span class="risk-dot" style="--dot-color: {{ segment.color }};"></span>
                    <div class="risk-item-info">
                      <div class="risk-item-header">
                        <span class="risk-item-label">{{ segment.label }}</span>
                        <span class="risk-item-count">{{ value }}</span>
                      </div>
                      <div class="risk-item-meta">
                        <span class="risk-item-percent">{{ percent_display }}%</span>
                        <div class="risk-item-bar">
                          <div class="risk-item-bar-fill" style="--bar-percent: {{ percent|round(2) }}%; --bar-color: {{ segment.color }};"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% else %}
            <div class="risk-empty">
              No scan data available yet. Run a lookup to populate this view.
            </div>
            {% endif %}
        </div>
        </div>

      <script>
        (function(){
          if (typeof Chart === 'undefined') {
            return;
          }

          const totalBad = {{ malicious|default(0, true) + suspicious|default(0, true) }};
          const totalAll = {{ malicious|default(0, true) + suspicious|default(0, true) + harmless|default(0, true) + undetected|default(0, true) + timeout|default(0, true) }};
          const totalGood = Math.max(totalAll - totalBad, 0);

          const scoreCanvas = document.getElementById('vtScoreChart');
          if (!scoreCanvas) {
            return;
          }

          const scoreCtx = scoreCanvas.getContext('2d');
          new Chart(scoreCtx, {
            type: 'doughnut',
            data: {
              labels: ['Detections', 'Scanned'],
              datasets: [{
                data: [totalBad, totalAll > 0 ? totalGood : 1],
                backgroundColor: [
                  totalBad > 0 ? 'var(--danger-text)' : 'var(--success-text)',
                  'rgba(51, 65, 85, 0.5)'
                ],
                borderColor: 'transparent',
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '80%',
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              },
              animation: {
                animateScale: true
              }
            }
          });
        })();
      </script>
    </section>
    {% endif %}
  </main>

  {# Recent Investigations Sidebar with Slide Animation #}
  <div id="recent-history-container" style="
    position: fixed;
    top: 120px;
    right: 0;
    z-index: 100;
    display: flex;
    align-items: flex-start;
    flex-direction: row-reverse;
    pointer-events: none; /* Don't block clicks on elements behind */
  ">
    {# Arrow Button - Always Visible on Right Side (Beautiful Cyber Design) #}
    <div id="recent-history-arrow" style="
      width: 36px;
      height: 48px;
      background: linear-gradient(135deg, rgba(10, 18, 32, 0.98) 0%, rgba(6, 11, 22, 0.98) 100%);
      border: 1px solid rgba(94, 234, 212, 0.3);
      border-right: none;
      border-left: 2px solid rgba(94, 234, 212, 0.4);
      border-radius: 10px 0 0 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        -2px 0 12px rgba(0, 0, 0, 0.4),
        0 0 8px rgba(94, 234, 212, 0.1),
        inset 0 1px 0 rgba(94, 234, 212, 0.1);
      position: relative;
      overflow: hidden;
      pointer-events: auto; /* Arrow itself should be clickable */
    ">
      <div style="
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(94, 234, 212, 0.05) 0%, transparent 100%);
        pointer-events: none;
      "></div>
      <i data-feather="chevron-left" id="history-arrow-icon" style="
        width: 20px;
        height: 20px;
        color: #5EEAD4;
        transition: transform 0.3s ease;
        position: relative;
        z-index: 1;
        filter: drop-shadow(0 0 4px rgba(94, 234, 212, 0.5));
      "></i>
    </div>
    
    {# Sidebar - Hidden by default, slides on hover from right #}
    <aside id="recent-history-sidebar" style="
      width: 280px;
      max-height: calc(100vh - 160px);
      background: rgba(10, 18, 32, 0.96);
      border: 1px solid rgba(94, 234, 212, 0.2);
      border-right: none;
      border-radius: 12px 0 0 12px;
      padding: 16px;
      overflow-y: auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      pointer-events: none; /* Sidebar is hidden, no clicks */
    ">
      <h3 style="
        margin: 0 0 12px 0;
        color: #5EEAD4;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 1px solid rgba(94, 234, 212, 0.2);
        padding-bottom: 8px;
      ">
        <i data-feather="clock" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 6px;"></i>
        Recent History
      </h3>
      <div id="recent-history-list" style="display: flex; flex-direction: column; gap: 6px;">
        {% if recent_history and recent_history|length > 0 %}
          {% for item in recent_history %}
            <div class="history-item" data-indicator="{{ item.indicator }}" style="
              padding: 8px 12px;
              background: rgba(6, 11, 22, 0.6);
              border: 1px solid rgba(94, 234, 212, 0.1);
              border-radius: 6px;
              cursor: pointer;
              transition: none;
              font-size: 12px;
              font-family: 'Courier New', monospace;
            " 
            onclick="lookupHistoryItem('{{ item.indicator }}')">
              <div style="color: #5EEAD4; font-weight: 600; margin-bottom: 4px; word-break: break-all;">
                {{ item.indicator }}
              </div>
              <div style="color: #94A3B8; font-size: 10px; display: flex; justify-content: space-between;">
                <span>{{ item.type|upper }}</span>
                <span>
                  {% if item.age_hours < 1 %}
                    {{ (item.age_hours * 60)|int }}m ago
                  {% elif item.age_hours < 24 %}
                    {{ item.age_hours|int }}h ago
                  {% else %}
                    {{ (item.age_hours / 24)|int }}d ago
                  {% endif %}
                </span>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="
            padding: 16px;
            text-align: center;
            color: #94A3B8;
            font-size: 12px;
          ">
            No recent searches
          </div>
        {% endif %}
      </div>
    </aside>
  </div>

  <footer><p>&copy; 2025 verdicom.io</p></footer>

  <script>
    // ========== GLOBAL FUNCTIONS (Accessible by HTML onclick) ==========
    // These functions MUST be global so HTML onclick attributes can access them
    
    window.toggleBodyPreview = function() {
      console.log('[Body Preview] Toggle clicked');
      var previewElement = document.getElementById('email-body-preview');
      var toggleText = document.getElementById('body-preview-toggle-text');
      var toggleIcon = document.getElementById('body-preview-icon');
      
      if (!previewElement) {
        console.error('[Body Preview] Preview element not found');
        return;
      }
      
      var currentMaxHeight = previewElement.style.maxHeight || '200px';
      var isExpanded = currentMaxHeight === 'none' || currentMaxHeight === '' || parseInt(currentMaxHeight) > 200;
      
      if (!isExpanded) {
        previewElement.style.maxHeight = '600px';
        previewElement.style.height = '600px';
        if (toggleText) toggleText.textContent = 'Collapse';
        if (toggleIcon) {
          toggleIcon.setAttribute('data-feather', 'minimize-2');
          if (typeof feather !== 'undefined') feather.replace();
        }
      } else {
        previewElement.style.maxHeight = '200px';
        previewElement.style.height = 'auto';
        if (toggleText) toggleText.textContent = 'Expand';
        if (toggleIcon) {
          toggleIcon.setAttribute('data-feather', 'maximize-2');
          if (typeof feather !== 'undefined') feather.replace();
        }
      };
    }
    
    // Also create a direct reference without window prefix for easier access
    var toggleBodyPreview = window.toggleBodyPreview;
    
    // Make other toggle functions global as well (if they exist)
    // Recent History Sidebar - Slide Animation
    function initHistorySidebar() {
      const container = document.getElementById('recent-history-container');
      const sidebar = document.getElementById('recent-history-sidebar');
      const arrow = document.getElementById('recent-history-arrow');
      const arrowIcon = document.getElementById('history-arrow-icon');
      
      if (!container || !sidebar || !arrow) return;
      
      // Open sidebar ONLY when hovering over the arrow (not the container)
      arrow.addEventListener('mouseenter', function() {
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.opacity = '1';
        sidebar.style.pointerEvents = 'auto';
        if (arrowIcon) {
          arrowIcon.style.transform = 'rotate(180deg)';
          arrowIcon.style.filter = 'drop-shadow(0 0 8px rgba(94, 234, 212, 0.8))';
        }
        arrow.style.background = 'linear-gradient(135deg, rgba(94, 234, 212, 0.2) 0%, rgba(37, 99, 235, 0.15) 100%)';
        arrow.style.borderLeft = '2px solid rgba(94, 234, 212, 0.6)';
        arrow.style.borderRight = 'none';
        arrow.style.boxShadow = '-2px 0 16px rgba(0, 0, 0, 0.5), 0 0 16px rgba(94, 234, 212, 0.3), inset 0 1px 0 rgba(94, 234, 212, 0.2)';
      });
      
      // Keep sidebar open when hovering over sidebar itself
      sidebar.addEventListener('mouseenter', function() {
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.opacity = '1';
        sidebar.style.pointerEvents = 'auto';
      });
      
      // Close sidebar when mouse leaves both arrow and sidebar
      let isOverArrow = false;
      let isOverSidebar = false;
      
      function checkAndClose() {
        if (!isOverArrow && !isOverSidebar) {
          sidebar.style.transform = 'translateX(100%)';
          sidebar.style.opacity = '0';
          sidebar.style.pointerEvents = 'none';
          if (arrowIcon) {
            arrowIcon.style.transform = 'rotate(0deg)';
            arrowIcon.style.filter = 'drop-shadow(0 0 4px rgba(94, 234, 212, 0.5))';
          }
          arrow.style.background = 'linear-gradient(135deg, rgba(10, 18, 32, 0.98) 0%, rgba(6, 11, 22, 0.98) 100%)';
          arrow.style.borderLeft = '2px solid rgba(94, 234, 212, 0.4)';
          arrow.style.borderRight = 'none';
          arrow.style.boxShadow = '-2px 0 12px rgba(0, 0, 0, 0.4), 0 0 8px rgba(94, 234, 212, 0.1), inset 0 1px 0 rgba(94, 234, 212, 0.1)';
        }
      }
      
      arrow.addEventListener('mouseenter', function() {
        isOverArrow = true;
      });
      
      arrow.addEventListener('mouseleave', function() {
        isOverArrow = false;
        setTimeout(checkAndClose, 50);
      });
      
      sidebar.addEventListener('mouseenter', function() {
        isOverSidebar = true;
      });
      
      sidebar.addEventListener('mouseleave', function() {
        isOverSidebar = false;
        setTimeout(checkAndClose, 50);
      });
      
      // Remove any inline styles that might interfere with CSS hover
      const historyItems = sidebar.querySelectorAll('.history-item');
      historyItems.forEach(function(item) {
        // Remove transition from inline style
        item.style.transition = 'none';
        // Ensure CSS can override
        item.style.setProperty('background', '', 'important');
        item.style.setProperty('border-color', '', 'important');
      });
    }
    
    // Initialize sidebar when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initHistorySidebar();
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      });
    } else {
      initHistorySidebar();
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    }
    
    // Recent History Sidebar - Click handler
    // Uses cache-only lookup for instant results (no API calls)
    function lookupHistoryItem(indicator) {
      const queryInput = document.querySelector('input[name="query"]');
      if (queryInput) {
        queryInput.value = indicator;
      }
      
      // Show loading state
      const submitButton = document.querySelector('button[type="submit"]');
      const originalButtonText = submitButton ? submitButton.innerHTML : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i data-feather="loader"></i> Loading from cache...';
        if (typeof feather !== 'undefined') feather.replace();
      }
      
      // Try fast lookup first (cache only, no API calls)
      fetch('/lookup_fast', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: indicator })
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else if (response.status === 404) {
          // Not in cache - fall back to full lookup
          throw new Error('NOT_IN_CACHE');
        } else {
          throw new Error('API_ERROR');
        }
      })
      .then(data => {
        if (data.success) {
          // Data found in cache - reload page with cached data
          // We'll use a form submission but with a flag to skip API calls
          const form = queryInput ? queryInput.closest('form') : null;
          if (form) {
            // Add flag to use cache only
            const cacheOnlyInput = document.createElement('input');
            cacheOnlyInput.type = 'hidden';
            cacheOnlyInput.name = 'cache_only';
            cacheOnlyInput.value = '1';
            form.appendChild(cacheOnlyInput);
            
            // Submit form - backend will check cache_only flag
            form.submit();
          } else {
            // Fallback: reload page
            window.location.href = '/lookup?query=' + encodeURIComponent(indicator) + '&cache_only=1';
          }
        }
      })
      .catch(error => {
        if (error.message === 'NOT_IN_CACHE') {
          // Not in cache - do full lookup with API calls
          const form = queryInput ? queryInput.closest('form') : null;
          if (form) {
            if (submitButton) {
              submitButton.innerHTML = '<i data-feather="search"></i> Fetching from API...';
              if (typeof feather !== 'undefined') feather.replace();
            }
            form.submit();
          }
        } else {
          // Error - fall back to normal lookup
          console.error('Fast lookup error:', error);
          const form = queryInput ? queryInput.closest('form') : null;
          if (form) {
            form.submit();
          }
        }
      })
      .finally(() => {
        if (submitButton && !submitButton.disabled) {
          submitButton.innerHTML = originalButtonText;
          if (typeof feather !== 'undefined') feather.replace();
        }
      });
    }

    function toggleDetections() {
      var el = document.getElementById('vt-detections');
      if (el.style.display === 'none') {
        el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }

    function toggleIpdbReports() {
      var el = document.getElementById('ipdb-reports');
      if (el.style.display === 'none') {
        el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }

    function toggleNews() {
      var body = document.getElementById('news-body');
      var toggle = document.getElementById('news-toggle');
      if (!body || !toggle) return;

      var collapsed = body.classList.toggle('collapsed');
      toggle.setAttribute('data-state', collapsed ? 'closed' : 'open');

      var label = toggle.querySelector('.label');
      if (label) {
        label.textContent = collapsed ? 'Show' : 'Hide';
      }

      var icon = toggle.querySelector('.icon');
      if (icon) {
        icon.setAttribute('data-feather', collapsed ? 'chevron-down' : 'chevron-up');
        feather.replace();
      }
    }

    // Body Preview Toggle Functions - Already defined globally as window.toggleBodyPreview above
    // No need for duplicate definition

    function resetBodyPreview() {
      var previewElement = document.getElementById('email-body-preview');
      var toggleButton = document.getElementById('toggle-body-preview');
      var toggleText = document.getElementById('body-preview-toggle-text');
      var toggleIcon = document.getElementById('body-preview-icon');
      
      if (previewElement) {
        previewElement.style.maxHeight = '200px';
        previewElement.style.height = 'auto';
      }
      
      if (toggleText) toggleText.textContent = 'Expand';
      if (toggleIcon) {
        toggleIcon.setAttribute('data-feather', 'maximize-2');
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }
    }

    // --- New JavaScript Function ---
    function toggleLogAnalyzer() {
      var el = document.getElementById('log-analyzer-section');
      if (el.style.display === 'none') {
        el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }

    // Toggle attachment content visibility
    function toggleAttachmentContent(contentId) {
      var el = document.getElementById(contentId);
      if (el) {
        if (el.style.display === 'none' || el.style.display === '') {
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
        // Re-initialize feather icons after toggle
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }
    }

    // View PDF as HTML using pdf2htmlEX
    function viewPDFAsHTML(pdfHash, viewerId) {
      var viewerEl = document.getElementById(viewerId);
      var contentEl = document.getElementById(viewerId + '-content');
      
      if (!viewerEl || !contentEl) {
        console.error('[PDF Viewer] Viewer element not found:', viewerId);
        return;
      }
      
      // Show viewer container
      viewerEl.style.display = 'block';
      
      // Show loading state
      contentEl.innerHTML = `
        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
          <i data-feather="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i>
          <p>Converting PDF to HTML...</p>
        </div>
      `;
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
      
      // Fetch HTML from server
      fetch(`/view_pdf/${pdfHash}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.text();
        })
        .then(html => {
          // Create iframe to display HTML
          contentEl.innerHTML = `
            <iframe 
              src="data:text/html;charset=utf-8,${encodeURIComponent(html)}" 
              style="width: 100%; height: 100%; border: none;"
              sandbox="allow-same-origin allow-scripts"
            ></iframe>
          `;
        })
        .catch(error => {
          console.error('[PDF Viewer] Error loading PDF:', error);
          contentEl.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #EF4444;">
              <i data-feather="alert-circle" style="width: 24px; height: 24px;"></i>
              <p>Error loading PDF: ${escapeHtml(error.message)}</p>
              <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                The PDF may need to be converted to HTML first. Please ensure pdf2htmlEX is installed.
              </p>
            </div>
          `;
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        });
    }

    // Close PDF viewer
    function closePDFViewer(viewerId) {
      var viewerEl = document.getElementById(viewerId);
      if (viewerEl) {
        viewerEl.style.display = 'none';
        // Clear content to free memory
        var contentEl = document.getElementById(viewerId + '-content');
        if (contentEl) {
          contentEl.innerHTML = '';
        }
      }
    }

    // ======= FILE VIEWER FUNCTIONS =======
    // Close file viewer modal
    function closeFileViewer() {
      var modal = document.getElementById('file-viewer-modal');
      if (modal) {
        modal.style.display = 'none';
        var content = document.getElementById('viewer-content');
        if (content) {
          // Clean up blob URLs and clear content
          content.innerHTML = '';
        }
        // Re-initialize feather icons
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }
    }

    // View file in modal (client-side rendering)
    async function viewFile(fileData, filename, fileType, fileMetadata = null) {
      console.log('[File Viewer] Opening file:', filename, 'Type:', fileType, 'Metadata:', fileMetadata);
      
      var modal = document.getElementById('file-viewer-modal');
      var contentEl = document.getElementById('viewer-content');
      var filenameEl = document.getElementById('viewer-filename');
      
      if (!modal || !contentEl) {
        console.error('[File Viewer] Modal elements not found');
        return;
      }
      
      // Set filename
      if (filenameEl) {
        filenameEl.textContent = filename || 'File Viewer';
      }
      
      // Show modal
      modal.style.display = 'block';
      
      // Build file information panel HTML if metadata is available
      var infoPanelHTML = '';
      var savedInfoPanelHTML = '';
      if (fileMetadata && fileMetadata.hash) {
        // Generate VirusTotal URL (main page, not community tab)
        var vtUrl = `https://www.virustotal.com/gui/file/${fileMetadata.hash}`;
        
        // Determine verdict text and color
        var verdictText = 'Unknown';
        var verdictBgColor = 'rgba(148, 163, 184, 0.2)';
        var verdictTextColor = 'var(--text-secondary)';
        
        if (fileMetadata.communityScore < 0) {
          verdictText = `🚨 MALICIOUS ${fileMetadata.total > 0 ? fileMetadata.malicious + '/' + fileMetadata.total : ''}`;
          verdictBgColor = 'rgba(239, 68, 68, 0.2)';
          verdictTextColor = '#EF4444';
        } else if (fileMetadata.malicious > 0) {
          verdictText = `⚠️ Malware ${fileMetadata.total > 0 ? fileMetadata.malicious + '/' + fileMetadata.total : ''}`;
          verdictBgColor = 'rgba(239, 68, 68, 0.2)';
          verdictTextColor = '#EF4444';
        } else if (fileMetadata.suspicious > 0) {
          verdictText = `⚠️ Suspicious ${fileMetadata.total > 0 ? fileMetadata.suspicious + '/' + fileMetadata.total : ''}`;
          verdictBgColor = 'rgba(245, 158, 11, 0.2)';
          verdictTextColor = '#F59E0B';
        } else if (fileMetadata.vtStats && Object.keys(fileMetadata.vtStats).length > 0) {
          verdictText = '✓ Clean';
          verdictBgColor = 'rgba(34, 197, 94, 0.2)';
          verdictTextColor = '#22C55E';
        }
        
        infoPanelHTML = `
          <div id="file-info-panel" style="
            margin-bottom: 16px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
          ">
            <div id="file-info-header" style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px 16px;
              background: rgba(10, 18, 32, 0.8);
              border-bottom: 1px solid var(--border-color);
              cursor: pointer;
              transition: background 0.2s ease;
            " onclick="toggleFileInfoPanel()" onmouseover="this.style.background='rgba(94, 234, 212, 0.1)'" onmouseout="this.style.background='rgba(10, 18, 32, 0.8)'">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-feather="info" style="width: 16px; height: 16px; color: var(--accent-blue);"></i>
                <span style="color: var(--text-primary); font-weight: 600; font-size: 14px;">Information about this file</span>
              </div>
              <i data-feather="chevron-down" id="file-info-icon" style="width: 18px; height: 18px; color: var(--text-secondary); transition: transform 0.3s ease;"></i>
            </div>
            <div id="file-info-content" style="
              display: none;
              padding: 16px;
              background: var(--bg-light);
            ">
              <div style="display: grid; gap: 16px;">
                <div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-weight: 500; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">SHA256 Hash</div>
                  <div style="
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                    color: var(--text-primary);
                    background: rgba(0, 0, 0, 0.3);
                    padding: 10px 12px;
                    border-radius: 6px;
                    border: 1px solid var(--border-color);
                    word-break: break-all;
                    user-select: all;
                  ">${fileMetadata.hash}</div>
                </div>
                <div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-weight: 500; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Verdict</div>
                  <div style="
                    display: inline-block;
                    padding: 8px 12px;
                    background: ${verdictBgColor};
                    border-radius: 6px;
                    color: ${verdictTextColor};
                    font-weight: 600;
                    font-size: 13px;
                  ">${verdictText}</div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <a href="${vtUrl}" target="_blank" rel="noopener noreferrer" style="
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 16px;
                    background: rgba(94, 234, 212, 0.15);
                    border: 1px solid rgba(94, 234, 212, 0.4);
                    border-radius: 6px;
                    color: var(--accent-blue);
                    font-size: 13px;
                    font-weight: 600;
                    text-decoration: none;
                    transition: all 0.2s ease;
                  " onmouseover="this.style.background='rgba(94, 234, 212, 0.25)'; this.style.borderColor='rgba(94, 234, 212, 0.6)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(94, 234, 212, 0.15)'; this.style.borderColor='rgba(94, 234, 212, 0.4)'; this.style.transform='translateY(0)'">
                    <i data-feather="external-link" style="width: 14px; height: 14px;"></i>
                    View in VirusTotal
                  </a>
                  <button onclick="analyzeFileLinks('${fileMetadata.hash}')" id="analyze-file-btn" style="
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 16px;
                    background: rgba(37, 99, 235, 0.15);
                    border: 1px solid rgba(37, 99, 235, 0.4);
                    border-radius: 6px;
                    color: #5EEAD4;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  " onmouseover="this.style.background='rgba(37, 99, 235, 0.25)'; this.style.borderColor='rgba(37, 99, 235, 0.6)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(37, 99, 235, 0.15)'; this.style.borderColor='rgba(37, 99, 235, 0.4)'; this.style.transform='translateY(0)'">
                    <i data-feather="search" style="width: 14px; height: 14px;"></i>
                    Analyze this file
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        savedInfoPanelHTML = infoPanelHTML;
      }
      
      contentEl.innerHTML = infoPanelHTML + `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <i data-feather="loader" style="width: 32px; height: 32px; animation: spin 1s linear infinite;"></i>
          <p>Loading file...</p>
        </div>
      `;
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
      
      try {
        // Convert fileData to Blob if needed
        var blob;
        if (fileData instanceof Blob) {
          blob = fileData;
        } else if (typeof fileData === 'string') {
          // Assume base64 encoded string
          var binaryString = atob(fileData);
          var bytes = new Uint8Array(binaryString.length);
          for (var i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          blob = new Blob([bytes], { type: getMimeType(filename, fileType) });
        } else if (fileData instanceof ArrayBuffer) {
          blob = new Blob([fileData], { type: getMimeType(filename, fileType) });
        } else {
          throw new Error('Unsupported file data format');
        }
        
        // Determine file type from extension
        var ext = (filename || '').toLowerCase().split('.').pop();
        
        // Render based on file type
        if (ext === 'pdf' || fileType === 'pdf' || fileType === 'application/pdf') {
          // PDF: Display in iframe
          var blobUrl = URL.createObjectURL(blob);
          var fileContentHTML = `
            <iframe 
              src="${blobUrl}" 
              style="width: 100%; height: 100%; min-height: 600px; border: none;"
              onload="URL.revokeObjectURL('${blobUrl}')"
            ></iframe>
          `;
          contentEl.innerHTML = savedInfoPanelHTML + fileContentHTML;
        } else if (ext === 'docx' || fileType === 'docx' || fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
          // DOCX: Use docx-preview
          // Check if required libraries are loaded
          if (typeof JSZip === 'undefined') {
            throw new Error('JSZip library is required but not loaded. Please refresh the page.');
          }
          if (typeof docx === 'undefined' || !docx.renderAsync) {
            throw new Error('docx-preview library not loaded. Please refresh the page.');
          }
          
          // Verify blob is valid
          if (!(blob instanceof Blob)) {
            throw new Error('Invalid file data: expected Blob object');
          }
          
          try {
            // Create wrapper div for file content
            var fileContentWrapper = document.createElement('div');
            fileContentWrapper.style.padding = '40px';
            fileContentWrapper.style.maxWidth = '800px';
            fileContentWrapper.style.margin = '0 auto';
            contentEl.innerHTML = savedInfoPanelHTML;
            contentEl.appendChild(fileContentWrapper);
            await docx.renderAsync(blob, fileContentWrapper);
          } catch (renderError) {
            console.error('[File Viewer] Error rendering DOCX:', renderError);
            throw new Error('Failed to render DOCX file. The file may be corrupted or in an unsupported format. Error: ' + renderError.message);
          }
        } else if (ext === 'xlsx' || ext === 'xls' || fileType === 'xlsx' || fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
          // XLSX: Use SheetJS
          if (typeof XLSX !== 'undefined') {
            var arrayBuffer = await blob.arrayBuffer();
            var workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            // Get first sheet
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            
            // Convert to HTML
            var html = XLSX.utils.sheet_to_html(worksheet);
            
            var fileContentHTML = `
              <div style="padding: 20px; overflow-x: auto;">
                ${html}
              </div>
            `;
            contentEl.innerHTML = savedInfoPanelHTML + fileContentHTML;
            
            // Style the table
            var tables = contentEl.querySelectorAll('table');
            tables.forEach(function(table) {
              table.style.width = '100%';
              table.style.borderCollapse = 'collapse';
              table.style.border = '1px solid #ddd';
            });
          } else {
            throw new Error('SheetJS library not loaded');
          }
        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) {
          // Images: Display in img tag
          var blobUrl = URL.createObjectURL(blob);
          var fileContentHTML = `
            <div style="text-align: center; padding: 20px;">
              <img 
                src="${blobUrl}" 
                alt="${escapeHtml(filename)}"
                style="max-width: 100%; max-height: 100%; object-fit: contain;"
                onload="URL.revokeObjectURL('${blobUrl}')"
              />
            </div>
          `;
          contentEl.innerHTML = savedInfoPanelHTML + fileContentHTML;
        } else if (ext === 'txt' || ext === 'log' || fileType === 'text/plain') {
          // Text files: Display in pre tag
          var text = await blob.text();
          var fileContentHTML = `
            <pre style="
              font-family: 'Courier New', monospace;
              font-size: 13px;
              padding: 20px;
              background: #f5f5f5;
              border-radius: 4px;
              overflow-x: auto;
              white-space: pre-wrap;
              word-wrap: break-word;
              color: #000;
            ">${escapeHtml(text)}</pre>
          `;
          contentEl.innerHTML = savedInfoPanelHTML + fileContentHTML;
        } else {
          // Unknown file type: Show error
          var blobUrl = URL.createObjectURL(blob);
          var fileContentHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger-text);">
              <i data-feather="alert-circle" style="width: 48px; height: 48px;"></i>
              <h3 style="margin: 16px 0 8px;">Unsupported File Type</h3>
              <p>Preview is not available for .${ext} files</p>
              <button onclick="downloadFileFromBlob(${JSON.stringify(filename)}, ${JSON.stringify(blobUrl)})" style="
                margin-top: 16px;
                padding: 10px 20px;
                background: var(--accent-blue);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              ">Download File</button>
            </div>
          `;
          contentEl.innerHTML = savedInfoPanelHTML + fileContentHTML;
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        }
      } catch (error) {
        console.error('[File Viewer] Error viewing file:', error);
        var errorMessage = error.message || 'Unknown error occurred';
        
        // Provide more helpful error messages
        if (errorMessage.includes('JSZip')) {
          errorMessage = 'JSZip library is missing. Please refresh the page to load all required libraries.';
        } else if (errorMessage.includes('docx-preview')) {
          errorMessage = 'DOCX preview library is missing. Please refresh the page to load all required libraries.';
        } else if (errorMessage.includes('corrupted') || errorMessage.includes('unsupported format')) {
          errorMessage = 'The file appears to be corrupted or in an unsupported format. Please try downloading the file instead.';
        }
        
        // Save info panel HTML before showing error
        var infoPanelElement = contentEl.querySelector('#file-info-panel');
        var savedInfoPanelHTML = infoPanelElement ? infoPanelElement.outerHTML : '';
        
        contentEl.innerHTML = savedInfoPanelHTML + `
          <div style="text-align: center; padding: 40px; color: var(--danger-text);">
            <i data-feather="alert-circle" style="width: 48px; height: 48px; margin-bottom: 16px;"></i>
            <h3 style="color: var(--danger-text); margin-bottom: 8px;">Error Loading File</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">${escapeHtml(errorMessage)}</p>
            <button onclick="closeFileViewerModal()" style="
              padding: 8px 16px;
              background: rgba(239, 68, 68, 0.2);
              border: 1px solid var(--danger-border);
              border-radius: 4px;
              color: var(--danger-text);
              cursor: pointer;
              font-size: 14px;
            ">Close</button>
          </div>
        `;
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }
    }

    // Escape HTML to prevent XSS - Define before use
    window.escapeHtml = function(text) {
      if (!text) return '';
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    };

    // Toggle file info panel expand/collapse
    window.toggleFileInfoPanel = function() {
      var contentEl = document.getElementById('file-info-content');
      var iconEl = document.getElementById('file-info-icon');
      
      if (!contentEl || !iconEl) return;
      
      var isExpanded = contentEl.style.display !== 'none';
      
      if (isExpanded) {
        contentEl.style.display = 'none';
        iconEl.setAttribute('data-feather', 'chevron-down');
        iconEl.style.transform = 'rotate(0deg)';
      } else {
        contentEl.style.display = 'block';
        iconEl.setAttribute('data-feather', 'chevron-up');
        iconEl.style.transform = 'rotate(180deg)';
      }
      
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    };

    // Analyze file links
    window.analyzeFileLinks = async function(fileHash) {
      console.log('[File Analyzer] Starting analysis for file:', fileHash);
      
      var analyzeBtn = document.getElementById('analyze-file-btn');
      var originalText = analyzeBtn ? analyzeBtn.innerHTML : '';
      
      // Disable button and show loading
      if (analyzeBtn) {
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i data-feather="loader" style="width: 14px; height: 14px; animation: spin 1s linear infinite;"></i> Analyzing...';
        if (typeof feather !== 'undefined') feather.replace();
      }
      
      try {
        const response = await fetch(`/analyze_file/${fileHash}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to analyze file');
        }
        
        // Create results panel
        var resultsPanelId = 'file-links-results';
        var existingPanel = document.getElementById(resultsPanelId);
        if (existingPanel) {
          existingPanel.remove();
        }
        
        var resultsHTML = `
          <div id="${resultsPanelId}" style="
            margin-top: 16px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
          ">
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px 16px;
              background: rgba(10, 18, 32, 0.8);
              border-bottom: 1px solid var(--border-color);
            ">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-feather="link" style="width: 16px; height: 16px; color: var(--accent-blue);"></i>
                <span style="color: var(--text-primary); font-weight: 600; font-size: 14px;">Links Found in File</span>
                <span style="
                  padding: 2px 8px;
                  background: rgba(37, 99, 235, 0.2);
                  border-radius: 12px;
                  font-size: 11px;
                  color: var(--accent-blue);
                  font-weight: 600;
                ">${data.urls_count || 0}</span>
              </div>
              <button onclick="document.getElementById('${resultsPanelId}').remove()" style="
                background: transparent;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                padding: 4px;
              " onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
                <i data-feather="x" style="width: 16px; height: 16px;"></i>
              </button>
            </div>
            <div style="padding: 16px; background: var(--bg-light); max-height: 500px; overflow-y: auto;">
              ${data.urls && data.urls.length > 0 ? data.urls.map(item => {
                let borderColor = '#22C55E';
                let bgColor = 'rgba(34, 197, 94, 0.1)';
                let icon = 'check-circle';
                let statusText = 'Clean';
                let statusColor = '#22C55E';
                
                const communityScore = parseInt(item.community_score || 0);
                if (communityScore < 0) {
                  borderColor = '#EF4444';
                  bgColor = 'rgba(239, 68, 68, 0.15)';
                  icon = 'alert-triangle';
                  statusText = 'MALICIOUS';
                  statusColor = '#EF4444';
                } else if (item.malicious > 0) {
                  borderColor = '#EF4444';
                  bgColor = 'rgba(239, 68, 68, 0.15)';
                  icon = 'alert-triangle';
                  statusText = 'MALICIOUS';
                  statusColor = '#EF4444';
                } else if (item.suspicious > 0) {
                  borderColor = '#F59E0B';
                  bgColor = 'rgba(245, 158, 11, 0.15)';
                  icon = 'alert-circle';
                  statusText = 'SUSPICIOUS';
                  statusColor = '#F59E0B';
                }
                
                const totalScans = item.total || (item.malicious + item.suspicious + item.harmless + item.undetected);
                const maliciousPct = totalScans > 0 ? Math.round((item.malicious / totalScans) * 100) : 0;
                const suspiciousPct = totalScans > 0 ? Math.round((item.suspicious / totalScans) * 100) : 0;
                const communityLink = item.vt_community_link ? '<a href="' + item.vt_community_link + '" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; font-size: 11px; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;"><i data-feather="external-link" style="width: 12px; height: 12px;"></i> View Community</a>' : '';
                const errorSpan = item.error ? '<span style="color: var(--text-secondary); font-size: 11px; margin-left: auto; flex-shrink: 0;">Error: ' + escapeHtml(item.error) + '</span>' : '';
                const maliciousPctDiv = maliciousPct > 0 ? '<div style="color: #EF4444; font-size: 9px; margin-top: 2px;">' + maliciousPct + '%</div>' : '';
                const suspiciousPctDiv = suspiciousPct > 0 ? '<div style="color: #F59E0B; font-size: 9px; margin-top: 2px;">' + suspiciousPct + '%</div>' : '';
                const communityBg = communityScore < 0 ? 'rgba(239, 68, 68, 0.1)' : communityScore > 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(148, 163, 184, 0.1)';
                const communityColor = communityScore < 0 ? '#EF4444' : communityScore > 0 ? '#22C55E' : 'var(--text-secondary)';
                const statsDiv = item.error ? '' : '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px; width: 100%; max-width: 100%; box-sizing: border-box;">' +
                  '<div style="text-align: center; padding: 6px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">' +
                    '<div style="color: #EF4444; font-size: 16px; font-weight: 700;">' + (item.malicious || 0) + '</div>' +
                    '<div style="color: var(--text-secondary); font-size: 10px;">Malicious</div>' +
                    maliciousPctDiv +
                  '</div>' +
                  '<div style="text-align: center; padding: 6px; background: rgba(245, 158, 11, 0.1); border-radius: 4px;">' +
                    '<div style="color: #F59E0B; font-size: 16px; font-weight: 700;">' + (item.suspicious || 0) + '</div>' +
                    '<div style="color: var(--text-secondary); font-size: 10px;">Suspicious</div>' +
                    suspiciousPctDiv +
                  '</div>' +
                  '<div style="text-align: center; padding: 6px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">' +
                    '<div style="color: #22C55E; font-size: 16px; font-weight: 700;">' + (item.harmless || 0) + '</div>' +
                    '<div style="color: var(--text-secondary); font-size: 10px;">Harmless</div>' +
                  '</div>' +
                  '<div style="text-align: center; padding: 6px; background: ' + communityBg + '; border-radius: 4px;">' +
                    '<div style="color: ' + communityColor + '; font-size: 16px; font-weight: 700;">' + communityScore + '</div>' +
                    '<div style="color: var(--text-secondary); font-size: 10px;">Community</div>' +
                  '</div>' +
                  '<div style="text-align: center; padding: 6px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">' +
                    '<div style="color: var(--text-secondary); font-size: 16px; font-weight: 700;">' + totalScans + '</div>' +
                    '<div style="color: var(--text-secondary); font-size: 10px;">Total Scans</div>' +
                  '</div>' +
                '</div>';
                
                return '<div style="margin-bottom: 12px; padding: 12px; background: ' + bgColor + '; border: 2px solid ' + borderColor + '; border-radius: 6px; width: 100%; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">' +
                  '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">' +
                    '<i data-feather="' + icon + '" style="width: 18px; height: 18px; color: ' + borderColor + '; flex-shrink: 0;"></i>' +
                    '<strong style="color: ' + statusColor + '; font-size: 14px; font-weight: 700; flex-shrink: 0;">' + statusText + '</strong>' +
                    communityLink +
                    errorSpan +
                  '</div>' +
                  '<div style="font-family: monospace; font-size: 12px; color: var(--text-primary); word-break: break-all; word-wrap: break-word; margin-bottom: 8px; font-weight: 500; width: 100%; max-width: 100%; overflow-wrap: break-word;">' + escapeHtml(item.url) + '</div>' +
                  statsDiv +
                '</div>';
              }).join('') : '<p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No links found in this file.</p>'}
            </div>
          </div>
        `;
        
        // Insert results panel after file info panel
        var fileInfoPanel = document.getElementById('file-info-panel');
        if (fileInfoPanel) {
          fileInfoPanel.insertAdjacentHTML('afterend', resultsHTML);
        } else {
          // Fallback: insert in viewer content
          var viewerContent = document.getElementById('viewer-content');
          if (viewerContent) {
            viewerContent.insertAdjacentHTML('afterbegin', resultsHTML);
          }
        }
        
        // Re-initialize feather icons
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
        
        console.log('[File Analyzer] Analysis complete:', data);
        
      } catch (error) {
        console.error('[File Analyzer] Error:', error);
        alert('Error analyzing file: ' + error.message);
      } finally {
        // Re-enable button
        if (analyzeBtn) {
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = originalText;
          if (typeof feather !== 'undefined') feather.replace();
        }
      }
    };

    // Helper function to get MIME type from filename
    function getMimeType(filename, fileType) {
      if (fileType) return fileType;
      
      var ext = (filename || '').toLowerCase().split('.').pop();
      var mimeTypes = {
        'pdf': 'application/pdf',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'doc': 'application/msword',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'xls': 'application/vnd.ms-excel',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
        'txt': 'text/plain',
        'log': 'text/plain'
      };
      return mimeTypes[ext] || 'application/octet-stream';
    }

    // Helper function to download file from blob URL
    function downloadFileFromBlob(filename, blobUrl) {
      var a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);
    }

    // Load attachment from server and view it
    async function loadAndViewAttachment(fileHash, filename, fileType, fileMetadata = null) {
      try {
        // Fetch file from server
        const response = await fetch(`/attachment/${fileHash}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Get file as blob
        const blob = await response.blob();
        
        // View file using viewFile function with metadata
        await viewFile(blob, filename, fileType, fileMetadata);
      } catch (error) {
        console.error('[File Viewer] Error loading attachment:', error);
        alert('Error loading file: ' + error.message);
      }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        var modal = document.getElementById('file-viewer-modal');
        if (modal && modal.style.display !== 'none') {
          closeFileViewer();
        }
      }
    });

    // --- New JavaScript Function ---
    function searchIndicator(indicator) {
      // 1. Find the main search input box
      var mainQueryInput = document.querySelector('input[name="query"]');
      
      // 2. Find the main form
      var mainForm = document.querySelector('form[action="/lookup"]');
      
      // 3. Set the IP in the main search input box
      mainQueryInput.value = indicator;
      
      // 4. Submit the main form
      mainForm.submit();
    }
  </script>
  <script>
    feather.replace()
    
    // Re-initialize feather icons after dynamic content loads
    document.addEventListener('DOMContentLoaded', function() {
      feather.replace();
    });
    
    // Re-initialize icons after log analysis (when form is submitted and page reloads)
    if (document.getElementById('log-analyzer-section') && document.getElementById('log-analyzer-section').style.display !== 'none') {
      setTimeout(function() {
        feather.replace();
      }, 100);
    }

    // ========== THREAT CONSTELLATION MAP (Cytoscape.js) ==========
    {% if graph_data %}
    (function() {
      // Function to initialize the graph
      function initThreatConstellationMap() {
        const container = document.getElementById('cy');
        if (!container) {
          console.error('Threat Constellation Map container not found');
          return;
        }
        
        // Create stars background
        const starsContainer = document.getElementById('cy-stars');
        if (starsContainer) {
          const numStars = 30; // Number of stars (optimized for performance)
          const containerWidth = container.offsetWidth;
          const containerHeight = container.offsetHeight;
          
          for (let i = 0; i < numStars; i++) {
            const star = document.createElement('div');
            const size = Math.random() * 1.5 + 0.5; // Random size between 0.5px and 2px
            const x = Math.random() * containerWidth;
            const y = Math.random() * containerHeight;
            const opacity = Math.random() * 0.4 + 0.2; // Random opacity between 0.2 and 0.6
            const twinkle = Math.random() > 0.7; // 30% chance to twinkle
            
            star.style.position = 'absolute';
            star.style.left = x + 'px';
            star.style.top = y + 'px';
            star.style.width = size + 'px';
            star.style.height = size + 'px';
            star.style.backgroundColor = '#5EEAD4';
            star.style.borderRadius = '50%';
            star.style.opacity = opacity;
            star.style.boxShadow = `0 0 ${size * 2}px rgba(94, 234, 212, ${opacity * 0.5})`;
            star.style.pointerEvents = 'none';
            
            // Add twinkling animation for some stars
            if (twinkle) {
              star.style.animation = `starTwinkle ${2 + Math.random() * 3}s ease-in-out infinite`;
            }
            
            starsContainer.appendChild(star);
          }
        }
        
        let graphData = [];
        try {
          graphData = {{ graph_data | tojson if graph_data else '[]' }};
        } catch(e) {
          console.error('Error parsing graph_data:', e);
          graphData = [];
        }
        
        if (!graphData || !Array.isArray(graphData)) {
          console.warn('Threat Constellation Map: Invalid graph data format', graphData);
          graphData = [];
        }
        
        if (graphData.length === 0) {
          console.warn('Threat Constellation Map: No graph data available - showing empty map');
          // Create a minimal graph with a message node
          graphData = [{
            data: { id: 'no-data', label: 'No graph data available' },
            classes: 'central-node'
          }];
        }
        
        console.log('Initializing Threat Constellation Map with', graphData.length, 'elements');
        
        // Optimized layout configuration for "Star Map" aesthetic
        const layoutConfig = {
          name: 'cose',
          animate: false,
          nodeDimensionsIncludeLabels: false, // Labels don't affect layout
          refresh: 20,
          fit: true,
          padding: 50,
          randomize: false,
          componentSpacing: 150,
          nodeRepulsion: 600000, // Increased to spread stars out more
          edgeElasticity: 50,
          nestingFactor: 5,
          gravity: 50, // Reduced gravity for more elegant spacing
          numIter: 1000,
          initialTemp: 200,
          coolingFactor: 0.95,
          minTemp: 1.0
        };
        
        try {
          const cy = cytoscape({
            container: container,
            elements: graphData,
          style: [
            // ========== CENTRAL NODE (Log Event) - 3D Cyber Core ==========
            {
              selector: '.central-node',
              style: {
                'background-color': '#5EEAD4',
                'width': 12,
                'height': 12,
                'shape': 'ellipse',
                'label': 'data(label)',
                'color': '#5EEAD4',
                'font-size': '11px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 14,
                'border-width': 2,
                'border-color': 'rgba(94, 234, 212, 0.8)',
                'box-shadow': 
                  '0 0 4px rgba(94, 234, 212, 0.5), ' +
                  '0 0 8px rgba(94, 234, 212, 0.3), ' +
                  '0 2px 6px rgba(0, 0, 0, 0.5)'
              }
            },
            {
              selector: '.central-node:hover',
              style: {
                'width': 16,
                'height': 16,
                'font-size': '12px',
                'box-shadow': 
                  '0 0 6px rgba(94, 234, 212, 0.7), ' +
                  '0 0 12px rgba(94, 234, 212, 0.4), ' +
                  '0 3px 8px rgba(0, 0, 0, 0.6)'
              }
            },
            {
              selector: '.central-node:selected',
              style: {
                'width': 16,
                'height': 16,
                'font-size': '12px',
                'box-shadow': 
                  '0 0 8px rgba(94, 234, 212, 0.9), ' +
                  '0 0 16px rgba(94, 234, 212, 0.6), ' +
                  '0 4px 10px rgba(0, 0, 0, 0.7)'
              }
            },
            
            // ========== IP NODES - 3D Cyber Nodes ==========
            {
              selector: '.ip-node',
              style: {
                'background-color': 'data(color)',
                'width': 8,
                'height': 8,
                'shape': 'ellipse',
                'label': 'data(label)',  // Show full IP address, not just last octet
                'color': '#5EEAD4',
                'font-size': '10px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 12,
                'border-width': 2,
                'border-color': function(ele) {
                  const color = ele.data('color') || '#00A8FF';
                  // Convert hex color with alpha to rgba format for cytoscape compatibility
                  if (color.length === 7 && color.startsWith('#')) {
                    const hex = color.substring(1);
                    const r = parseInt(hex.substring(0, 2), 16);
                    const g = parseInt(hex.substring(2, 4), 16);
                    const b = parseInt(hex.substring(4, 6), 16);
                    return 'rgba(' + r + ', ' + g + ', ' + b + ', 0.87)'; // DD = ~0.87 opacity
                  }
                  return color;
                },
                'box-shadow': function(ele) {
                  const color = ele.data('color') || '#00A8FF';
                  return `0 0 3px ${color}88, 0 0 6px ${color}44, 0 2px 4px rgba(0, 0, 0, 0.4)`;
                }
              }
            },
            {
              selector: '.ip-node:hover',
              style: {
                'width': 12,
                'height': 12,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': function(ele) {
                  const color = ele.data('color') || '#00A8FF';
                  return `0 0 8px ${color}CC, 0 0 16px ${color}88`;
                }
              }
            },
            {
              selector: '.ip-node:selected',
              style: {
                'width': 12,
                'height': 12,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': function(ele) {
                  const color = ele.data('color') || '#00A8FF';
                  return `0 0 5px ${color}DD, 0 0 10px ${color}88`;
                }
              }
            },
            
            // ========== FILE NODES - 3D Cyber Nodes ==========
            {
              selector: '.file-node',
              style: {
                'background-color': '#10FF88',
                'width': 8,
                'height': 8,
                'shape': 'ellipse',
                'label': 'data(label)',
                'color': '#10FF88',
                'font-size': '10px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 12,
                'border-width': 2,
                'border-color': 'rgba(16, 255, 136, 0.8)',
                'box-shadow': '0 0 6px rgba(16, 255, 136, 0.7), 0 0 12px rgba(16, 255, 136, 0.4), 0 3px 8px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(16, 255, 136, 0.6)'
              }
            },
            {
              selector: '.file-node:hover',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 10px rgba(16, 255, 136, 0.9), 0 0 20px rgba(16, 255, 136, 0.6), 0 5px 12px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(16, 255, 136, 0.7)'
              }
            },
            {
              selector: '.file-node:selected',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 14px rgba(16, 255, 136, 1), 0 0 28px rgba(16, 255, 136, 0.8), 0 0 42px rgba(16, 255, 136, 0.5), 0 6px 16px rgba(0, 0, 0, 0.7), inset 0 3px 6px rgba(16, 255, 136, 0.8)'
              }
            },
            
            // ========== HASH NODES - 3D Cyber Nodes ==========
            {
              selector: '.hash-node',
              style: {
                'background-color': '#A855F7',
                'width': 8,
                'height': 8,
                'shape': 'ellipse',
                'label': 'data(shortLabel)',
                'color': '#A855F7',
                'font-size': '10px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 12,
                'border-width': 2,
                'border-color': 'rgba(168, 85, 247, 0.8)',
                'box-shadow': '0 0 6px rgba(168, 85, 247, 0.7), 0 0 12px rgba(168, 85, 247, 0.4), 0 3px 8px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(168, 85, 247, 0.6)'
              }
            },
            {
              selector: '.hash-node:hover',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 10px rgba(168, 85, 247, 0.9), 0 0 20px rgba(168, 85, 247, 0.6), 0 5px 12px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(168, 85, 247, 0.7)'
              }
            },
            {
              selector: '.hash-node:selected',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 14px rgba(168, 85, 247, 1), 0 0 28px rgba(168, 85, 247, 0.8), 0 0 42px rgba(168, 85, 247, 0.5), 0 6px 16px rgba(0, 0, 0, 0.7), inset 0 3px 6px rgba(168, 85, 247, 0.8)'
              }
            },
            
            // ========== DOMAIN NODES - 3D Cyber Nodes ==========
            {
              selector: '.domain-node',
              style: {
                'background-color': '#06F3FF',
                'width': 8,
                'height': 8,
                'shape': 'ellipse',
                'label': 'data(label)',
                'color': '#06F3FF',
                'font-size': '10px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 12,
                'border-width': 2,
                'border-color': 'rgba(6, 243, 255, 0.8)',
                'box-shadow': '0 0 6px rgba(6, 243, 255, 0.7), 0 0 12px rgba(6, 243, 255, 0.4), 0 3px 8px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(6, 243, 255, 0.6)'
              }
            },
            {
              selector: '.domain-node:hover',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 10px rgba(6, 243, 255, 0.9), 0 0 20px rgba(6, 243, 255, 0.6), 0 5px 12px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(6, 243, 255, 0.7)'
              }
            },
            {
              selector: '.domain-node:selected',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 14px rgba(6, 243, 255, 1), 0 0 28px rgba(6, 243, 255, 0.8), 0 0 42px rgba(6, 243, 255, 0.5), 0 6px 16px rgba(0, 0, 0, 0.7), inset 0 3px 6px rgba(6, 243, 255, 0.8)'
              }
            },
            
            // ========== RELATED FILE NODES (Deep Relationship Analysis) ==========
            {
              selector: '.related-file-node',
              style: {
                'background-color': 'data(color)',
                'width': 4,
                'height': 4,
                'shape': 'ellipse',
                'label': 'data(shortLabel)',
                'color': '#F97316',  // Neon Orange for malware/files
                'font-size': '8px',
                'font-weight': '600',
                'text-opacity': 0.85,
                'text-outline-width': 2,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 8,
                'border-width': 1,
                'border-color': 'rgba(249, 115, 22, 0.8)',
                'box-shadow': '0 0 3px rgba(249, 115, 22, 0.6), 0 0 6px rgba(249, 115, 22, 0.3), 0 1px 3px rgba(0, 0, 0, 0.4)'
              }
            },
            {
              selector: '.related-file-node:hover',
              style: {
                'width': 8,
                'height': 8,
                'text-opacity': 1,
                'font-size': '9px',
                'box-shadow': '0 0 5px rgba(249, 115, 22, 0.9), 0 0 10px rgba(249, 115, 22, 0.6)'
              }
            },
            {
              selector: '.related-file-node.highlighted',
              style: {
                'width': 8,
                'height': 8,
                'opacity': 1,
                'box-shadow': '0 0 8px rgba(249, 115, 22, 1), 0 0 16px rgba(249, 115, 22, 0.8)'
              }
            },
            
            // ========== RELATED URL NODES (Deep Relationship Analysis) ==========
            {
              selector: '.related-url-node',
              style: {
                'background-color': '#A855F7',  // Neon Purple for domains/URLs
                'width': 4,
                'height': 4,
                'shape': 'ellipse',
                'label': 'data(shortLabel)',
                'color': '#A855F7',
                'font-size': '8px',
                'font-weight': '600',
                'text-opacity': 0.85,
                'text-outline-width': 2,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 8,
                'border-width': 1,
                'border-color': 'rgba(168, 85, 247, 0.8)',
                'box-shadow': '0 0 3px rgba(168, 85, 247, 0.6), 0 0 6px rgba(168, 85, 247, 0.3), 0 1px 3px rgba(0, 0, 0, 0.4)'
              }
            },
            {
              selector: '.related-url-node:hover',
              style: {
                'width': 8,
                'height': 8,
                'text-opacity': 1,
                'font-size': '9px',
                'box-shadow': '0 0 5px rgba(168, 85, 247, 0.9), 0 0 10px rgba(168, 85, 247, 0.6)'
              }
            },
            {
              selector: '.related-url-node.highlighted',
              style: {
                'width': 8,
                'height': 8,
                'opacity': 1,
                'box-shadow': '0 0 8px rgba(168, 85, 247, 1), 0 0 16px rgba(168, 85, 247, 0.8)'
              }
            },
            
            // ========== RELATED IP NODES (Deep Relationship Analysis) ==========
            {
              selector: '.related-ip-node',
              style: {
                'background-color': '#F97316',  // Neon Orange for malware-related IPs
                'width': 4,
                'height': 4,
                'shape': 'ellipse',
                'label': 'data(label)',  // Show full IP address, not just last octet
                'color': '#F97316',
                'font-size': '8px',
                'font-weight': '600',
                'text-opacity': 0.85,
                'text-outline-width': 2,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 8,
                'border-width': 1,
                'border-color': 'rgba(249, 115, 22, 0.8)',
                'box-shadow': '0 0 3px rgba(249, 115, 22, 0.6), 0 0 6px rgba(249, 115, 22, 0.3), 0 1px 3px rgba(0, 0, 0, 0.4)'
              }
            },
            {
              selector: '.related-ip-node:hover',
              style: {
                'width': 8,
                'height': 8,
                'text-opacity': 1,
                'font-size': '9px',
                'box-shadow': '0 0 5px rgba(249, 115, 22, 0.9), 0 0 10px rgba(249, 115, 22, 0.6)'
              }
            },
            {
              selector: '.related-ip-node.highlighted',
              style: {
                'width': 8,
                'height': 8,
                'opacity': 1,
                'box-shadow': '0 0 8px rgba(249, 115, 22, 1), 0 0 16px rgba(249, 115, 22, 0.8)'
              }
            },
            
            // ========== RELATED DOMAIN NODES (Deep Relationship Analysis) ==========
            {
              selector: '.related-domain-node',
              style: {
                'background-color': '#A855F7',  // Neon Purple for domains
                'width': 4,
                'height': 4,
                'shape': 'ellipse',
                'label': 'data(shortLabel)',
                'color': '#A855F7',
                'font-size': '8px',
                'font-weight': '600',
                'text-opacity': 0.85,
                'text-outline-width': 2,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 8,
                'border-width': 1,
                'border-color': 'rgba(168, 85, 247, 0.8)',
                'box-shadow': '0 0 3px rgba(168, 85, 247, 0.6), 0 0 6px rgba(168, 85, 247, 0.3), 0 1px 3px rgba(0, 0, 0, 0.4)'
              }
            },
            {
              selector: '.related-domain-node:hover',
              style: {
                'width': 8,
                'height': 8,
                'text-opacity': 1,
                'font-size': '9px',
                'box-shadow': '0 0 5px rgba(168, 85, 247, 0.9), 0 0 10px rgba(168, 85, 247, 0.6)'
              }
            },
            {
              selector: '.related-domain-node.highlighted',
              style: {
                'width': 8,
                'height': 8,
                'opacity': 1,
                'box-shadow': '0 0 8px rgba(168, 85, 247, 1), 0 0 16px rgba(168, 85, 247, 0.8)'
              }
            },
            
            // ========== USER NODES - 3D Cyber Nodes ==========
            {
              selector: '.user-node',
              style: {
                'background-color': '#FFD700',
                'width': 8,
                'height': 8,
                'shape': 'ellipse',
                'label': 'data(label)',
                'color': '#FFD700',
                'font-size': '10px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 12,
                'border-width': 2,
                'border-color': 'rgba(255, 215, 0, 0.8)',
                'box-shadow': '0 0 6px rgba(255, 215, 0, 0.7), 0 0 12px rgba(255, 215, 0, 0.4), 0 3px 8px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(255, 215, 0, 0.6)'
              }
            },
            {
              selector: '.user-node:hover',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 10px rgba(255, 215, 0, 0.9), 0 0 20px rgba(255, 215, 0, 0.6), 0 5px 12px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 215, 0, 0.7)'
              }
            },
            {
              selector: '.user-node:selected',
              style: {
                'width': 14,
                'height': 14,
                'text-opacity': 1,
                'font-size': '11px',
                'box-shadow': '0 0 14px rgba(255, 215, 0, 1), 0 0 28px rgba(255, 215, 0, 0.8), 0 0 42px rgba(255, 215, 0, 0.5), 0 6px 16px rgba(0, 0, 0, 0.7), inset 0 3px 6px rgba(255, 215, 0, 0.8)'
              }
            },
            
            // ========== EDGES - Clean and Simple ==========
            {
              selector: 'edge',
              style: {
                'width': 1.5,
                'line-color': 'rgba(94, 234, 212, 0.3)',
                'target-arrow-color': 'rgba(94, 234, 212, 0.3)',
                'target-arrow-shape': 'triangle',
                'target-arrow-size': 3,
                'curve-style': 'bezier',
                'opacity': 0.3,
                'label': '',  // No labels by default - cleaner
                'line-style': 'solid',
                'line-cap': 'round'
              }
            },
            {
              selector: '.transfer-edge',
              style: {
                'width': 1.5,
                'line-color': 'rgba(245, 158, 11, 0.45)',
                'target-arrow-color': 'rgba(245, 158, 11, 0.45)',
                'opacity': 0.45,
                'line-style': 'dashed',
                'line-dash-pattern': [5, 5]
              }
            },
            {
              selector: '.communication-edge',
              style: {
                'width': 2,
                'line-color': 'rgba(94, 234, 212, 0.5)',
                'target-arrow-color': 'rgba(94, 234, 212, 0.5)',
                'opacity': 0.5,
                'line-style': 'solid',
                'target-arrow-size': 4,
                'label': ''  // No label by default
              }
            },
            {
              selector: '.domain-ip-edge',
              style: {
                'width': 1.5,
                'line-color': 'rgba(6, 243, 255, 0.4)',
                'target-arrow-color': 'rgba(6, 243, 255, 0.4)',
                'opacity': 0.4,
                'line-style': 'dotted',
                'line-dash-pattern': [3, 3],
                'label': ''  // No label by default
              }
            },
            {
              selector: '.relationship-edge',
              style: {
                'width': 1,
                'line-color': 'rgba(249, 115, 22, 0.15)',  // Very faint for indirect relationships
                'target-arrow-color': 'rgba(249, 115, 22, 0.15)',
                'opacity': 0.15,  // Very faint to avoid clutter
                'line-style': 'dashed',
                'line-dash-pattern': [3, 3],
                'target-arrow-size': 2,
                'label': '',  // No label by default
                'curve-style': 'bezier'
              }
            },
            {
              selector: '.relationship-edge.highlighted',
              style: {
                'opacity': 0.8,
                'width': 2,
                'line-color': 'rgba(249, 115, 22, 0.8)',
                'target-arrow-color': 'rgba(249, 115, 22, 0.8)'
              }
            },
            {
              selector: 'edge:hover',
              style: {
                'opacity': 0.8,
                'width': 2,
                'line-color': 'rgba(94, 234, 212, 0.9)',
                'target-arrow-color': 'rgba(94, 234, 212, 0.9)',
                'target-arrow-size': 5,
                'label': 'data(hoverLabel)',  // Show label on hover only
                'label-text-opacity': 0.9,
                'label-font-size': '10px',
                'label-font-weight': '600',
                'label-color': '#5EEAD4',
                'label-background-color': 'rgba(2, 6, 16, 0.9)',
                'label-background-opacity': 0.85,
                'label-background-padding': '3px',
                'label-border-width': 1,
                'label-border-color': 'rgba(94, 234, 212, 0.5)'
              }
            }
          ],
          layout: layoutConfig
        });

          // Intel Card functionality
          const intelCard = document.getElementById('intel-card');
          const intelCardContent = document.getElementById('intel-card-content');
          const intelCardClose = document.getElementById('intel-card-close');
          
          // Close button handler
          if (intelCardClose) {
            intelCardClose.addEventListener('click', function() {
              intelCard.style.display = 'none';
              cy.elements().removeClass('selected');
            });
          }
          
          // Store threat intelligence data for Intel Card
          const threatIntel = {
            vtResults: {% if log_analysis_results.vt_results %}{{ log_analysis_results.vt_results | tojson }}{% else %}null{% endif %},
            abuseResults: {% if abuseipdb_results %}{{ abuseipdb_results | tojson }}{% else %}null{% endif %}
          };
          
          // Function to populate Intel Card
          function populateIntelCard(node) {
            const data = node.data();
            const nodeType = data.type || 'unknown';
            let html = '';
            
            // Header with type badge
            const typeColors = {
              'ip': '#00A8FF',
              'file': '#10FF88',
              'hash': '#A855F7',
              'domain': '#06F3FF',
              'user': '#FFD700',
              'event': '#5EEAD4'
            };
            const typeLabels = {
              'ip': 'IP ADDRESS',
              'file': 'FILE',
              'hash': 'HASH',
              'domain': 'DOMAIN',
              'user': 'USER',
              'event': 'LOG EVENT'
            };
            
            html += '<div style="margin-bottom: 12px;">';
            html += '<span style="background: ' + (typeColors[nodeType] || '#5EEAD4') + '; color: #060b16; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">';
            html += (typeLabels[nodeType] || 'ENTITY') + '</span></div>';
            
            // Main identifier
            html += '<div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(94, 234, 212, 0.2);">';
            html += '<div style="color: #5EEAD4; font-size: 11px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Identifier</div>';
            html += '<div style="color: #E2E8F0; font-size: 13px; font-family: \'Courier New\', monospace; font-weight: 600; word-break: break-all;">' + (data.label || 'N/A') + '</div>';
            html += '</div>';
            
            // Type-specific details
            if (nodeType === 'ip') {
              html += '<div style="margin-bottom: 8px;">';
              html += '<span style="color: #94A3B8; font-size: 11px;">Type:</span>';
              html += '<span style="color: #E2E8F0; font-size: 11px; margin-left: 8px;">' + (data.ip_type || 'Network') + '</span>';
              html += '</div>';
              
              // VirusTotal data
              if (threatIntel.vtResults && threatIntel.vtResults.ips) {
                const ip = data.label;
                const vt = threatIntel.vtResults.ips[ip];
                if (vt && typeof vt === 'object' && !vt.error) {
                  if (vt.malicious > 0) {
                    html += '<div style="margin-top: 8px; padding: 8px; background: rgba(255, 0, 64, 0.15); border-left: 3px solid #FF0040; border-radius: 4px;">';
                    html += '<div style="color: #FF0040; font-size: 11px; font-weight: 600;">⚠️ MALICIOUS: ' + vt.malicious + ' detections</div>';
                    html += '</div>';
                  } else if (vt.suspicious > 0) {
                    html += '<div style="margin-top: 8px; padding: 8px; background: rgba(255, 107, 0, 0.15); border-left: 3px solid #FF6B00; border-radius: 4px;">';
                    html += '<div style="color: #FF6B00; font-size: 11px; font-weight: 600;">⚠️ SUSPICIOUS: ' + vt.suspicious + ' detections</div>';
                    html += '</div>';
                  }
                }
              }
              
              // AbuseIPDB data
              if (threatIntel.abuseResults) {
                const ip = data.label;
                const abuse = threatIntel.abuseResults[ip];
                if (abuse && typeof abuse === 'object') {
                  html += '<div style="margin-top: 8px; padding: 8px; background: rgba(6, 11, 22, 0.5); border-radius: 4px;">';
                  html += '<div style="color: #94A3B8; font-size: 10px; margin-bottom: 4px;">AbuseIPDB</div>';
                  if (abuse.abuseScore && abuse.abuseScore !== 'None') {
                    const score = parseInt(abuse.abuseScore);
                    const scoreColor = score > 50 ? '#FF0040' : (score > 20 ? '#FF6B00' : '#10FF88');
                    html += '<div style="color: #E2E8F0; font-size: 11px;">Score: <span style="color: ' + scoreColor + '">' + abuse.abuseScore + '</span></div>';
                  }
                  if (abuse.country && abuse.country !== 'None') {
                    html += '<div style="color: #E2E8F0; font-size: 11px; margin-top: 4px;">Country: ' + abuse.country + '</div>';
                  }
                  if (abuse.isp && abuse.isp !== 'None') {
                    html += '<div style="color: #E2E8F0; font-size: 11px; margin-top: 4px;">ISP: ' + abuse.isp + '</div>';
                  }
                  html += '</div>';
                }
              }
            } else if (nodeType === 'file') {
              html += '<div style="margin-bottom: 8px;">';
              html += '<span style="color: #94A3B8; font-size: 11px;">Type:</span>';
              html += '<span style="color: #E2E8F0; font-size: 11px; margin-left: 8px;">' + (data.file_type || 'Unknown') + '</span>';
              html += '</div>';
              if (data.file_path) {
                html += '<div style="margin-top: 8px;">';
                html += '<span style="color: #94A3B8; font-size: 11px;">Path:</span>';
                html += '<div style="color: #E2E8F0; font-size: 10px; font-family: \'Courier New\', monospace; margin-top: 4px; word-break: break-all;">' + data.file_path + '</div>';
                html += '</div>';
              }
            } else if (nodeType === 'hash') {
              html += '<div style="margin-bottom: 8px;">';
              html += '<span style="color: #94A3B8; font-size: 11px;">Hash Type:</span>';
              html += '<span style="color: #E2E8F0; font-size: 11px; margin-left: 8px;">' + (data.hash_type || 'Unknown') + '</span>';
              html += '</div>';
              if (data.hash_value) {
                html += '<div style="margin-top: 8px;">';
                html += '<span style="color: #94A3B8; font-size: 11px;">Full Hash:</span>';
                html += '<div style="color: #E2E8F0; font-size: 10px; font-family: \'Courier New\', monospace; margin-top: 4px; word-break: break-all;">' + data.hash_value + '</div>';
                html += '</div>';
              }
            }
            
            intelCardContent.innerHTML = html;
            intelCard.style.display = 'block';
          }
          
          // Node hover - enhance glow
          cy.on('mouseover', 'node', function(evt) {
            const node = evt.target;
            // Labels are already visible, just enhance on hover
          });
          
          cy.on('mouseout', 'node', function(evt) {
            const node = evt.target;
            // Labels stay visible
          });
          
          // Highlight related nodes when main node is clicked
          function highlightRelatedNodes(mainNode) {
            // Remove previous highlights
            cy.elements().removeClass('highlighted');
            
            const mainNodeId = mainNode.id();
            
            // Find all related nodes (those with mainNodeId in their data)
            const relatedNodes = cy.nodes().filter(function(node) {
              const nodeData = node.data();
              return nodeData.mainNodeId === mainNodeId;
            });
            
            // Find all relationship edges connected to main node
            const relatedEdges = cy.edges().filter(function(edge) {
              const source = edge.source().id();
              const target = edge.target().id();
              return (source === mainNodeId || target === mainNodeId) && 
                     edge.hasClass('relationship-edge');
            });
            
            // Highlight related nodes and edges
            relatedNodes.addClass('highlighted');
            relatedEdges.addClass('highlighted');
            
            // Dim other nodes slightly
            cy.nodes().not(mainNode).not(relatedNodes).style('opacity', 0.3);
            cy.edges().not(relatedEdges).style('opacity', function(ele) {
              return ele.hasClass('relationship-edge') ? 0.05 : 0.1;
            });
          }
          
          function clearHighlights() {
            cy.elements().removeClass('highlighted');
            cy.nodes().style('opacity', 1);
            cy.edges().style('opacity', function(ele) {
              return ele.hasClass('relationship-edge') ? 0.15 : 0.3;
            });
          }
          
          // Node click event - show Intel Card and select node
          cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            const data = node.data();
            // Deselect all nodes first
            cy.elements().removeClass('selected');
            // Select clicked node
            node.addClass('selected');
            // Ensure label is visible for selected node
            node.style('text-opacity', 1);
            // Populate and show Intel Card
            populateIntelCard(node);
            
            // Highlight related nodes (for main IP/Domain/Hash nodes)
            if (data.type === 'ip' || data.type === 'domain' || data.type === 'hash') {
              highlightRelatedNodes(node);
            } else {
              clearHighlights();
            }
          });
          
          // Click on background to deselect
          cy.on('tap', function(evt) {
            // Clear highlights when clicking on background
            if (evt.target === cy) {
              clearHighlights();
            }
            if (evt.target === cy) {
              cy.elements().removeClass('selected');
              intelCard.style.display = 'none';
            }
          });
          
          // Enable panning, but disable mouse wheel zoom (buttons will work)
          cy.userPanningEnabled(true);
          cy.userZoomingEnabled(false);
          
          cy.minZoom(0.3);
          cy.maxZoom(3);
          
          // Zoom control functions - Simple and reliable approach
          // Store cy instance globally for button handlers
          window.cyInstance = cy;
          
          // Zoom In function
          window.cyZoomIn = function() {
            if (!cy) return;
            try {
              const currentZoom = cy.zoom();
              const newZoom = Math.min(currentZoom * 1.3, 3);
              cy.animate({
                zoom: newZoom,
                duration: 250,
                easing: 'ease-out'
              });
            } catch(e) {
              console.error('Zoom in error:', e);
            }
          };
          
          // Zoom Out function
          window.cyZoomOut = function() {
            if (!cy) return;
            try {
              const currentZoom = cy.zoom();
              const newZoom = Math.max(currentZoom / 1.3, 0.3);
              cy.animate({
                zoom: newZoom,
                duration: 250,
                easing: 'ease-out'
              });
            } catch(e) {
              console.error('Zoom out error:', e);
            }
          };
          
          // Zoom Reset function
          window.cyZoomReset = function() {
            if (!cy) return;
            try {
              cy.animate({
                fit: {
                  padding: 30
                },
                center: {},
                duration: 300,
                easing: 'ease-out'
              });
            } catch(e) {
              console.error('Zoom reset error:', e);
            }
          };
          
          // Allow page scrolling when mouse is over the graph
          // Only prevent zoom, but allow page scroll
          const cyContainerForScroll = cy.container();
          if (cyContainerForScroll) {
            // Allow vertical scrolling (page scroll) but prevent zoom
            cyContainerForScroll.addEventListener('wheel', function(evt) {
              // Always allow vertical scrolling for page scroll
              // Only prevent if it's a zoom gesture (Ctrl/Cmd + wheel or horizontal scroll)
              if (evt.ctrlKey || evt.metaKey || (Math.abs(evt.deltaX) > Math.abs(evt.deltaY))) {
                // Prevent zoom gestures
                evt.preventDefault();
              }
              // Otherwise, allow the event to bubble up for page scrolling
            }, { passive: false });
            
            cyContainerForScroll.addEventListener('mousewheel', function(evt) {
              // Same logic for older browsers
              if (evt.ctrlKey || evt.metaKey || (Math.abs(evt.wheelDeltaX) > Math.abs(evt.wheelDeltaY))) {
                evt.preventDefault();
              }
            }, { passive: false });
          }
          
          // Prevent zoom on double-click
          cy.on('dbltap', function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            return false;
          });
          
          console.log('Threat Constellation Map initialized successfully');
        } catch (error) {
          console.error('Error initializing Threat Constellation Map:', error);
        }
      }
      
      // Run initialization when DOM is ready
      function runInit() {
        try {
          initThreatConstellationMap();
        } catch(e) {
          console.error('Error running Threat Constellation Map init:', e);
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', runInit);
      } else {
        // DOM is already loaded, run immediately
        setTimeout(runInit, 100); // Small delay to ensure DOM is ready
      }
    })();
    {% else %}
    // No graph_data - log for debugging
    console.log('Threat Constellation Map: graph_data not provided');
    {% endif %}
  </script>

  {# Reusable Threat Constellation Map Initialization Function #}
  <script>
    // Reusable function to initialize Threat Constellation Map with provided graph_data
    function initThreatConstellationMapWithData(containerId, graphData) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error('Threat Constellation Map container not found:', containerId);
        return;
      }
      
      // Destroy existing instance if it exists
      if (window.cyInstance && window.cyInstance.container && window.cyInstance.container().id === containerId) {
        try {
          window.cyInstance.destroy();
          window.cyInstance = null;
        } catch (e) {
          console.warn('Error destroying existing cy instance:', e);
        }
      }
      
      // Create stars background
      const starsContainer = document.getElementById(containerId.replace('cy', 'cy-stars'));
      if (starsContainer) {
        starsContainer.innerHTML = ''; // Clear existing stars
        const numStars = 30;
        const containerWidth = container.offsetWidth || 800;
        const containerHeight = container.offsetHeight || 450;
        
        for (let i = 0; i < numStars; i++) {
          const star = document.createElement('div');
          const size = Math.random() * 1.5 + 0.5;
          const x = Math.random() * containerWidth;
          const y = Math.random() * containerHeight;
          const opacity = Math.random() * 0.4 + 0.2;
          const twinkle = Math.random() > 0.7;
          
          star.style.position = 'absolute';
          star.style.left = x + 'px';
          star.style.top = y + 'px';
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.backgroundColor = '#5EEAD4';
          star.style.borderRadius = '50%';
          star.style.opacity = opacity;
          star.style.boxShadow = `0 0 ${size * 2}px rgba(94, 234, 212, ${opacity * 0.5})`;
          star.style.pointerEvents = 'none';
          
          if (twinkle) {
            star.style.animation = `starTwinkle ${2 + Math.random() * 3}s ease-in-out infinite`;
          }
          
          starsContainer.appendChild(star);
        }
      }
      
      // Validate graph data
      if (!graphData || !Array.isArray(graphData)) {
        console.warn('Threat Constellation Map: Invalid graph data format', graphData);
        graphData = [];
      }
      
      if (graphData.length === 0) {
        console.warn('Threat Constellation Map: No graph data available - showing empty map');
        graphData = [{
          data: { id: 'no-data', label: 'No graph data available' },
          classes: 'central-node'
        }];
      }
      
      console.log('Initializing Threat Constellation Map with', graphData.length, 'elements');
      
      // Layout configuration
      const layoutConfig = {
        name: 'cose',
        animate: false,
        nodeDimensionsIncludeLabels: false,
        refresh: 20,
        fit: true,
        padding: 50,
        randomize: false,
        componentSpacing: 150,
        nodeRepulsion: 600000,
        edgeElasticity: 50,
        nestingFactor: 5,
        gravity: 50,
        numIter: 1000,
        initialTemp: 200,
        coolingFactor: 0.95,
        minTemp: 1.0
      };
      
      try {
        // Use the same styles as the main Threat Constellation Map
        // (We'll reuse the styles defined earlier, but need to ensure cytoscape is available)
        if (typeof cytoscape === 'undefined') {
          console.error('Cytoscape.js not loaded');
          return;
        }
        
        const cy = cytoscape({
          container: container,
          elements: graphData,
          style: [
            // Reuse the same styles - we'll need to copy them or make them global
            // For now, use a simplified version
            {
              selector: '.central-node',
              style: {
                'background-color': '#5EEAD4',
                'width': 12,
                'height': 12,
                'shape': 'ellipse',
                'label': 'data(label)',
                'color': '#5EEAD4',
                'font-size': '11px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 14,
                'border-width': 2,
                'border-color': 'rgba(94, 234, 212, 0.8)'
              }
            },
            {
              selector: 'node',
              style: {
                'background-color': 'data(color)',
                'width': 8,
                'height': 8,
                'shape': 'ellipse',
                'label': 'data(label)',
                'color': '#5EEAD4',
                'font-size': '10px',
                'font-weight': '600',
                'text-opacity': 0.9,
                'text-outline-width': 3,
                'text-outline-color': 'rgba(2, 6, 16, 0.95)',
                'text-valign': 'bottom',
                'text-halign': 'center',
                'text-margin-y': 12,
                'border-width': 2
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 1,
                'line-color': 'rgba(94, 234, 212, 0.3)',
                'target-arrow-color': 'rgba(94, 234, 212, 0.3)',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
                'opacity': 0.3
              }
            }
          ],
          layout: layoutConfig
        });
        
        // Store instance globally for potential cleanup
        window.cyInstance = cy;
        
        console.log('Threat Constellation Map initialized successfully for', containerId);
      } catch (error) {
        console.error('Error initializing Threat Constellation Map:', error);
      }
    </script>

  {# Email Forensics JavaScript - Phase 5 #}
  <script>
    (function() {
      // Initialize Feather icons
      if (typeof feather !== 'undefined') {
        feather.replace();
      }

      const dropZone = document.getElementById('email-drop-zone');
      const fileInput = document.getElementById('file-input');
      const reportContainer = document.getElementById('email-report-container');
      const closeReportBtn = document.getElementById('close-email-report');
      const toggleBodyPreviewBtn = document.getElementById('toggle-body-preview');

      if (!dropZone || !fileInput || !reportContainer) {
        console.warn('Email forensics elements not found');
        return;
      }

      // Attach click event listener to expand/collapse button immediately
      // Using event listener instead of onclick for better Chrome compatibility
      function attachBodyPreviewListener() {
        const btn = document.getElementById('toggle-body-preview');
        if (btn && !btn.hasAttribute('data-listener-attached')) {
          btn.setAttribute('data-listener-attached', 'true');
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('[Body Preview] Button clicked via event listener');
            if (typeof window.toggleBodyPreview === 'function') {
              window.toggleBodyPreview();
            } else {
              console.error('[Body Preview] toggleBodyPreview function not found');
            }
            return false;
          }, false);
          console.log('[Body Preview] Event listener attached successfully');
        }
      }

      // Attach listener immediately if button exists
      if (toggleBodyPreviewBtn) {
        // Try immediately
        attachBodyPreviewListener();
        // Also try after a short delay to ensure DOM is ready
        setTimeout(function() {
          attachBodyPreviewListener();
        }, 100);
      }
      
      // Also try after DOM is fully loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(attachBodyPreviewListener, 100);
        });
      } else {
        setTimeout(attachBodyPreviewListener, 100);
      }

      // Also attach when report is rendered (dynamic content)
      window.attachBodyPreviewListener = attachBodyPreviewListener;

      // Click handler - only if clicking directly on drop zone, not on buttons
      dropZone.addEventListener('click', function(e) {
        // Don't trigger file input if clicking on a button or form element
        if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.tagName === 'FORM' || e.target.closest('form') || e.target.tagName === 'INPUT' || e.target.closest('input')) {
          return;
        }
        fileInput.click();
      });

      // Drag & Drop handlers
      dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.borderColor = 'rgba(94, 234, 212, 0.8)';
        dropZone.style.background = 'rgba(94, 234, 212, 0.1)';
      });

      dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.borderColor = 'var(--accent-blue)';
        dropZone.style.background = 'rgba(10, 18, 32, 0.6)';
      });

      dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.borderColor = 'var(--accent-blue)';
        dropZone.style.background = 'rgba(10, 18, 32, 0.6)';

        // ========== STEP 1: DROP HANDLING (Allow all files, including Outlook drags) ==========
        // Check DataTransfer items and files
        const dataTransfer = e.dataTransfer;
        const items = dataTransfer.items;
        const files = dataTransfer.files;
        
        // Valid file handling - process any file that was dropped (including Outlook drags)
        if (files.length > 0) {
          const file = files[0];
          // More lenient validation - allow files without extension or with Outlook MIME types
          const fileName = (file.name || '').toLowerCase();
          const fileType = file.type || '';
          
          // Check if it's a .msg or .eml file by extension or MIME type
          const isMsgFile = fileName.endsWith('.msg') || 
                           fileType.includes('ms-outlook') || 
                           fileType.includes('x-msmsg') ||
                           fileName.includes('.msg');
          const isEmlFile = fileName.endsWith('.eml') || 
                           fileType.includes('message/rfc822') ||
                           fileName.includes('.eml');
          
          // If no clear extension but file exists, try to process (might be Outlook drag)
          if (!isMsgFile && !isEmlFile && fileName && fileName !== '') {
            alert('Please select a .msg or .eml file');
            return;
          }
          
          // If file has no name, assign a default name based on type
          if (!file.name || file.name === '') {
            if (fileType.includes('ms-outlook') || fileType.includes('x-msmsg')) {
              file.name = 'email.msg';
            } else if (fileType.includes('message/rfc822')) {
              file.name = 'email.eml';
            } else {
              file.name = 'email.msg'; // Default to .msg for Outlook drags
            }
            console.log('[Drop] Assigned default name:', file.name);
          }
          
          handleFile(file);
        } else if (items && items.length > 0) {
          // Try to get file from items (for Outlook drags that don't show in files array)
          console.log('[Drop] No files array, trying to get from items');
          for (let i = 0; i < items.length; i++) {
            if (items[i].kind === 'file') {
              const file = items[i].getAsFile();
              if (file) {
                console.log('[Drop] Got file from items:', file.name, file.size);
                // Assign default name if missing
                if (!file.name || file.name === '') {
                  file.name = 'email.msg';
                }
                handleFile(file);
                return;
              }
            }
          }
          console.warn('[Drop] No valid file found in items');
        } else {
          console.warn('[Drop] No files or items in drop event');
        }
      });

      // File input change handler
      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      // Close report handler
      if (closeReportBtn) {
        closeReportBtn.addEventListener('click', function() {
          reportContainer.style.display = 'none';
        });
      }

      // Helper function to display error in drop zone
      function showErrorInDropZone(dropZone, errorMessage) {
        dropZone.innerHTML = `
          <div style="
            padding: 24px;
            text-align: center;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
          ">
            <i data-feather="alert-circle" style="width: 48px; height: 48px; color: #EF4444; margin-bottom: 16px;"></i>
            <h3 style="color: #EF4444; margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">Processing Failed</h3>
            <p style="color: var(--text-secondary); margin: 0 0 16px 0; font-size: 14px; line-height: 1.5;">${errorMessage}</p>
            <button onclick="location.reload()" style="
              padding: 8px 16px;
              background: rgba(239, 68, 68, 0.2);
              border: 1px solid rgba(239, 68, 68, 0.5);
              border-radius: 4px;
              color: #EF4444;
              cursor: pointer;
              font-size: 13px;
            ">Try Again</button>
          </div>
        `;
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }

      // Handle file upload and analysis
      function handleFile(file) {
        // More lenient validation - allow files without extension or with Outlook MIME types
        const fileName = (file.name || '').toLowerCase();
        const fileType = file.type || '';
        
        // Check if it's a .msg or .eml file by extension or MIME type
        const isMsgFile = fileName.endsWith('.msg') || 
                         fileType.includes('ms-outlook') || 
                         fileType.includes('x-msmsg') ||
                         fileName.includes('.msg');
        const isEmlFile = fileName.endsWith('.eml') || 
                         fileType.includes('message/rfc822') ||
                         fileName.includes('.eml');
        
        // If no clear extension but file exists, try to process (might be Outlook drag)
        if (!isMsgFile && !isEmlFile && fileName && fileName !== '') {
          alert('Please select a .msg or .eml file');
          return;
        }
        
        // If file has no name, assign a default name based on type
        if (!file.name || file.name === '') {
          if (fileType.includes('ms-outlook') || fileType.includes('x-msmsg')) {
            file.name = 'email.msg';
          } else if (fileType.includes('message/rfc822')) {
            file.name = 'email.eml';
          } else {
            file.name = 'email.msg'; // Default to .msg for Outlook drags
          }
          console.log('[File Handler] Assigned default name:', file.name);
        }

        // Show processing state
        const originalHTML = dropZone.innerHTML;
        dropZone.innerHTML = '<i data-feather="loader" style="width: 48px; height: 48px; color: var(--accent-blue); margin-bottom: 16px; animation: spin 1s linear infinite;"></i><h3 style="color: var(--text-primary); margin: 0;">Processing...</h3><p style="color: var(--text-secondary); margin: 8px 0 0 0;">Analyzing email content</p>';
        if (typeof feather !== 'undefined') {
          feather.replace();
        }

        // Create FormData
        const formData = new FormData();
        formData.append('file', file);

        // Send AJAX request
        // NOTE: Do NOT set Content-Type header when using FormData
        // The browser will automatically set it with the correct multipart boundary
        fetch('/analyze_email', {
          method: 'POST',
          body: formData
          // Explicitly NOT setting headers - browser handles Content-Type for FormData
        })
        .then(response => {
          // Check if response is OK before parsing JSON
          if (!response.ok) {
            // Try to get error message from response
            return response.json().then(data => {
              // Handle null or undefined data
              if (data && data.error) {
                throw new Error(data.error);
              }
              throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }).catch(() => {
              // If JSON parsing fails, throw with status
              throw new Error(`Server error: ${response.status} ${response.statusText}`);
            });
          }
          return response.json();
        })
        .then(data => {
          // Restore drop zone
          dropZone.innerHTML = originalHTML;
          if (typeof feather !== 'undefined') {
            feather.replace();
          }

          // Handle null or undefined response
          if (!data) {
            showErrorInDropZone(dropZone, 'Server returned an empty response. Please try again.');
            return;
          }

          // Check for error in response
          if (data.error) {
            // Display error in drop zone with red alert styling
            showErrorInDropZone(dropZone, data.error);
            return;
          }

          // Render report
          renderReport(data);
        })
        .catch(error => {
          // Restore drop zone
          dropZone.innerHTML = originalHTML;
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
          
          // Display error in drop zone with red alert styling
          const errorMessage = error.message || 'An unexpected error occurred while processing the file.';
          showErrorInDropZone(dropZone, errorMessage);
        });
      }

      // Render the analysis report
      function renderReport(data) {
        // Show report container
        reportContainer.style.display = 'block';

        // Update verdict banner
        const verdictBanner = document.getElementById('email-verdict-banner');
        const verdictText = document.getElementById('email-verdict-text');
        const scoreText = document.getElementById('email-score-text');

        // Use .includes() to handle verdict strings like "MALICIOUS (Spoofing)" or "SUSPICIOUS (PDF Polyglot)"
        if (data.verdict && (data.verdict.includes('MALICIOUS') || data.score >= 100)) {
          verdictBanner.style.background = 'rgba(239, 68, 68, 0.2)';
          verdictBanner.style.border = '2px solid rgba(239, 68, 68, 0.6)';
          verdictText.textContent = `⚠️ ${data.verdict}`;
          verdictText.style.color = '#EF4444';
        } else if (data.verdict && (data.verdict.includes('SUSPICIOUS') || data.score >= 50)) {
          verdictBanner.style.background = 'rgba(245, 158, 11, 0.2)';
          verdictBanner.style.border = '2px solid rgba(245, 158, 11, 0.6)';
          verdictText.textContent = `⚠️ ${data.verdict}`;
          verdictText.style.color = '#F59E0B';
        } else if (data.verdict && data.verdict.includes('UNKNOWN')) {
          verdictBanner.style.background = 'rgba(148, 163, 184, 0.2)';
          verdictBanner.style.border = '2px solid rgba(148, 163, 184, 0.6)';
          verdictText.textContent = `❓ ${data.verdict}`;
          verdictText.style.color = '#94A3B8';
        } else {
          verdictBanner.style.background = 'rgba(34, 197, 94, 0.2)';
          verdictBanner.style.border = '2px solid rgba(34, 197, 94, 0.6)';
          verdictText.textContent = '✓ CLEAN';
          verdictText.style.color = '#22C55E';
        }

        scoreText.textContent = `Threat Score: ${data.score} points`;
        
        // Display score reasons
        const scoreReasonsContainer = document.getElementById('score-reasons-container');
        if (scoreReasonsContainer && data.score_reasons && data.score_reasons.length > 0) {
          scoreReasonsContainer.style.display = 'block';
          const scoreReasonsList = document.getElementById('score-reasons-list');
          scoreReasonsList.innerHTML = data.score_reasons.map(reason => {
            const isPositive = reason.startsWith('+');
            const isNegative = reason.startsWith('-');
            const color = isPositive ? '#EF4444' : isNegative ? '#22C55E' : 'var(--text-secondary)';
            const icon = isPositive ? 'arrow-up' : isNegative ? 'arrow-down' : 'minus';
            return `<div style="display: flex; align-items: start; gap: 8px; padding: 8px; margin-bottom: 6px; background: rgba(10, 18, 32, 0.5); border-left: 3px solid ${color}; border-radius: 4px;">
              <i data-feather="${icon}" style="width: 14px; height: 14px; color: ${color}; flex-shrink: 0; margin-top: 2px;"></i>
              <span style="color: var(--text-primary); font-size: 12px; line-height: 1.5;">${escapeHtml(reason)}</span>
            </div>`;
          }).join('');
          if (typeof feather !== 'undefined') {
            setTimeout(() => feather.replace(), 100);
          }
        } else if (scoreReasonsContainer) {
          scoreReasonsContainer.style.display = 'none';
        }
        
        // Display verdict reasons
        const verdictReasonsContainer = document.getElementById('verdict-reasons-container');
        if (verdictReasonsContainer && data.verdict_reasons && data.verdict_reasons.length > 0) {
          verdictReasonsContainer.style.display = 'block';
          const verdictReasonsList = document.getElementById('verdict-reasons-list');
          verdictReasonsList.innerHTML = data.verdict_reasons.map(reason => {
            const isMalicious = data.verdict && data.verdict.includes('MALICIOUS');
            const color = isMalicious ? '#EF4444' : data.verdict && data.verdict.includes('SUSPICIOUS') ? '#F59E0B' : '#22C55E';
            return `<div style="display: flex; align-items: start; gap: 8px; padding: 8px; margin-bottom: 6px; background: rgba(10, 18, 32, 0.5); border-left: 3px solid ${color}; border-radius: 4px;">
              <i data-feather="alert-circle" style="width: 14px; height: 14px; color: ${color}; flex-shrink: 0; margin-top: 2px;"></i>
              <span style="color: var(--text-primary); font-size: 12px; line-height: 1.5;">${escapeHtml(reason)}</span>
            </div>`;
          }).join('');
          if (typeof feather !== 'undefined') {
            setTimeout(() => feather.replace(), 100);
          }
        } else if (verdictReasonsContainer) {
          verdictReasonsContainer.style.display = 'none';
        }

        // Display warning if file was corrupted but partial data extracted
        if (data.warning) {
          const warningBanner = document.createElement('div');
          warningBanner.style.cssText = `
            padding: 16px;
            margin-bottom: 20px;
            background: rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.5);
            border-radius: 8px;
            color: #F59E0B;
          `;
          warningBanner.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
              <i data-feather="alert-triangle" style="width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px;"></i>
              <div>
                <strong style="display: block; margin-bottom: 4px; font-size: 14px;">⚠️ File Corruption Detected</strong>
                <p style="margin: 0; font-size: 13px; opacity: 0.9; line-height: 1.5;">${data.warning}</p>
              </div>
            </div>
          `;
          verdictBanner.parentNode.insertBefore(warningBanner, verdictBanner.nextSibling);
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        }

        // Display spoofing warning if extension mismatch detected
        if (data.spoofing_warning) {
          const spoofingBanner = document.createElement('div');
          spoofingBanner.style.cssText = `
            padding: 16px;
            margin-bottom: 20px;
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.6);
            border-radius: 8px;
            color: #EF4444;
            animation: pulse 2s infinite;
          `;
          spoofingBanner.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
              <i data-feather="alert-circle" style="width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px;"></i>
              <div>
                <strong style="display: block; margin-bottom: 4px; font-size: 14px; font-weight: 700;">🚨 EXTENSION MISMATCH DETECTED</strong>
                <p style="margin: 0; font-size: 13px; opacity: 0.9; line-height: 1.5;">${data.spoofing_warning}</p>
              </div>
            </div>
          `;
          verdictBanner.parentNode.insertBefore(spoofingBanner, verdictBanner.nextSibling);
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        }

        // Update metadata
        document.getElementById('email-from').textContent = data.headers.From || '—';
        document.getElementById('email-to').textContent = data.headers.To || '—';
        document.getElementById('email-subject').textContent = data.headers.Subject || '—';
        document.getElementById('email-date').textContent = data.headers.Date || '—';

        // Update sender domain analysis
        const senderDomainSection = document.getElementById('sender-domain-section');
        const senderDomainInfo = document.getElementById('sender-domain-info');
        if (data.sender_domain && data.sender_domain.domain) {
          senderDomainSection.style.display = 'block';
          const domain = data.sender_domain;
          const malicious = domain.malicious || 0;
          const suspicious = domain.suspicious || 0;
          const harmless = domain.harmless || 0;
          const total = domain.total || 0;
          
          let domainColor = '#22C55E'; // Green for clean
          let domainIcon = 'check-circle';
          let statusText = 'Clean';
          let borderColor = '#22C55E';
          
          if (malicious > 0) {
            domainColor = '#EF4444';
            domainIcon = 'alert-triangle';
            statusText = 'MALICIOUS';
            borderColor = '#EF4444';
          } else if (suspicious > 0) {
            domainColor = '#F59E0B';
            domainIcon = 'alert-circle';
            statusText = 'SUSPICIOUS';
            borderColor = '#F59E0B';
          } else if (harmless > 0) {
            domainColor = '#22C55E';
            domainIcon = 'check-circle';
            statusText = 'CLEAN';
          } else if (domain.error) {
            domainColor = '#94A3B8';
            domainIcon = 'help-circle';
            statusText = 'UNKNOWN';
          }
          
          const domainCommunityScore = parseInt(domain.community_score || 0);
          const domainCommunityLink = domain.vt_community_link ? `<a href="${domain.vt_community_link}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; font-size: 12px; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;"><i data-feather="external-link" style="width: 14px; height: 14px;"></i> View Community</a>` : '';
          
          // Override status if community_score is negative
          if (domainCommunityScore < 0) {
            domainColor = '#EF4444';
            domainIcon = 'alert-triangle';
            statusText = 'MALICIOUS';
            borderColor = '#EF4444';
          }
          
          senderDomainInfo.style.border = `2px solid ${borderColor}`;
          senderDomainInfo.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
              <i data-feather="${domainIcon}" style="width: 20px; height: 20px; color: ${domainColor};"></i>
              <strong style="color: ${domainColor}; font-size: 16px; font-weight: 700;">${statusText}</strong>
              ${domainCommunityLink}
              <span style="color: var(--text-secondary); font-size: 14px; margin-left: auto;">Domain: ${escapeHtml(domain.domain)}</span>
            </div>
            ${domain.error ? `
              <div style="margin-top: 8px; padding: 8px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">
                <span style="color: var(--text-secondary); font-size: 12px;">Error: ${escapeHtml(domain.error)}</span>
              </div>
            ` : total > 0 ? `
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 12px;">
                <div style="text-align: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">
                  <div style="color: #EF4444; font-size: 18px; font-weight: 700;">${malicious}</div>
                  <div style="color: var(--text-secondary); font-size: 11px;">Malicious</div>
                </div>
                <div style="text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 4px;">
                  <div style="color: #F59E0B; font-size: 18px; font-weight: 700;">${suspicious}</div>
                  <div style="color: var(--text-secondary); font-size: 11px;">Suspicious</div>
                </div>
                <div style="text-align: center; padding: 8px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">
                  <div style="color: #22C55E; font-size: 18px; font-weight: 700;">${harmless}</div>
                  <div style="color: var(--text-secondary); font-size: 11px;">Harmless</div>
                </div>
                <div style="text-align: center; padding: 8px; background: ${domainCommunityScore < 0 ? 'rgba(239, 68, 68, 0.1)' : domainCommunityScore > 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(148, 163, 184, 0.1)'}; border-radius: 4px;">
                  <div style="color: ${domainCommunityScore < 0 ? '#EF4444' : domainCommunityScore > 0 ? '#22C55E' : 'var(--text-secondary)'}; font-size: 18px; font-weight: 700;">${domainCommunityScore}</div>
                  <div style="color: var(--text-secondary); font-size: 11px;">Community</div>
                </div>
                <div style="text-align: center; padding: 8px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">
                  <div style="color: var(--text-secondary); font-size: 18px; font-weight: 700;">${total}</div>
                  <div style="color: var(--text-secondary); font-size: 11px;">Total Scans</div>
                </div>
              </div>
            ` : `
              <div style="margin-top: 8px; padding: 8px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">
                <span style="color: var(--text-secondary); font-size: 12px;">Domain not found in VirusTotal database (unknown domain)</span>
              </div>
            `}
          `;
          
          // Re-initialize feather icons for the new domain icon
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        } else {
          senderDomainSection.style.display = 'none';
        }

        // Update DKIM analysis
        const dkimSection = document.getElementById('dkim-section');
        const dkimInfo = document.getElementById('dkim-info');
        console.log('[DKIM] Checking DKIM data:', data.dkim_info);
        if (data.dkim_info) {
          dkimSection.style.display = 'block';
          const dkim = data.dkim_info;
          const securityLevel = dkim.security_level || 'Unknown';
          const selectorsFound = dkim.selectors_found || [];
          const issues = dkim.issues || [];
          const recommendations = dkim.recommendations || [];
          
          let dkimColor = '#94A3B8'; // Gray for unknown
          let dkimIcon = 'help-circle';
          let borderColor = '#94A3B8';
          
          if (securityLevel === 'High') {
            dkimColor = '#22C55E'; // Green
            dkimIcon = 'check-circle';
            borderColor = '#22C55E';
          } else if (securityLevel === 'Medium') {
            dkimColor = '#F59E0B'; // Orange
            dkimIcon = 'alert-circle';
            borderColor = '#F59E0B';
          } else if (securityLevel === 'Low') {
            dkimColor = '#EF4444'; // Red
            dkimIcon = 'alert-triangle';
            borderColor = '#EF4444';
          } else if (securityLevel === 'None') {
            dkimColor = '#EF4444'; // Red
            dkimIcon = 'x-circle';
            borderColor = '#EF4444';
          } else if (securityLevel === 'Unknown') {
            dkimColor = '#94A3B8'; // Gray
            dkimIcon = 'help-circle';
            borderColor = '#94A3B8';
          }
          
          dkimInfo.style.border = `2px solid ${borderColor}`;
          
          const dkimDomain = dkim.domain || 'Unknown';
          
          // Check if this is a wrapper email with deep header extraction
          const isWrapperEmail = dkim.is_wrapper_email || false;
          const deepExtractionUsed = dkim.deep_extraction_used || false;
          const wrapperInfo = dkim.wrapper_info || {};
          
          let dkimHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
              <i data-feather="${dkimIcon}" style="width: 20px; height: 20px; color: ${dkimColor};"></i>
              <strong style="color: ${dkimColor}; font-size: 16px; font-weight: 700;">Security Level: ${securityLevel.toUpperCase()}</strong>
              <span style="color: var(--text-secondary); font-size: 14px; margin-left: auto;">Domain: ${escapeHtml(dkimDomain)}</span>
            </div>
          `;
          
          // Display wrapper email information if detected
          if (isWrapperEmail && deepExtractionUsed) {
            dkimHTML += `
              <div style="margin-top: 12px; margin-bottom: 12px; padding: 12px; background: rgba(59, 130, 246, 0.15); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <i data-feather="info" style="width: 18px; height: 18px; color: var(--accent-blue);"></i>
                  <strong style="color: var(--accent-blue); font-size: 14px; font-weight: 600;">Wrapper/Report Email Detected</strong>
                </div>
                <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.6;">
                  <p style="margin: 0 0 8px 0;">
                    This email is a wrapper/report containing an embedded phishing email as an attachment. 
                    The DKIM validation below is performed on the <strong style="color: var(--text-primary);">embedded email's domain</strong>, not the wrapper.
                  </p>
                  ${wrapperInfo.wrapper_subject ? `
                    <div style="margin-top: 6px; padding: 6px; background: rgba(0, 0, 0, 0.1); border-radius: 4px; font-family: monospace; font-size: 12px;">
                      <strong>Wrapper Subject:</strong> ${escapeHtml(wrapperInfo.wrapper_subject)}
                    </div>
                  ` : ''}
                  ${wrapperInfo.extraction_method ? `
                    <div style="margin-top: 6px; font-size: 12px; color: var(--text-secondary);">
                      <strong>Extraction Method:</strong> ${escapeHtml(wrapperInfo.extraction_method)}
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }
          
          if (dkim.error) {
            dkimHTML += `
              <div style="margin-top: 8px; padding: 8px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">
                <span style="color: var(--text-secondary); font-size: 12px;">Error: ${escapeHtml(dkim.error)}</span>
              </div>
            `;
          } else {
            if (selectorsFound.length > 0) {
              dkimHTML += `
                <div style="margin-top: 12px;">
                  <strong style="color: var(--text-primary); font-size: 14px; display: block; margin-bottom: 8px;">DKIM Selectors Found (${selectorsFound.length}):</strong>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${selectorsFound.map(selector => `
                      <span style="
                        padding: 4px 12px;
                        background: rgba(94, 234, 212, 0.1);
                        border: 1px solid rgba(94, 234, 212, 0.3);
                        border-radius: 4px;
                        color: var(--accent-blue);
                        font-size: 12px;
                        font-family: monospace;
                      ">${escapeHtml(selector)}</span>
                    `).join('')}
                  </div>
                </div>
              `;
            }
            
            if (issues.length > 0) {
              dkimHTML += `
                <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid #EF4444;">
                  <strong style="color: #EF4444; font-size: 14px; display: block; margin-bottom: 8px;">Issues Found:</strong>
                  <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 13px;">
                    ${issues.map(issue => `<li style="margin-bottom: 4px;">${escapeHtml(issue)}</li>`).join('')}
                  </ul>
                </div>
              `;
            }
            
            if (recommendations.length > 0) {
              dkimHTML += `
                <div style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 4px; border-left: 3px solid var(--accent-blue);">
                  <strong style="color: var(--accent-blue); font-size: 14px; display: block; margin-bottom: 8px;">Recommendations:</strong>
                  <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 13px;">
                    ${recommendations.map(rec => `<li style="margin-bottom: 4px;">${escapeHtml(rec)}</li>`).join('')}
                  </ul>
                </div>
              `;
            }
            
            if (selectorsFound.length === 0) {
              dkimHTML += `
                <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">
                  <span style="color: var(--text-secondary); font-size: 13px;">No DKIM selectors found for this domain. DKIM is not configured.</span>
                </div>
              `;
            }
            
            // Show DKIM signature info if available from embedded headers
            if (dkim.dkim_signature_in_headers !== undefined) {
              if (dkim.dkim_signature_in_headers) {
                dkimHTML += `
                  <div style="margin-top: 12px; padding: 12px; background: rgba(94, 234, 212, 0.1); border-radius: 4px; border-left: 3px solid #5EEAD4;">
                    <strong style="color: #5EEAD4; font-size: 14px; display: block; margin-bottom: 8px;">DKIM Signature in Headers:</strong>
                    <div style="font-family: monospace; font-size: 11px; color: var(--text-secondary); word-break: break-all; padding: 8px; background: rgba(0, 0, 0, 0.1); border-radius: 4px;">
                      ${escapeHtml(dkim.dkim_signature_preview || 'Present')}
                    </div>
                  </div>
                `;
              } else {
                dkimHTML += `
                  <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid #EF4444;">
                    <strong style="color: #EF4444; font-size: 14px;">DKIM Signature Missing:</strong>
                    <span style="color: var(--text-secondary); font-size: 13px; display: block; margin-top: 4px;">
                      No DKIM-Signature header found in the embedded email headers. This indicates the email may not be properly signed.
                    </span>
                  </div>
                `;
              }
            }
          }
          
          dkimInfo.innerHTML = dkimHTML;
          
          // Re-initialize feather icons for DKIM
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        } else {
          console.log('[DKIM] No DKIM info found in data');
          dkimSection.style.display = 'none';
        }

        // Display Spoofing Analysis
        const spoofingSection = document.getElementById('spoofing-analysis-section');
        const spoofingInfo = document.getElementById('spoofing-analysis-info');
        if (data.spoofing_analysis && data.spoofing_analysis.sender_domain) {
          spoofingSection.style.display = 'block';
          const spoof = data.spoofing_analysis;
          const overallRisk = spoof.overall_risk || 'Unknown';
          
          // Determine risk color
          let riskColor = '#94A3B8';
          let riskIcon = 'help-circle';
          if (overallRisk.includes('CRITICAL')) {
            riskColor = '#EF4444';
            riskIcon = 'alert-triangle';
          } else if (overallRisk.includes('HIGH')) {
            riskColor = '#F59E0B';
            riskIcon = 'alert-circle';
          } else if (overallRisk.includes('MEDIUM')) {
            riskColor = '#F59E0B';
            riskIcon = 'alert-circle';
          } else if (overallRisk.includes('LOW')) {
            riskColor = '#22C55E';
            riskIcon = 'check-circle';
          }
          
          let spoofingHTML = '<div style="margin-bottom: 16px; padding: 12px; background: ' + (overallRisk.includes('CRITICAL') || overallRisk.includes('HIGH') ? 'rgba(239, 68, 68, 0.1)' : overallRisk.includes('MEDIUM') ? 'rgba(245, 158, 11, 0.1)' : 'rgba(34, 197, 94, 0.1)') + '; border: 2px solid ' + riskColor + '; border-radius: 6px;">';
          spoofingHTML += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">';
          spoofingHTML += '<i data-feather="' + riskIcon + '" style="width: 20px; height: 20px; color: ' + riskColor + ';"></i>';
          spoofingHTML += '<strong style="color: ' + riskColor + '; font-size: 16px;">Overall Spoofing Risk: ' + escapeHtml(overallRisk) + '</strong>';
          spoofingHTML += '<span style="color: var(--text-secondary); font-size: 12px; margin-left: auto;">Domain: ' + escapeHtml(spoof.sender_domain) + '</span>';
          spoofingHTML += '</div>';
          
          // SPF Status
          if (spoof.spf) {
            const spfExists = spoof.spf.exists || false;
            const spfLevel = spoof.spf.security_level || 'None';
            const spfColor = spfExists && spfLevel !== 'None' && spfLevel !== 'Low' ? '#22C55E' : '#EF4444';
            spoofingHTML += '<div style="margin-top: 12px; padding: 10px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border-left: 3px solid ' + spfColor + ';">';
            spoofingHTML += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">';
            spoofingHTML += '<i data-feather="' + (spfExists ? 'check-circle' : 'x-circle') + '" style="width: 16px; height: 16px; color: ' + spfColor + ';"></i>';
            spoofingHTML += '<strong style="color: var(--text-primary); font-size: 14px;">SPF:</strong>';
            spoofingHTML += '<span style="color: ' + spfColor + '; font-size: 13px; margin-left: 8px;">' + (spfExists ? 'Configured (' + escapeHtml(spfLevel) + ')' : 'Not Configured') + '</span>';
            spoofingHTML += '</div>';
            if (spoof.spf.record) {
              spoofingHTML += '<div style="font-family: monospace; font-size: 11px; color: var(--text-secondary); margin-top: 6px; padding: 6px; background: rgba(0, 0, 0, 0.05); border-radius: 3px; word-break: break-all;">' + escapeHtml(spoof.spf.record.substring(0, 150)) + (spoof.spf.record.length > 150 ? '...' : '') + '</div>';
            }
            if (spoof.spf.all_mechanism) {
              spoofingHTML += '<div style="margin-top: 6px; font-size: 12px; color: var(--text-secondary);">All Mechanism: <code style="background: rgba(0, 0, 0, 0.1); padding: 2px 6px; border-radius: 3px;">' + escapeHtml(spoof.spf.all_mechanism) + '</code></div>';
            }
            if (spoof.spf.all_mechanism === '-all') {
              spoofingHTML += '<div style="margin-top: 4px; font-size: 11px; color: #22C55E;">✓ Hard Fail (-all) - Good protection</div>';
            } else if (spoof.spf.all_mechanism === '~all') {
              spoofingHTML += '<div style="margin-top: 4px; font-size: 11px; color: #F59E0B;">⚠️ Soft Fail (~all) - Less secure</div>';
            }
            spoofingHTML += '</div>';
          }
          
          // DKIM Status
          if (spoof.dkim) {
            const dkimExists = spoof.dkim.exists || false;
            const dkimLevel = spoof.dkim.security_level || 'None';
            const dkimColor = dkimExists && dkimLevel !== 'None' && dkimLevel !== 'Low' ? '#22C55E' : '#EF4444';
            spoofingHTML += '<div style="margin-top: 12px; padding: 10px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border-left: 3px solid ' + dkimColor + ';">';
            spoofingHTML += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">';
            spoofingHTML += '<i data-feather="' + (dkimExists ? 'check-circle' : 'x-circle') + '" style="width: 16px; height: 16px; color: ' + dkimColor + ';"></i>';
            spoofingHTML += '<strong style="color: var(--text-primary); font-size: 14px;">DKIM:</strong>';
            spoofingHTML += '<span style="color: ' + dkimColor + '; font-size: 13px; margin-left: 8px;">' + (dkimExists ? 'Configured (' + escapeHtml(dkimLevel) + ')' : 'Not Configured') + '</span>';
            spoofingHTML += '</div>';
            if (spoof.dkim.selectors_found && spoof.dkim.selectors_found.length > 0) {
              spoofingHTML += '<div style="margin-top: 6px; font-size: 12px; color: var(--text-secondary);">Selectors: ' + spoof.dkim.selectors_found.map(s => '<code style="background: rgba(0, 0, 0, 0.1); padding: 2px 6px; border-radius: 3px; margin-right: 4px;">' + escapeHtml(s) + '</code>').join('') + '</div>';
            }
            spoofingHTML += '</div>';
          }
          
          // DMARC Status
          if (spoof.dmarc) {
            const dmarcExists = spoof.dmarc.exists || false;
            const dmarcPolicy = spoof.dmarc.policy || 'none';
            const dmarcLevel = spoof.dmarc.security_level || 'None';
            const dmarcColor = dmarcExists && dmarcPolicy === 'reject' ? '#22C55E' : dmarcExists && dmarcPolicy === 'quarantine' ? '#F59E0B' : '#EF4444';
            spoofingHTML += '<div style="margin-top: 12px; padding: 10px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border-left: 3px solid ' + dmarcColor + ';">';
            spoofingHTML += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">';
            spoofingHTML += '<i data-feather="' + (dmarcExists ? 'check-circle' : 'x-circle') + '" style="width: 16px; height: 16px; color: ' + dmarcColor + ';"></i>';
            spoofingHTML += '<strong style="color: var(--text-primary); font-size: 14px;">DMARC:</strong>';
            spoofingHTML += '<span style="color: ' + dmarcColor + '; font-size: 13px; margin-left: 8px;">' + (dmarcExists ? 'Configured (Policy: ' + escapeHtml(dmarcPolicy.toUpperCase()) + ')' : 'Not Configured') + '</span>';
            spoofingHTML += '</div>';
            if (dmarcPolicy === 'reject') {
              spoofingHTML += '<div style="margin-top: 4px; font-size: 11px; color: #22C55E;">✓ Policy: REJECT - Best protection</div>';
            } else if (dmarcPolicy === 'quarantine') {
              spoofingHTML += '<div style="margin-top: 4px; font-size: 11px; color: #F59E0B;">⚠️ Policy: QUARANTINE - Should be REJECT</div>';
            } else if (dmarcPolicy === 'none') {
              spoofingHTML += '<div style="margin-top: 4px; font-size: 11px; color: #EF4444;">✗ Policy: NONE - No protection</div>';
            }
            if (spoof.dmarc.record) {
              spoofingHTML += '<div style="font-family: monospace; font-size: 11px; color: var(--text-secondary); margin-top: 6px; padding: 6px; background: rgba(0, 0, 0, 0.05); border-radius: 3px; word-break: break-all;">' + escapeHtml(spoof.dmarc.record.substring(0, 150)) + (spoof.dmarc.record.length > 150 ? '...' : '') + '</div>';
            }
            spoofingHTML += '</div>';
          }
          
          // Issues and Recommendations
          if (spoof.issues && spoof.issues.length > 0) {
            spoofingHTML += '<div style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid #EF4444;">';
            spoofingHTML += '<strong style="color: #EF4444; font-size: 14px; display: block; margin-bottom: 8px;">Security Issues:</strong>';
            spoofingHTML += '<ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 12px;">';
            for (const issue of spoof.issues) {
              spoofingHTML += '<li style="margin-bottom: 4px;">' + escapeHtml(issue) + '</li>';
            }
            spoofingHTML += '</ul></div>';
          }
          
          spoofingHTML += '</div>';
          spoofingInfo.innerHTML = spoofingHTML;
          
          // Re-initialize feather icons
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        } else {
          spoofingSection.style.display = 'none';
        }

        // Display Message Details - Improved Format
        const messageDetailsSection = document.getElementById('message-details-section');
        const messageDetailsInfo = document.getElementById('message-details-info');
        if (data.message_details && Object.keys(data.message_details).length > 0) {
          messageDetailsSection.style.display = 'block';
          
          // Important headers to show prominently
          const importantHeaders = ['From', 'To', 'Subject', 'Date', 'Message-ID', 'Return-Path', 'Reply-To'];
          const importantHeaderValues = {};
          const otherHeaders = {};
          
          for (const [key, value] of Object.entries(data.message_details)) {
            if (key.startsWith('_')) continue; // Skip internal metadata
            let displayValue = value;
            if (Array.isArray(value)) {
              displayValue = value.join('\n\n');
            }
            const cleanKey = key.trim();
            if (importantHeaders.includes(cleanKey)) {
              importantHeaderValues[cleanKey] = String(displayValue).trim();
            } else {
              otherHeaders[cleanKey] = String(displayValue).trim();
            }
          }
          
          let detailsHTML = '';
          
          // Important headers section
          if (Object.keys(importantHeaderValues).length > 0) {
            detailsHTML += '<div style="margin-bottom: 16px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 6px; border-left: 3px solid var(--accent-blue);">';
            detailsHTML += '<strong style="color: var(--accent-blue); font-size: 13px; display: block; margin-bottom: 10px;">Important Headers:</strong>';
            
            for (const headerName of importantHeaders) {
              if (importantHeaderValues[headerName]) {
                detailsHTML += '<div style="margin-bottom: 10px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px;">';
                detailsHTML += '<div style="font-weight: 600; color: var(--accent-blue); font-size: 12px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">' + escapeHtml(headerName) + '</div>';
                detailsHTML += '<div style="color: var(--text-primary); font-size: 13px; word-wrap: break-word; word-break: break-all;">' + escapeHtml(importantHeaderValues[headerName]) + '</div>';
                detailsHTML += '</div>';
              }
            }
            detailsHTML += '</div>';
          }
          
          // Received headers section (if exists)
          if (data.message_details.Received) {
            const receivedHeaders = Array.isArray(data.message_details.Received) ? data.message_details.Received : [data.message_details.Received];
            detailsHTML += '<div style="margin-bottom: 16px; padding: 12px; background: rgba(0, 0, 0, 0.02); border-radius: 6px;">';
            detailsHTML += '<strong style="color: var(--text-primary); font-size: 13px; display: block; margin-bottom: 10px;">Received Headers (' + receivedHeaders.length + '):</strong>';
            receivedHeaders.forEach((received, idx) => {
              detailsHTML += '<div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px; font-family: monospace; font-size: 11px; color: var(--text-secondary); word-wrap: break-word;">';
              detailsHTML += '<span style="color: var(--accent-blue); font-weight: 600;">[' + (idx + 1) + ']</span> ' + escapeHtml(String(received));
              detailsHTML += '</div>';
            });
            detailsHTML += '</div>';
          }
          
          // Authentication-Results header (if exists)
          if (data.message_details['Authentication-Results'] || data.message_details['Authentication-Results-Original']) {
            const authResults = data.message_details['Authentication-Results'] || data.message_details['Authentication-Results-Original'];
            detailsHTML += '<div style="margin-bottom: 16px; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 6px; border-left: 3px solid #F59E0B;">';
            detailsHTML += '<strong style="color: #F59E0B; font-size: 13px; display: block; margin-bottom: 10px;">Authentication-Results:</strong>';
            detailsHTML += '<div style="padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px; font-family: monospace; font-size: 11px; color: var(--text-secondary); word-wrap: break-word; white-space: pre-wrap;">' + escapeHtml(String(authResults)) + '</div>';
            detailsHTML += '</div>';
          }
          
          // Other headers section
          if (Object.keys(otherHeaders).length > 0) {
            detailsHTML += '<div style="margin-bottom: 10px;">';
            detailsHTML += '<details style="cursor: pointer;">';
            detailsHTML += '<summary style="font-weight: 600; color: var(--text-primary); font-size: 13px; padding: 8px; background: rgba(0, 0, 0, 0.02); border-radius: 4px; margin-bottom: 8px; user-select: none;">Show All Headers (' + Object.keys(otherHeaders).length + ' more)</summary>';
            detailsHTML += '<div style="display: grid; grid-template-columns: 200px 1fr; gap: 8px; font-size: 12px;">';
            for (const [key, value] of Object.entries(otherHeaders)) {
              if (!value) continue;
              detailsHTML += '<div style="font-weight: 600; color: var(--accent-blue); padding: 6px; background: rgba(0, 0, 0, 0.02); border-radius: 3px; word-break: break-word;">' + escapeHtml(key) + ':</div>';
              detailsHTML += '<div style="color: var(--text-secondary); padding: 6px; word-wrap: break-word; word-break: break-all; font-family: monospace; font-size: 11px; white-space: pre-wrap;">' + escapeHtml(String(value)) + '</div>';
            }
            detailsHTML += '</div></details></div>';
          }
          
          messageDetailsInfo.innerHTML = detailsHTML || '<p style="color: var(--text-secondary); margin: 0;">No message details available.</p>';
          
          // Add toggle functionality
          const toggleBtn = document.getElementById('toggle-message-details');
          const toggleText = document.getElementById('message-details-toggle-text');
          const toggleIcon = document.getElementById('message-details-icon');
          let isExpanded = false;
          if (toggleBtn) {
            toggleBtn.onclick = function() {
              isExpanded = !isExpanded;
              if (isExpanded) {
                messageDetailsInfo.style.maxHeight = 'none';
                toggleText.textContent = 'Collapse';
                if (toggleIcon) toggleIcon.setAttribute('data-feather', 'minimize-2');
              } else {
                messageDetailsInfo.style.maxHeight = '400px';
                toggleText.textContent = 'Expand';
                if (toggleIcon) toggleIcon.setAttribute('data-feather', 'maximize-2');
              }
              if (typeof feather !== 'undefined') {
                feather.replace();
              }
            };
          }
        } else {
          messageDetailsSection.style.display = 'none';
        }

        // Display SPF Results
        const spfSection = document.getElementById('spf-section');
        const spfInfo = document.getElementById('spf-info');
        if (data.spf_results && data.spf_results.length > 0) {
          spfSection.style.display = 'block';
          let spfHTML = '';
          
          for (const spf of data.spf_results) {
            const domain = spf.domain || 'Unknown';
            const securityLevel = spf.security_level || 'Unknown';
            const exists = spf.exists || false;
            const hasHardFail = spf.has_hard_fail || false;
            const hasSoftFail = spf.has_soft_fail || false;
            const hardFailDetected = spf.hard_fail_detected || false;
            const softFailDetected = spf.soft_fail_detected || false;
            
            let borderColor = '#94A3B8'; // Gray
            let bgColor = 'rgba(148, 163, 184, 0.1)';
            let icon = 'help-circle';
            let statusText = 'Unknown';
            
            if (hardFailDetected) {
              borderColor = '#EF4444'; // Red
              bgColor = 'rgba(239, 68, 68, 0.15)';
              icon = 'alert-triangle';
              statusText = '🚨 HARD FAIL DETECTED';
            } else if (softFailDetected) {
              borderColor = '#F59E0B'; // Orange
              bgColor = 'rgba(245, 158, 11, 0.15)';
              icon = 'alert-circle';
              statusText = '⚠️ SOFT FAIL DETECTED';
            } else if (hasHardFail) {
              borderColor = '#22C55E'; // Green
              bgColor = 'rgba(34, 197, 94, 0.1)';
              icon = 'check-circle';
              statusText = 'Hard Fail Configured (-all)';
            } else if (hasSoftFail) {
              borderColor = '#F59E0B'; // Orange
              bgColor = 'rgba(245, 158, 11, 0.1)';
              icon = 'alert-circle';
              statusText = 'Soft Fail Configured (~all)';
            } else if (!exists) {
              borderColor = '#EF4444'; // Red
              bgColor = 'rgba(239, 68, 68, 0.1)';
              icon = 'x-circle';
              statusText = 'No SPF Record';
            } else if (securityLevel === 'High') {
              borderColor = '#22C55E'; // Green
              bgColor = 'rgba(34, 197, 94, 0.1)';
              icon = 'check-circle';
              statusText = 'Secure';
            }
            
            let spfItemHTML = '<div style="margin-bottom: 16px; padding: 12px; background: ' + bgColor + '; border: 2px solid ' + borderColor + '; border-radius: 6px;">';
            spfItemHTML += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">';
            spfItemHTML += '<i data-feather="' + icon + '" style="width: 18px; height: 18px; color: ' + borderColor + ';"></i>';
            spfItemHTML += '<strong style="color: ' + borderColor + '; font-size: 14px;">' + escapeHtml(domain) + '</strong>';
            spfItemHTML += '<span style="color: var(--text-secondary); font-size: 12px; margin-left: auto;">' + statusText + '</span>';
            spfItemHTML += '</div>';
            
            if (spf.error) {
              spfItemHTML += '<div style="margin-top: 8px; padding: 8px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">';
              spfItemHTML += '<span style="color: var(--text-secondary); font-size: 12px;">Error: ' + escapeHtml(spf.error) + '</span>';
              spfItemHTML += '</div>';
            }
            
            if (spf.exists && spf.record) {
              spfItemHTML += '<div style="margin-top: 8px;">';
              spfItemHTML += '<strong style="color: var(--text-primary); font-size: 12px; display: block; margin-bottom: 4px;">SPF Record:</strong>';
              spfItemHTML += '<div style="font-family: monospace; font-size: 11px; color: var(--text-secondary); padding: 8px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; word-break: break-all;">';
              spfItemHTML += escapeHtml(spf.record);
              spfItemHTML += '</div></div>';
            }
            
            if (spf.all_mechanism) {
              spfItemHTML += '<div style="margin-top: 8px;">';
              spfItemHTML += '<strong style="color: var(--text-primary); font-size: 12px;">All Mechanism:</strong>';
              spfItemHTML += '<span style="font-family: monospace; color: var(--text-secondary); font-size: 12px; margin-left: 8px;">' + escapeHtml(spf.all_mechanism) + '</span>';
              if (spf.all_mechanism === '-all') {
                spfItemHTML += '<span style="color: #22C55E; margin-left: 8px;">(Hard Fail - Recommended)</span>';
              } else if (spf.all_mechanism === '~all') {
                spfItemHTML += '<span style="color: #F59E0B; margin-left: 8px;">(Soft Fail - Less Secure)</span>';
              }
              spfItemHTML += '</div>';
            }
            
            if (spf.issues && spf.issues.length > 0) {
              spfItemHTML += '<div style="margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid #EF4444;">';
              spfItemHTML += '<strong style="color: #EF4444; font-size: 12px; display: block; margin-bottom: 4px;">Issues:</strong>';
              spfItemHTML += '<ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 11px;">';
              for (const issue of spf.issues) {
                spfItemHTML += '<li>' + escapeHtml(issue) + '</li>';
              }
              spfItemHTML += '</ul></div>';
            }
            
            if (spf.auth_result) {
              const authBgColor = hardFailDetected ? 'rgba(239, 68, 68, 0.15)' : softFailDetected ? 'rgba(245, 158, 11, 0.15)' : 'rgba(59, 130, 246, 0.1)';
              const authColor = hardFailDetected ? '#EF4444' : softFailDetected ? '#F59E0B' : 'var(--accent-blue)';
              spfItemHTML += '<div style="margin-top: 8px; padding: 8px; background: ' + authBgColor + '; border-radius: 4px;">';
              spfItemHTML += '<strong style="color: ' + authColor + '; font-size: 12px;">Authentication-Results:</strong>';
              spfItemHTML += '<span style="color: var(--text-secondary); font-size: 12px; margin-left: 8px;">spf=' + escapeHtml(spf.auth_result) + '</span>';
              spfItemHTML += '</div>';
            }
            
            spfItemHTML += '</div>';
            spfHTML += spfItemHTML;
          }
          
          spfInfo.innerHTML = spfHTML;
          
          // Re-initialize feather icons for SPF
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        } else {
          spfSection.style.display = 'none';
        }

        // Update keywords list
        const keywordsList = document.getElementById('email-keywords-list');
        if (data.keywords_found && data.keywords_found.length > 0) {
          keywordsList.innerHTML = data.keywords_found.map(kw => 
            `<div style="margin-bottom: 8px; padding: 6px 10px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #F59E0B; border-radius: 4px;">
              <strong style="color: #F59E0B;">${kw.keyword}</strong> <span style="color: var(--text-secondary); font-size: 12px;">(${kw.count}x)</span>
            </div>`
          ).join('');
        } else {
          keywordsList.innerHTML = '<p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No suspicious keywords found.</p>';
        }

        // Update All Links Section - Prominent Display
        const allLinksContainer = document.getElementById('email-all-links');
        const linksCount = document.getElementById('email-links-count');
        const linksNote = document.getElementById('email-links-note');
        
        if (data.urls && data.urls.length > 0) {
          linksCount.textContent = data.urls.length;
          
          // Show note if there are more URLs than checked
          if (data.total_urls_found && data.urls_checked && data.total_urls_found > data.urls_checked) {
            linksNote.textContent = `(Showing ${data.urls_checked} of ${data.total_urls_found} - top threats first)`;
          } else {
            linksNote.textContent = '';
          }
          allLinksContainer.innerHTML = data.urls.map(item => {
            let borderColor = '#22C55E'; // Green for clean
            let bgColor = 'rgba(34, 197, 94, 0.1)';
            let icon = 'check-circle';
            let statusText = 'Clean';
            let statusColor = '#22C55E';
            
            // Check community_score first - negative = MALICIOUS
            const communityScore = parseInt(item.community_score || 0);
            if (communityScore < 0) {
              borderColor = '#EF4444'; // Red for malicious
              bgColor = 'rgba(239, 68, 68, 0.15)';
              icon = 'alert-triangle';
              statusText = 'MALICIOUS';
              statusColor = '#EF4444';
            } else if (item.malicious > 0) {
              borderColor = '#EF4444'; // Red for malicious
              bgColor = 'rgba(239, 68, 68, 0.15)';
              icon = 'alert-triangle';
              statusText = 'MALICIOUS';
              statusColor = '#EF4444';
            } else if (item.suspicious > 0) {
              borderColor = '#F59E0B'; // Orange for suspicious
              bgColor = 'rgba(245, 158, 11, 0.15)';
              icon = 'alert-circle';
              statusText = 'SUSPICIOUS';
              statusColor = '#F59E0B';
            }

            const totalScans = item.total || (item.malicious + item.suspicious + item.harmless + item.undetected);
            const maliciousPct = totalScans > 0 ? Math.round((item.malicious / totalScans) * 100) : 0;
            const suspiciousPct = totalScans > 0 ? Math.round((item.suspicious / totalScans) * 100) : 0;
            const communityLink = item.vt_community_link ? `<a href="${item.vt_community_link}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; font-size: 11px; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;"><i data-feather="external-link" style="width: 12px; height: 12px;"></i> View Community</a>` : '';

            return `<div style="margin-bottom: 12px; padding: 12px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 6px; width: 100%; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                <i data-feather="${icon}" style="width: 18px; height: 18px; color: ${borderColor}; flex-shrink: 0;"></i>
                <strong style="color: ${statusColor}; font-size: 14px; font-weight: 700; flex-shrink: 0;">${statusText}</strong>
                ${communityLink}
                ${item.error ? `<span style="color: var(--text-secondary); font-size: 11px; margin-left: auto; flex-shrink: 0;">Error: ${item.error}</span>` : ''}
              </div>
              <div style="font-family: monospace; font-size: 12px; color: var(--text-primary); word-break: break-all; word-wrap: break-word; margin-bottom: 8px; font-weight: 500; width: 100%; max-width: 100%; overflow-wrap: break-word;">${item.url}</div>
              ${item.error ? '' : `
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px; width: 100%; max-width: 100%; box-sizing: border-box;">
                  <div style="text-align: center; padding: 6px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">
                    <div style="color: #EF4444; font-size: 16px; font-weight: 700;">${item.malicious || 0}</div>
                    <div style="color: var(--text-secondary); font-size: 10px;">Malicious</div>
                    ${maliciousPct > 0 ? `<div style="color: #EF4444; font-size: 9px; margin-top: 2px;">${maliciousPct}%</div>` : ''}
                  </div>
                  <div style="text-align: center; padding: 6px; background: rgba(245, 158, 11, 0.1); border-radius: 4px;">
                    <div style="color: #F59E0B; font-size: 16px; font-weight: 700;">${item.suspicious || 0}</div>
                    <div style="color: var(--text-secondary); font-size: 10px;">Suspicious</div>
                    ${suspiciousPct > 0 ? `<div style="color: #F59E0B; font-size: 9px; margin-top: 2px;">${suspiciousPct}%</div>` : ''}
                  </div>
                  <div style="text-align: center; padding: 6px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">
                    <div style="color: #22C55E; font-size: 16px; font-weight: 700;">${item.harmless || 0}</div>
                    <div style="color: var(--text-secondary); font-size: 10px;">Harmless</div>
                  </div>
                  <div style="text-align: center; padding: 6px; background: ${communityScore < 0 ? 'rgba(239, 68, 68, 0.1)' : communityScore > 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(148, 163, 184, 0.1)'}; border-radius: 4px;">
                    <div style="color: ${communityScore < 0 ? '#EF4444' : communityScore > 0 ? '#22C55E' : 'var(--text-secondary)'}; font-size: 16px; font-weight: 700;">${communityScore}</div>
                    <div style="color: var(--text-secondary); font-size: 10px;">Community</div>
                  </div>
                  <div style="text-align: center; padding: 6px; background: rgba(148, 163, 184, 0.1); border-radius: 4px;">
                    <div style="color: var(--text-secondary); font-size: 16px; font-weight: 700;">${totalScans}</div>
                    <div style="color: var(--text-secondary); font-size: 10px;">Total Scans</div>
                  </div>
                </div>
              `}
            </div>`;
          }).join('');
        } else {
          linksCount.textContent = '0';
          allLinksContainer.innerHTML = '<p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No links found in email.</p>';
        }

        // Update IPs list
        const ipsList = document.getElementById('email-ips-list');
        if (data.ips && data.ips.length > 0) {
          ipsList.innerHTML = data.ips.map(item => {
            const communityScore = parseInt(item.community_score || 0);
            let color = '#22C55E';
            let icon = 'check-circle';
            let statusText = 'Clean';
            
            // Check community_score first - negative = MALICIOUS
            if (communityScore < 0) {
              color = '#EF4444';
              icon = 'alert-triangle';
              statusText = 'MALICIOUS';
            } else if (item.malicious > 0) {
              color = '#EF4444';
              icon = 'alert-triangle';
              statusText = 'MALICIOUS';
            } else if (item.suspicious > 0) {
              color = '#F59E0B';
              icon = 'alert-circle';
              statusText = 'SUSPICIOUS';
            }
            
            const communityLink = item.vt_community_link ? `<a href="${item.vt_community_link}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; font-size: 10px; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;"><i data-feather="external-link" style="width: 11px; height: 11px;"></i> Community</a>` : '';

            return `<div style="margin-bottom: 8px; padding: 8px; background: rgba(10, 18, 32, 0.5); border-left: 3px solid ${color}; border-radius: 4px; width: 100%; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                <i data-feather="${icon}" style="width: 14px; height: 14px; color: ${color}; flex-shrink: 0;"></i>
                <strong style="color: ${color}; font-size: 12px; flex-shrink: 0;">${statusText}</strong>
                ${communityLink}
              </div>
              <div style="font-family: monospace; font-size: 11px; color: var(--text-secondary); word-break: break-all; word-wrap: break-word; margin-bottom: 4px; width: 100%; max-width: 100%; overflow-wrap: break-word;">${item.ip}</div>
              ${item.error ? 
                `<div style="font-size: 11px; color: var(--text-secondary);">Error: ${item.error}</div>` :
                `<div style="font-size: 11px; display: flex; gap: 12px; flex-wrap: wrap;">
                  ${item.malicious > 0 ? `<span style="color: #EF4444;"><strong>${item.malicious}</strong> Malicious</span>` : ''}
                  ${item.suspicious > 0 ? `<span style="color: #F59E0B;"><strong>${item.suspicious}</strong> Suspicious</span>` : ''}
                  <span style="color: ${communityScore < 0 ? '#EF4444' : communityScore > 0 ? '#22C55E' : 'var(--text-secondary)'};"><strong>Community:</strong> ${communityScore}</span>
                  ${item.malicious === 0 && item.suspicious === 0 && communityScore >= 0 ? '<span style="color: #22C55E;">Clean</span>' : ''}
                </div>`
              }
            </div>`;
          }).join('');
          
          // Re-initialize feather icons for external-link icons
          if (typeof feather !== 'undefined') {
            setTimeout(() => feather.replace(), 100);
          }
        } else {
          ipsList.innerHTML = '<p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No IP addresses found.</p>';
        }

        // Update Attachments list
        const attachmentsList = document.getElementById('email-attachments-list');
        console.log('[Email Analysis] Attachments data:', data.attachments);
        if (data.attachments && Array.isArray(data.attachments) && data.attachments.length > 0) {
          // Debug: Log each attachment to see what fields are available
          data.attachments.forEach((att, idx) => {
            console.log(`[Email Analysis] Attachment ${idx}:`, {
              filename: att.filename,
              hash: att.hash,
              detected_type: att.detected_type,
              has_vt_stats: !!att.vt_stats
            });
          });
          attachmentsList.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <th style="padding: 8px; text-align: left; color: var(--text-secondary); font-size: 12px; font-weight: 500;">Filename</th>
                  <th style="padding: 8px; text-align: left; color: var(--text-secondary); font-size: 12px; font-weight: 500;">Verdict</th>
                  <th style="padding: 8px; text-align: left; color: var(--text-secondary); font-size: 12px; font-weight: 500;">Hash</th>
                </tr>
              </thead>
              <tbody>
                ${data.attachments.map((item, idx) => {
                  const vtStats = item.vt_stats || {};
                  const malicious = parseInt(vtStats.malicious || 0);
                  const suspicious = parseInt(vtStats.suspicious || 0);
                  const communityScore = parseInt(vtStats.community_score || 0);
                  const total = parseInt(vtStats.harmless || 0) + parseInt(vtStats.undetected || 0) + malicious + suspicious;
                  
                  // Determine icon based on detected file type
                  let fileIcon = 'file';
                  const detectedType = (item.detected_type || '').toLowerCase();
                  const detectedExt = (item.detected_ext || '').toLowerCase();
                  
                  if (detectedType.includes('word') || detectedType.includes('doc') || detectedExt.includes('doc')) {
                    fileIcon = 'file-text';
                  } else if (detectedType.includes('excel') || detectedType.includes('sheet') || detectedExt.includes('xl')) {
                    fileIcon = 'bar-chart-2';
                  } else if (detectedType.includes('image') || detectedExt.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)) {
                    fileIcon = 'image';
                  } else if (detectedType.includes('zip') || detectedType.includes('archive') || detectedExt.match(/\.(zip|rar|7z|tar|gz)$/)) {
                    fileIcon = 'package';
                  } else if (detectedType.includes('pdf') || detectedExt.includes('pdf')) {
                    fileIcon = 'file-text';
                    // PDF files will have a special viewer button
                  } else if (detectedType.includes('exe') || detectedExt.match(/\.(exe|bat|ps1|vbs|js|jar|scr|com|pif|cmd)$/)) {
                    fileIcon = 'terminal';
                  }
                  
                  let verdictBadge = '';
                  let verdictColor = 'var(--text-secondary)';
                  const communityLink = item.vt_community_link ? `<a href="${item.vt_community_link}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-blue); text-decoration: none; font-size: 10px; margin-left: 6px; display: inline-flex; align-items: center; gap: 3px;"><i data-feather="external-link" style="width: 10px; height: 10px;"></i> Community</a>` : '';
                  
                  // Check community_score first - negative = MALICIOUS
                  if (item.error) {
                    verdictBadge = '<span style="padding: 4px 8px; background: rgba(148, 163, 184, 0.2); border-radius: 4px; font-size: 11px; color: var(--text-secondary);">Unknown</span>';
                  } else if (communityScore < 0) {
                    const statsText = total > 0 ? `${malicious}/${total}` : '';
                    verdictBadge = `<span style="padding: 4px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; font-size: 11px; color: #EF4444; font-weight: 600;">🚨 MALICIOUS ${statsText}</span>${communityLink}`;
                    verdictColor = '#EF4444';
                  } else if (malicious > 0) {
                    const statsText = total > 0 ? `${malicious}/${total}` : '';
                    verdictBadge = `<span style="padding: 4px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; font-size: 11px; color: #EF4444; font-weight: 600;">⚠️ Malware ${statsText}</span>${communityLink}`;
                    verdictColor = '#EF4444';
                  } else if (suspicious > 0) {
                    const statsText = total > 0 ? `${suspicious}/${total}` : '';
                    verdictBadge = `<span style="padding: 4px 8px; background: rgba(245, 158, 11, 0.2); border-radius: 4px; font-size: 11px; color: #F59E0B; font-weight: 600;">⚠️ Suspicious ${statsText}</span>${communityLink}`;
                    verdictColor = '#F59E0B';
                  } else if (vtStats && Object.keys(vtStats).length > 0) {
                    verdictBadge = `<span style="padding: 4px 8px; background: rgba(34, 197, 94, 0.2); border-radius: 4px; font-size: 11px; color: #22C55E; font-weight: 600;">✓ Clean</span>${communityLink}`;
                    verdictColor = '#22C55E';
                  } else {
                    verdictBadge = '<span style="padding: 4px 8px; background: rgba(148, 163, 184, 0.2); border-radius: 4px; font-size: 11px; color: var(--text-secondary);">Unknown</span>';
                  }
                  
                  const hashDisplay = item.hash ? `${item.hash.substring(0, 8)}...${item.hash.substring(item.hash.length - 8)}` : 'N/A';
                  
                  // Spoofing warning badge
                  let spoofingBadge = '';
                  if (item.extension_mismatch && item.spoofing_warning) {
                    const realType = item.detected_type || item.detected_ext || 'Unknown';
                    spoofingBadge = `<div style="margin-top: 4px;"><span style="padding: 4px 8px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 4px; font-size: 10px; color: #EF4444; font-weight: 600; animation: pulse 2s infinite;">⚠️ TYPE MISMATCH (Real: ${realType.toUpperCase()})</span></div>`;
                  }
                  
                  // Check if text content is available
                  const hasTextContent = item.extracted_text && item.extracted_text.trim().length > 0;
                  const textPreview = hasTextContent ? item.extracted_text.substring(0, 100) + (item.extracted_text.length > 100 ? '...' : '') : '';
                  const textContentId = `attachment-text-${item.hash ? item.hash.substring(0, 8) : idx}`;
                  
                  // Check if this is a PDF file
                  const isPDF = (detectedType.includes('pdf') || detectedExt.includes('pdf')) && item.hash;
                  const pdfViewerId = `pdf-viewer-${item.hash ? item.hash.substring(0, 8) : idx}`;
                  
                  // Ensure filename is displayed - try multiple fallbacks
                  const displayFilename = (item.filename && item.filename.trim() !== '' && item.filename !== 'Unknown') 
                    ? item.filename 
                    : `Attachment_${idx + 1}`;
                  
                  console.log(`[Attachment Display] Index ${idx}: filename="${item.filename}", displayFilename="${displayFilename}"`);
                  
                  return `
                    <tr style="border-bottom: 1px solid rgba(94, 234, 212, 0.1);">
                      <td style="padding: 12px 8px; color: var(--text-primary); font-size: 13px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <i data-feather="${fileIcon}" style="width: 14px; height: 14px; color: ${verdictColor}; flex-shrink: 0;"></i>
                          <span style="word-break: break-word; overflow-wrap: break-word; flex: 1;">${escapeHtml(displayFilename)}</span>
                          ${item.hash ? `<button 
                            class="view-file-btn"
                            data-file-hash="${item.hash}"
                            data-filename="${escapeHtml(displayFilename)}"
                            data-file-type="${detectedType || detectedExt || ''}"
                            data-verdict-color="${verdictColor}"
                            data-vt-community-link="${item.vt_community_link || ''}"
                            data-malicious="${malicious}"
                            data-suspicious="${suspicious}"
                            data-total="${total}"
                            data-community-score="${communityScore}"
                            style="
                            margin-left: 8px;
                            padding: 4px 8px;
                            background: rgba(94, 234, 212, 0.1);
                            border: 1px solid rgba(94, 234, 212, 0.3);
                            border-radius: 4px;
                            color: var(--accent-blue);
                            font-size: 11px;
                            cursor: pointer;
                            font-weight: 500;
                          " onmouseover="this.style.background='rgba(94, 234, 212, 0.2)';" onmouseout="this.style.background='rgba(94, 234, 212, 0.1)';">
                            <i data-feather="eye" style="width: 12px; height: 12px; vertical-align: middle; margin-right: 4px;"></i>
                            View File
                          </button>` : ''}
                          ${hasTextContent && !isPDF && !item.hash ? `<button onclick="toggleAttachmentContent('${textContentId}')" style="
                            margin-left: 8px;
                            padding: 4px 8px;
                            background: rgba(94, 234, 212, 0.1);
                            border: 1px solid rgba(94, 234, 212, 0.3);
                            border-radius: 4px;
                            color: var(--accent-blue);
                            font-size: 11px;
                            cursor: pointer;
                            font-weight: 500;
                          " onmouseover="this.style.background='rgba(94, 234, 212, 0.2)';" onmouseout="this.style.background='rgba(94, 234, 212, 0.1)';">
                            <i data-feather="eye" style="width: 12px; height: 12px; vertical-align: middle; margin-right: 4px;"></i>
                            View Content
                          </button>` : ''}
                        </div>
                        ${item.error ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Error: ${item.error}</div>` : ''}
                        ${spoofingBadge}
                        ${item.has_dangerous_ext ? `<div style="margin-top: 4px;"><span style="font-size: 10px; color: #F59E0B;">⚠️ Dangerous extension</span></div>` : ''}
                        ${isPDF ? `
                          <div id="${pdfViewerId}" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                              <strong style="font-size: 12px; color: var(--text-primary);">
                                <i data-feather="file-text" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                                PDF Viewer
                              </strong>
                              <button onclick="closePDFViewer('${pdfViewerId}')" style="
                                background: transparent;
                                border: none;
                                color: var(--text-secondary);
                                cursor: pointer;
                                padding: 4px;
                              " onmouseover="this.style.color='var(--text-primary)';" onmouseout="this.style.color='var(--text-secondary)';">
                                <i data-feather="x" style="width: 14px; height: 14px;"></i>
                              </button>
                            </div>
                            <div id="${pdfViewerId}-content" style="
                              width: 100%;
                              height: 600px;
                              border: 1px solid var(--border-color);
                              border-radius: 4px;
                              background: white;
                              overflow: auto;
                            ">
                              <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                                <i data-feather="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i>
                                <p>Loading PDF viewer...</p>
                              </div>
                            </div>
                          </div>
                        ` : ''}
                        ${hasTextContent && !isPDF ? `
                          <div id="${textContentId}" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                              <strong style="font-size: 12px; color: var(--text-primary);">
                                <i data-feather="file-text" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                                File Content (${item.extracted_text.length} characters)
                              </strong>
                              <button onclick="toggleAttachmentContent('${textContentId}')" style="
                                background: transparent;
                                border: none;
                                color: var(--text-secondary);
                                cursor: pointer;
                                padding: 4px;
                              " onmouseover="this.style.color='var(--text-primary)';" onmouseout="this.style.color='var(--text-secondary)';">
                                <i data-feather="x" style="width: 14px; height: 14px;"></i>
                              </button>
                            </div>
                            <div style="
                              font-family: monospace;
                              font-size: 11px;
                              color: var(--text-secondary);
                              white-space: pre-wrap;
                              max-height: 400px;
                              overflow-y: auto;
                              overflow-x: hidden;
                              word-wrap: break-word;
                              word-break: break-word;
                              line-height: 1.5;
                              padding: 8px;
                              background: rgba(0, 0, 0, 0.2);
                              border-radius: 4px;
                            ">${escapeHtml(item.extracted_text)}</div>
                          </div>
                        ` : ''}
                      </td>
                      <td style="padding: 12px 8px;">
                        ${verdictBadge}
                      </td>
                      <td style="padding: 12px 8px; font-family: monospace; font-size: 11px; color: var(--text-secondary); word-break: break-all;">
                        ${hashDisplay}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
          
          // Re-initialize feather icons for external-link icons in attachments
          if (typeof feather !== 'undefined') {
            setTimeout(() => feather.replace(), 100);
          }
        } else {
          attachmentsList.innerHTML = '<p style="color: var(--text-secondary); margin: 0; font-size: 13px;">No attachments found.</p>';
        }

        // Update body preview - use msgreader body_html from msg-analyzer
        const bodyPreviewElement = document.getElementById('email-body-preview');
        if (data.body_html && data.body_html.trim()) {
          // Display full HTML body from msgreader (msg-analyzer)
          // Use msgreader's body_html directly, similar to msg-analyzer display
          bodyPreviewElement.innerHTML = data.body_html;
          bodyPreviewElement.style.whiteSpace = 'normal';
          bodyPreviewElement.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
          bodyPreviewElement.style.fontSize = '14px';
          bodyPreviewElement.style.color = 'var(--text-primary)';
        } else if (data.body_preview && data.body_preview.trim()) {
          // Display plain text body from msgreader
          bodyPreviewElement.textContent = data.body_preview;
          bodyPreviewElement.style.whiteSpace = 'pre-wrap';
          bodyPreviewElement.style.fontFamily = 'monospace';
          bodyPreviewElement.style.fontSize = '12px';
          bodyPreviewElement.style.color = 'var(--text-secondary)';
        } else {
          bodyPreviewElement.textContent = '—';
        }
        
        // Reset body preview to collapsed state when new email is loaded
        resetBodyPreview();
        
        // Attach event listeners to View File buttons
        setTimeout(function() {
          document.querySelectorAll('.view-file-btn').forEach(function(btn) {
            if (!btn.hasAttribute('data-listener-attached')) {
              btn.setAttribute('data-listener-attached', 'true');
              btn.addEventListener('click', function() {
                var fileHash = this.getAttribute('data-file-hash');
                var filename = this.getAttribute('data-filename');
                var fileType = this.getAttribute('data-file-type');
                var fileMetadata = {
                  hash: fileHash,
                  verdictColor: this.getAttribute('data-verdict-color'),
                  vtCommunityLink: this.getAttribute('data-vt-community-link') || null,
                  malicious: parseInt(this.getAttribute('data-malicious') || 0),
                  suspicious: parseInt(this.getAttribute('data-suspicious') || 0),
                  total: parseInt(this.getAttribute('data-total') || 0),
                  communityScore: parseInt(this.getAttribute('data-community-score') || 0),
                  vtStats: {} // Will be populated if needed
                };
                loadAndViewAttachment(fileHash, filename, fileType, fileMetadata);
              });
            }
          });
        }, 100);
        
        // Attach event listener to body preview toggle button (after DOM is updated)
        setTimeout(function() {
          attachBodyPreviewListener();
        }, 200);
        
        // Re-initialize feather icons after updating attachments
        if (typeof feather !== 'undefined') {
          feather.replace();
        }

        // Initialize or update Threat Constellation Map with graph_data from response
        if (data.graph_data && Array.isArray(data.graph_data) && data.graph_data.length > 0) {
          try {
            // Check if Threat Constellation Map container exists, create it if needed
            let mapContainer = document.getElementById('email-threat-map-container');
            if (!mapContainer) {
              // Create the container if it doesn't exist
              const reportContent = document.querySelector('#email-report-content');
              if (reportContent) {
                mapContainer = document.createElement('div');
                mapContainer.id = 'email-threat-map-container';
                mapContainer.className = 'neon-panel threat-map-panel';
                mapContainer.style.cssText = 'margin-top: 20px; padding: 20px;';
                mapContainer.innerHTML = `
                  <div class="section-title" style="margin-bottom: 15px;">
                    <i data-feather="git-branch"></i> Threat Constellation Map
                  </div>
                  <p class="section-subtitle" style="margin-bottom: 15px;">
                    Interactive network visualization showing relationships between entities found in the analyzed email.
                  </p>
                  <div style="position: relative; width: 100%;">
                    <div id="email-cy" style="width: 100%; height: 450px; background: 
                      linear-gradient(135deg, rgba(2, 6, 16, 0.99) 0%, rgba(6, 10, 20, 0.99) 100%),
                      repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(94, 234, 212, 0.015) 50px, rgba(94, 234, 212, 0.015) 51px),
                      repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(94, 234, 212, 0.015) 50px, rgba(94, 234, 212, 0.015) 51px);
                      border-radius: 6px; 
                      border: 1px solid rgba(94, 234, 212, 0.2); 
                      box-shadow: 0 0 20px rgba(94, 234, 212, 0.1);
                      position: relative;
                      overflow: hidden;">
                      <div id="email-cy-stars" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></div>
                    </div>
                  </div>
                `;
                // Insert before the end of reportContent
                reportContent.appendChild(mapContainer);
                if (typeof feather !== 'undefined') {
                  feather.replace();
                }
              }
            }
            
            // Initialize the graph with the provided graph_data
            if (typeof initThreatConstellationMapWithData === 'function') {
              initThreatConstellationMapWithData('email-cy', data.graph_data);
            } else {
              console.warn('[Email Analysis] initThreatConstellationMapWithData function not available');
            }
          } catch (e) {
            console.warn('[Email Analysis] Error initializing Threat Constellation Map:', e);
          }
        } else {
          // Clear graph if no graph_data
          if (window.cyInstance && window.cyInstance.container && window.cyInstance.container().id === 'email-cy') {
            try {
              window.cyInstance.elements().remove();
              console.log('[Email Analysis] Cleared Threat Constellation Map - no graph_data found');
            } catch (e) {
              console.warn('[Email Analysis] Error clearing graph:', e);
            }
          }
        }

        // Re-initialize Feather icons
        if (typeof feather !== 'undefined') {
          feather.replace();
        }

        // Scroll to report
        reportContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    })();
  </script>

  {# OSINT Dossier Functions - Must be in global scope #}
  <script>
    // Ensure functions are available globally
    window.openDossier = window.openDossier || function(domain) {
      const modal = document.getElementById('dossier-modal');
      const content = document.getElementById('dossier-content');
      
      if (!modal) {
        console.error('Dossier modal not found in DOM');
        alert('Error: Dossier modal not found. Please refresh the page.');
        return;
      }
      
      if (!content) {
        console.error('Dossier content not found in DOM');
        alert('Error: Dossier content not found. Please refresh the page.');
        return;
      }
      
      if (typeof escapeHtml === 'undefined') {
        console.error('escapeHtml function not defined');
        // Define escapeHtml if it's not defined
        window.escapeHtml = window.escapeHtml || function(text) {
          if (!text) return '';
          var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        };
      }
      
      // Open modal immediately - before any async operations
      modal.style.display = 'block';
      modal.style.opacity = '0';
      setTimeout(function() {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
      }, 10);
      
      // Show loading screen immediately with better design
      content.innerHTML = `
        <div style="
          text-align: center; 
          padding: 60px 40px; 
          color: var(--text-primary);
          min-height: 300px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
        ">
          <div style="
            width: 64px;
            height: 64px;
            border: 4px solid rgba(168, 85, 247, 0.2);
            border-top-color: #A855F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
          "></div>
          <h3 style="
            margin: 0 0 12px 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.5px;
          ">Loading Intelligence Data</h3>
          <p style="
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
          ">Analyzing domain: <span style="color: #A855F7; font-family: 'Courier New', monospace;">${escapeHtml(domain)}</span></p>
          <p style="
            margin: 16px 0 0 0;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
          ">Querying WHOIS and DNS records...</p>
        </div>
      `;
      
      // Scroll modal to top
      modal.scrollTop = 0;
      
      // Initialize feather icons if available
      if (typeof feather !== 'undefined') {
        setTimeout(function() {
          feather.replace();
        }, 50);
      }
      
      // Fetch dossier data
      fetch('/api/osint/dossier', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ domain: domain })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (typeof window.displayDossier === 'function') {
          window.displayDossier(data);
        } else {
          console.error('displayDossier function not defined');
          content.innerHTML = `
            <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid #EF4444; border-radius: 8px; color: #EF4444;">
              <strong>ERROR:</strong> Display function not available. Please refresh the page.
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Dossier fetch error:', error);
        if (content) {
          content.innerHTML = `
            <div style="
              padding: 30px;
              background: rgba(239, 68, 68, 0.1);
              border: 1px solid #EF4444;
              border-radius: 8px;
              color: #EF4444;
              text-align: center;
            ">
              <i data-feather="alert-circle" style="width: 48px; height: 48px; margin-bottom: 16px; display: block; margin-left: auto; margin-right: auto;"></i>
              <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700;">Failed to Load Dossier Data</h3>
              <p style="margin: 0; font-size: 14px; opacity: 0.9;">${escapeHtml(error.message)}</p>
            </div>
          `;
          if (typeof feather !== 'undefined') {
            setTimeout(function() {
              feather.replace();
            }, 50);
          }
        }
      });
    };
    
    window.closeDossier = window.closeDossier || function() {
      try {
        const modal = document.getElementById('dossier-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      } catch (error) {
        console.error('Error closing dossier modal:', error);
      }
    };
    
    window.checkDomainDossier = window.checkDomainDossier || function() {
      try {
        const input = document.getElementById('lookup-query-input');
        if (!input) {
          console.error('Lookup input not found');
          alert('Error: Lookup input not found. Please refresh the page.');
          return;
        }
        
        const query = (input.value || '').trim();
        
        if (!query) {
          alert('Please enter a domain to check');
          return;
        }
        
        // Extract domain from URL if needed
        let domain = query.toLowerCase();
        if (domain.includes('://')) {
          try {
            const url = new URL(domain);
            domain = url.hostname;
          } catch (e) {
            // Try to extract manually
            domain = domain.replace(/^https?:\/\//, '').split('/')[0];
          }
        }
        domain = domain.replace(/^www\./, '').split(':')[0].split('/')[0];
        
        // Validate domain is not empty after extraction
        if (!domain || domain.length === 0) {
          alert('Please enter a valid domain to check');
          return;
        }
        
        if (typeof window.openDossier === 'undefined' || typeof window.openDossier !== 'function') {
          console.error('openDossier function not defined');
          alert('Error: Dossier function not available. Please refresh the page.');
          return;
        }
        
        // Open dossier immediately - this will show the modal with loading screen
        window.openDossier(domain);
      } catch (error) {
        console.error('Error in checkDomainDossier:', error);
        alert('An error occurred: ' + error.message);
      }
    };
    
    window.displayDossier = window.displayDossier || function(data) {
      const content = document.getElementById('dossier-content');
      if (!content) {
        console.error('Dossier content element not found');
        return;
      }
      
      if (typeof escapeHtml === 'undefined') {
        // Define escapeHtml if it's not defined
        window.escapeHtml = window.escapeHtml || function(text) {
          if (!text) return '';
          var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        };
      }
      
      const domain = data.domain || 'Unknown';
      const domainAge = data.domain_age_days;
      const isHighRisk = data.is_high_risk || false;
      const riskFlags = data.risk_flags || [];
      const whoisData = data.whois_data || {};
      const mxRecords = data.mx_records || [];
      const error = data.error;
      
      let html = '';
      
      // Domain Header Card
      html += `<div style="
        margin-bottom: 30px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(139, 92, 246, 0.08));
        border: 1px solid rgba(168, 85, 247, 0.25);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(168, 85, 247, 0.1);
      ">`;
      html += `<div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      ">`;
      html += `<i data-feather="globe" style="width: 20px; height: 20px; color: #A855F7;"></i>`;
      html += `<span style="
        font-size: 13px;
        font-weight: 600;
        color: rgba(168, 85, 247, 0.9);
        text-transform: uppercase;
        letter-spacing: 1px;
      ">Target Domain</span>`;
      html += `</div>`;
      html += `<div style="
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'Courier New', monospace;
        letter-spacing: 0.5px;
        word-break: break-all;
      ">${escapeHtml(domain)}</div>`;
      if (domainAge !== null) {
        html += `<div style="
          margin-top: 12px;
          padding: 8px 12px;
          background: rgba(0, 0, 0, 0.2);
          border-radius: 6px;
          display: inline-block;
        ">`;
        html += `<span style="color: var(--text-secondary); font-size: 13px;">Domain Age: </span>`;
        html += `<span style="color: ${domainAge < 30 ? '#EF4444' : domainAge < 365 ? '#F59E0B' : '#22C55E'}; font-weight: 700; font-size: 14px;">${domainAge} days</span>`;
        html += `</div>`;
      }
      html += `</div>`;
      
      // HIGH RISK WARNING
      if (isHighRisk || (domainAge !== null && domainAge < 30)) {
        html += `<div style="
          margin-bottom: 30px;
          padding: 24px;
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
          border: 2px solid rgba(239, 68, 68, 0.4);
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
          animation: pulse 2s infinite;
        ">`;
        html += `<div style="
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 16px;
        ">`;
        html += `<div style="
          width: 40px;
          height: 40px;
          background: rgba(239, 68, 68, 0.2);
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
        ">`;
        html += `<i data-feather="alert-triangle" style="width: 24px; height: 24px; color: #EF4444;"></i>`;
        html += `</div>`;
        html += `<div style="font-size: 20px; font-weight: 700; color: #EF4444; text-transform: uppercase; letter-spacing: 1px;">High Risk Domain</div>`;
        html += `</div>`;
        if (domainAge !== null && domainAge < 30) {
          html += `<div style="
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #EF4444;
            margin-bottom: 12px;
          ">`;
          html += `<div style="color: #FCA5A5; font-size: 14px; font-weight: 500;">⚠️ Domain age: ${domainAge} days (Less than 30 days old - Critical phishing indicator)</div>`;
          html += `</div>`;
        }
        if (riskFlags.length > 0) {
          html += `<div style="
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
          ">`;
          html += `<div style="color: var(--text-secondary); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Risk Indicators:</div>`;
          html += `<ul style="margin: 0; padding-left: 20px; color: #FCA5A5; font-size: 13px; line-height: 1.8;">`;
          riskFlags.forEach(flag => {
            html += `<li style="margin-bottom: 6px;">${escapeHtml(flag)}</li>`;
          });
          html += `</ul>`;
          html += `</div>`;
        }
        html += `</div>`;
      }
      
      // WHOIS Information
      html += `<div style="
        margin-bottom: 30px;
        padding: 24px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 12px;
      ">`;
      html += `<div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      ">`;
      html += `<i data-feather="info" style="width: 20px; height: 20px; color: #A855F7;"></i>`;
      html += `<h3 style="
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      ">WHOIS Intelligence</h3>`;
      html += `</div>`;
      
      if (error && error.includes('WHOIS')) {
        html += `<div style="
          padding: 16px;
          background: rgba(148, 163, 184, 0.1);
          border-left: 3px solid #94A3B8;
          border-radius: 8px;
          color: var(--text-secondary);
        ">⚠️ WHOIS data unavailable: ${escapeHtml(error)}</div>`;
      } else if (Object.keys(whoisData).length > 0) {
        const infoItems = [];
        
        if (whoisData.creation_date) {
          infoItems.push({
            label: 'Creation Date',
            value: escapeHtml(whoisData.creation_date),
            icon: 'calendar'
          });
        }
        
        if (whoisData.expiration_date) {
          infoItems.push({
            label: 'Expiration Date',
            value: escapeHtml(whoisData.expiration_date),
            icon: 'clock'
          });
        }
        
        if (whoisData.registrar) {
          infoItems.push({
            label: 'Registrar',
            value: escapeHtml(whoisData.registrar),
            icon: 'briefcase'
          });
        }
        
        if (whoisData.organization) {
          infoItems.push({
            label: 'Organization',
            value: escapeHtml(whoisData.organization),
            icon: 'building'
          });
        }
        
        infoItems.forEach((item, idx) => {
          html += `<div style="
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: ${idx < infoItems.length - 1 ? '12px' : '0'};
          ">`;
          html += `<i data-feather="${item.icon}" style="width: 18px; height: 18px; color: #A855F7; margin-top: 2px; flex-shrink: 0;"></i>`;
          html += `<div style="flex: 1;">`;
          html += `<div style="
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
          ">${item.label}</div>`;
          html += `<div style="
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            word-break: break-word;
          ">${item.value}</div>`;
          html += `</div>`;
          html += `</div>`;
        });
        
        if (whoisData.name_servers && whoisData.name_servers.length > 0) {
          html += `<div style="
            margin-top: 16px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
          ">`;
          html += `<div style="
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
          ">`;
          html += `<i data-feather="server" style="width: 18px; height: 18px; color: #A855F7;"></i>`;
          html += `<div style="
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
          ">Name Servers</div>`;
          html += `</div>`;
          html += `<div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 8px;
          ">`;
          whoisData.name_servers.forEach(ns => {
            html += `<div style="
              padding: 10px 12px;
              background: rgba(168, 85, 247, 0.1);
              border: 1px solid rgba(168, 85, 247, 0.2);
              border-radius: 6px;
              font-family: 'Courier New', monospace;
              font-size: 13px;
              color: var(--text-primary);
            ">${escapeHtml(ns)}</div>`;
          });
          html += `</div>`;
          html += `</div>`;
        }
      } else {
        html += `<div style="
          padding: 16px;
          background: rgba(148, 163, 184, 0.1);
          border-left: 3px solid #94A3B8;
          border-radius: 8px;
          color: var(--text-secondary);
        ">No WHOIS data available</div>`;
      }
      html += `</div>`;
      
      // DNS MX Records
      html += `<div style="
        margin-bottom: 30px;
        padding: 24px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 12px;
      ">`;
      html += `<div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      ">`;
      html += `<i data-feather="mail" style="width: 20px; height: 20px; color: #A855F7;"></i>`;
      html += `<h3 style="
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      ">DNS MX Records</h3>`;
      html += `</div>`;
      
      if (mxRecords.length > 0) {
        html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
        mxRecords.forEach((mx, idx) => {
          html += `<div style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 8px;
          ">`;
          html += `<div style="
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #A855F7;
            font-size: 14px;
            flex-shrink: 0;
          ">${idx + 1}</div>`;
          html += `<div style="flex: 1;">`;
          html += `<div style="
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
          ">Priority: <span style="color: var(--text-primary); font-weight: 600;">${mx.priority}</span></div>`;
          html += `<div style="
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-all;
          ">${escapeHtml(mx.exchange)}</div>`;
          html += `</div>`;
          html += `</div>`;
        });
        html += `</div>`;
      } else {
        html += `<div style="
          padding: 16px;
          background: rgba(245, 158, 11, 0.1);
          border-left: 3px solid #F59E0B;
          border-radius: 8px;
          color: #FCD34D;
        ">⚠️ No MX records found - Suspicious configuration</div>`;
      }
      html += `</div>`;
      
      // Connected Infrastructure (SSL Relations) Section
      html += `<div style="
        margin-bottom: 30px;
        padding: 24px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 12px;
      " id="ssl-relations-section">`;
      html += `<div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      ">`;
      html += `<div style="display: flex; align-items: center; gap: 8px;">`;
      html += `<span style="font-size: 18px;">🔗</span>`;
      html += `<h3 style="
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      ">Shared Identity Network</h3>`;
      html += `<div style="
        position: relative;
        display: inline-block;
        margin-left: 4px;
      " class="ssl-info-tooltip-container">`;
      html += `<i data-feather="info" style="
        width: 16px;
        height: 16px;
        color: rgba(168, 85, 247, 0.6);
        cursor: help;
      " class="ssl-info-icon"></i>`;
      html += `<div class="ssl-info-tooltip" style="
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 8px;
        background: rgba(10, 18, 32, 0.98);
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: 8px;
        padding: 12px 16px;
        width: 320px;
        font-size: 12px;
        color: var(--text-primary);
        line-height: 1.6;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        pointer-events: none;
        transition: opacity 0.2s, visibility 0.2s;
        white-space: normal;
      ">`;
      html += `These domains share the same SSL Certificate. This indicates they are likely owned by the same entity or run on the same specific server infrastructure.`;
      html += `</div>`;
      html += `</div>`;
      html += `</div>`;
      html += `<div id="ssl-relations-content" style="
        text-align: center;
        padding: 20px;
        color: var(--text-secondary);
      ">`;
      html += `<div style="
        width: 32px;
        height: 32px;
        border: 3px solid rgba(168, 85, 247, 0.2);
        border-top-color: #A855F7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 12px;
      "></div>`;
      html += `<p style="margin: 0; font-size: 13px;">Querying Certificate Transparency logs...</p>`;
      html += `</div>`;
      html += `</div>`;
      
      // Chameleon Cloak Detection Section
      html += `<div style="
        margin-bottom: 30px;
        padding: 24px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 12px;
      " id="cloaking-detection-section">`;
      html += `<div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      ">`;
      html += `<span style="font-size: 24px;">🦎</span>`;
      html += `<h3 style="
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      ">Chameleon Cloak Detection</h3>`;
      html += `</div>`;
      html += `<div id="cloaking-detection-content" style="
        text-align: center;
        padding: 20px;
        color: var(--text-secondary);
      ">`;
      html += `<div style="
        width: 32px;
        height: 32px;
        border: 3px solid rgba(239, 68, 68, 0.2);
        border-top-color: #EF4444;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 12px;
      "></div>`;
      html += `<p style="margin: 0; font-size: 13px;">Testing for cloaking behavior...</p>`;
      html += `</div>`;
      html += `</div>`;
      
      // AI Strategic Advisor Section
      const recommendations = data.recommendations || [];
      html += `<div style="
        margin-bottom: 30px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 165, 233, 0.08));
        border: 1px solid rgba(59, 130, 246, 0.25);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
      " id="ai-advisor-section">`;
      html += `<div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      ">`;
      html += `<span style="font-size: 24px;">🤖</span>`;
      html += `<h3 style="
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      ">AI Security Advisor</h3>`;
      html += `</div>`;
      
      if (recommendations.length === 0) {
        html += `<div style="
          padding: 16px;
          background: rgba(148, 163, 184, 0.1);
          border-left: 3px solid #94A3B8;
          border-radius: 8px;
          color: var(--text-secondary);
        ">No recommendations available</div>`;
      } else {
        html += `<div style="display: flex; flex-direction: column; gap: 12px;">`;
        recommendations.forEach((rec, idx) => {
          const severity = rec.severity || 'info';
          const action = rec.action || '';
          const reason = rec.reason || '';
          
          let icon = 'info';
          let iconColor = '#3B82F6';
          let bgColor = 'rgba(59, 130, 246, 0.1)';
          let borderColor = 'rgba(59, 130, 246, 0.3)';
          
          if (severity === 'high') {
            icon = 'alert-triangle';
            iconColor = '#EF4444';
            bgColor = 'rgba(239, 68, 68, 0.1)';
            borderColor = 'rgba(239, 68, 68, 0.3)';
          } else if (severity === 'medium') {
            icon = 'alert-circle';
            iconColor = '#F59E0B';
            bgColor = 'rgba(245, 158, 11, 0.1)';
            borderColor = 'rgba(245, 158, 11, 0.3)';
          } else if (severity === 'low') {
            icon = 'check-circle';
            iconColor = '#22C55E';
            bgColor = 'rgba(34, 197, 94, 0.1)';
            borderColor = 'rgba(34, 197, 94, 0.3)';
          }
          
          html += `<div style="
            padding: 14px 16px;
            background: ${bgColor};
            border-left: 4px solid ${borderColor};
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
          ">`;
          html += `<i data-feather="${icon}" style="width: 18px; height: 18px; color: ${iconColor}; margin-top: 2px; flex-shrink: 0;"></i>`;
          html += `<div style="flex: 1;">`;
          html += `<div style="
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 4px;
          ">${escapeHtml(action)}</div>`;
          if (reason) {
            html += `<div style="
              font-size: 12px;
              color: var(--text-secondary);
              opacity: 0.8;
            ">${escapeHtml(reason)}</div>`;
          }
          html += `</div>`;
          html += `</div>`;
        });
        html += `</div>`;
        
        // Feedback Loop Section
        html += `<div style="
          margin-top: 24px;
          padding-top: 20px;
          border-top: 1px solid rgba(59, 130, 246, 0.2);
        ">`;
        html += `<div style="
          font-size: 13px;
          color: var(--text-secondary);
          margin-bottom: 12px;
          font-weight: 500;
        ">Was this analysis helpful? Help me learn.</div>`;
        html += `<div style="display: flex; gap: 10px;">`;
        html += `<button onclick="sendAIFeedback('${escapeHtml(domain)}', 1)" style="
          flex: 1;
          padding: 10px 16px;
          background: rgba(34, 197, 94, 0.15);
          border: 1px solid rgba(34, 197, 94, 0.3);
          border-radius: 8px;
          color: #22C55E;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        " onmouseover="this.style.background='rgba(34, 197, 94, 0.25)'; this.style.borderColor='rgba(34, 197, 94, 0.5)';" onmouseout="this.style.background='rgba(34, 197, 94, 0.15)'; this.style.borderColor='rgba(34, 197, 94, 0.3)';">
          <span>👍</span> Accurate
        </button>`;
        html += `<button onclick="sendAIFeedback('${escapeHtml(domain)}', 0)" style="
          flex: 1;
          padding: 10px 16px;
          background: rgba(239, 68, 68, 0.15);
          border: 1px solid rgba(239, 68, 68, 0.3);
          border-radius: 8px;
          color: #EF4444;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        " onmouseover="this.style.background='rgba(239, 68, 68, 0.25)'; this.style.borderColor='rgba(239, 68, 68, 0.5)';" onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.3)';">
          <span>👎</span> Inaccurate
        </button>`;
        html += `</div>`;
        html += `</div>`;
      }
      html += `</div>`;
      
      // Footer
      html += `<div style="
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        text-align: center;
        color: var(--text-secondary);
        font-size: 12px;
      ">`;
      html += `<div style="display: flex; align-items: center; justify-content: center; gap: 8px;">`;
      html += `<i data-feather="clock" style="width: 14px; height: 14px;"></i>`;
      html += `<span>Report Generated: ${new Date().toLocaleString()}</span>`;
      html += `</div>`;
      html += `</div>`;
      
      content.innerHTML = html;
      
      if (typeof feather !== 'undefined') {
        feather.replace();
        
        // Setup tooltip for info icon in header
        setTimeout(function() {
          const tooltipContainers = document.querySelectorAll('.ssl-info-tooltip-container');
          tooltipContainers.forEach(container => {
            const icon = container.querySelector('.ssl-info-icon');
            const tooltip = container.querySelector('.ssl-info-tooltip');
            if (icon && tooltip) {
              icon.addEventListener('mouseenter', function() {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
              });
              icon.addEventListener('mouseleave', function() {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
              });
              container.addEventListener('mouseenter', function() {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
              });
              container.addEventListener('mouseleave', function() {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
              });
            }
          });
        }, 100);
      }
      
      // Load SSL relations asynchronously (don't block main data)
      if (domain) {
        if (typeof window.loadSSLRelations === 'function') {
          window.loadSSLRelations(domain);
        } else {
          // Function might not be defined yet, try again after a short delay
          setTimeout(function() {
            if (typeof window.loadSSLRelations === 'function') {
              window.loadSSLRelations(domain);
            }
          }, 100);
        }
        
        // Load cloaking detection asynchronously
        if (typeof window.loadCloakingDetection === 'function') {
          window.loadCloakingDetection(domain);
        } else {
          setTimeout(function() {
            if (typeof window.loadCloakingDetection === 'function') {
              window.loadCloakingDetection(domain);
            }
          }, 100);
        }
      }
    }
    
    // Function to load SSL relations asynchronously
    window.loadSSLRelations = window.loadSSLRelations || function(domain) {
      const sslContent = document.getElementById('ssl-relations-content');
      if (!sslContent) {
        console.error('SSL relations content element not found');
        return;
      }
      
      // Fetch SSL relations
      fetch('/api/ghost/ssl', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ domain: domain })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (typeof window.displaySSLRelations === 'function') {
          window.displaySSLRelations(data);
        } else {
          console.error('displaySSLRelations function not defined');
        }
      })
      .catch(error => {
        console.error('SSL Relations fetch error:', error);
        if (sslContent) {
          sslContent.innerHTML = `
            <div style="
              padding: 16px;
              background: rgba(148, 163, 184, 0.1);
              border-left: 3px solid #94A3B8;
              border-radius: 8px;
              color: var(--text-secondary);
            ">
              <i data-feather="alert-circle" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
              Failed to load SSL relations: ${escapeHtml(error.message)}
            </div>
          `;
          if (typeof feather !== 'undefined') {
            setTimeout(function() {
              feather.replace();
            }, 50);
          }
        }
      });
    };
    
    // Function to display SSL relations
    window.displaySSLRelations = window.displaySSLRelations || function(data) {
      const sslContent = document.getElementById('ssl-relations-content');
      if (!sslContent) {
        return;
      }
      
      const relatedDomains = data.related_domains || [];
      const count = data.count || 0;
      const error = data.error;
      
      let html = '';
      
      if (error) {
        html += `<div style="
          padding: 16px;
          background: rgba(148, 163, 184, 0.1);
          border-left: 3px solid #94A3B8;
          border-radius: 8px;
          color: var(--text-secondary);
        ">`;
        html += `<i data-feather="alert-circle" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>`;
        html += `Error: ${escapeHtml(error)}`;
        html += `</div>`;
      } else if (relatedDomains.length === 0) {
        html += `<div style="
          padding: 20px;
          background: rgba(148, 163, 184, 0.1);
          border-left: 3px solid #94A3B8;
          border-radius: 8px;
          color: var(--text-secondary);
          text-align: center;
        ">`;
        html += `<i data-feather="link-2" style="width: 24px; height: 24px; margin-bottom: 8px; display: block; margin-left: auto; margin-right: auto; opacity: 0.5;"></i>`;
        html += `<p style="margin: 0; font-size: 14px;">No SSL relations found</p>`;
        html += `<p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.7;">No domains found sharing SSL certificates with this domain</p>`;
        html += `</div>`;
      } else {
        // Analyze domains to determine pattern
        const mainDomainParts = data.domain ? data.domain.toLowerCase().split('.') : [];
        const mainBaseName = mainDomainParts.length >= 2 ? mainDomainParts.slice(-2).join('.') : '';
        
        // Extract base names from related domains
        const relatedBaseNames = new Set();
        relatedDomains.forEach(domain => {
          const parts = domain.toLowerCase().split('.');
          if (parts.length >= 2) {
            const baseName = parts.slice(-2).join('.');
            relatedBaseNames.add(baseName);
          }
        });
        
        // Count how many unrelated base names exist (different from main domain's base)
        const unrelatedCount = Array.from(relatedBaseNames).filter(baseName => 
          baseName !== mainBaseName && baseName !== ''
        ).length;
        
        // Show Automated Insight Banner
        if (unrelatedCount >= 3) {
          // Yellow Warning Banner - Suspicious Pattern
          html += `<div style="
            margin-bottom: 16px;
            padding: 14px 16px;
            background: rgba(245, 158, 11, 0.15);
            border-left: 4px solid #F59E0B;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
          ">`;
          html += `<span style="font-size: 20px; line-height: 1;">⚠️</span>`;
          html += `<div style="flex: 1;">`;
          html += `<div style="
            font-weight: 600;
            color: #FCD34D;
            font-size: 14px;
            margin-bottom: 4px;
          ">Suspicious Pattern Detected</div>`;
          html += `<div style="
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
          ">Multiple unrelated domains share this certificate. This is common in Phishing Kits.</div>`;
          html += `</div>`;
          html += `</div>`;
        } else {
          // Blue Info Banner - Normal Pattern
          html += `<div style="
            margin-bottom: 16px;
            padding: 14px 16px;
            background: rgba(59, 130, 246, 0.15);
            border-left: 4px solid #3B82F6;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
          ">`;
          html += `<span style="font-size: 18px; line-height: 1;">ℹ️</span>`;
          html += `<div style="flex: 1;">`;
          html += `<div style="
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
          ">These domains appear to be related subdomains or infrastructure.</div>`;
          html += `</div>`;
          html += `</div>`;
        }
        
        // Domain count
        html += `<div style="margin-bottom: 16px;">`;
        html += `<span style="
          font-size: 13px;
          color: var(--text-secondary);
          font-weight: 500;
        ">Found <strong style="color: #A855F7;">${count}</strong> domain${count !== 1 ? 's' : ''} sharing SSL certificates</span>`;
        html += `</div>`;
        
        // Evidence Cards Grid
        html += `<div style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 12px;
        ">`;
        
        relatedDomains.forEach((relatedDomain, idx) => {
          html += `<div style="
            padding: 14px;
            background: rgba(17, 25, 40, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
          " onmouseover="this.style.background='rgba(17, 25, 40, 0.9)'; this.style.borderColor='rgba(168, 85, 247, 0.4)'; this.style.boxShadow='0 4px 12px rgba(168, 85, 247, 0.2)';" onmouseout="this.style.background='rgba(17, 25, 40, 0.6)'; this.style.borderColor='rgba(148, 163, 184, 0.2)'; this.style.boxShadow='none';" onclick="if(typeof window.openDossier === 'function') { window.openDossier('${escapeHtml(relatedDomain)}'); }" title="Click to investigate this domain">`;
          html += `<div style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
          ">`;
          html += `<div style="
            width: 24px;
            height: 24px;
            background: rgba(168, 85, 247, 0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #A855F7;
            font-size: 11px;
            flex-shrink: 0;
          ">${idx + 1}</div>`;
          html += `<i data-feather="external-link" style="width: 14px; height: 14px; color: rgba(168, 85, 247, 0.5); flex-shrink: 0;"></i>`;
          html += `</div>`;
          html += `<div style="
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
            word-break: break-all;
            line-height: 1.4;
          ">${escapeHtml(relatedDomain)}</div>`;
          html += `</div>`;
        });
        
        html += `</div>`;
      }
      
      sslContent.innerHTML = html;
      
      if (typeof feather !== 'undefined') {
        setTimeout(function() {
          feather.replace();
          
          // Setup tooltip for info icon
          const tooltipContainers = document.querySelectorAll('.ssl-info-tooltip-container');
          tooltipContainers.forEach(container => {
            const icon = container.querySelector('.ssl-info-icon');
            const tooltip = container.querySelector('.ssl-info-tooltip');
            if (icon && tooltip) {
              icon.addEventListener('mouseenter', function() {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
              });
              icon.addEventListener('mouseleave', function() {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
              });
              container.addEventListener('mouseenter', function() {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
              });
              container.addEventListener('mouseleave', function() {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
              });
            }
          });
        }, 50);
      }
    };
    
    // Function to load cloaking detection asynchronously
    window.loadCloakingDetection = window.loadCloakingDetection || function(domain) {
      const cloakingContent = document.getElementById('cloaking-detection-content');
      if (!cloakingContent) {
        return;
      }
      
      fetch('/api/ghost/cloaking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ domain: domain })
      })
      .then(response => response.json())
      .then(data => {
        if (typeof window.displayCloakingResults === 'function') {
          window.displayCloakingResults(data);
        }
      })
      .catch(error => {
        console.error('Cloaking detection error:', error);
        const cloakingContent = document.getElementById('cloaking-detection-content');
        if (cloakingContent) {
          cloakingContent.innerHTML = `<div style="
            padding: 16px;
            background: rgba(148, 163, 184, 0.1);
            border-left: 3px solid #94A3B8;
            border-radius: 8px;
            color: var(--text-secondary);
          ">Error: Failed to detect cloaking behavior</div>`;
        }
      });
    };
    
    // Function to display cloaking detection results
    window.displayCloakingResults = window.displayCloakingResults || function(data) {
      const cloakingContent = document.getElementById('cloaking-detection-content');
      if (!cloakingContent) {
        return;
      }
      
      const isCloaking = data.is_cloaking || false;
      const verdict = data.verdict || 'Unknown';
      const deviationScore = data.deviation_score || 0;
      const hasNetworkError = data.has_network_error || false;
      const mobileResult = data.mobile_result || {};
      const desktopResult = data.desktop_result || {};
      const botResult = data.bot_result || {};
      const error = data.error;
      
      let html = '';
      
      if (error) {
        html += `<div style="
          padding: 16px;
          background: rgba(148, 163, 184, 0.1);
          border-left: 3px solid #94A3B8;
          border-radius: 8px;
          color: var(--text-secondary);
        ">`;
        html += `<i data-feather="alert-circle" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>`;
        html += `Error: ${escapeHtml(error)}`;
        html += `</div>`;
      } else if (hasNetworkError || verdict.includes('Inconclusive')) {
        // Network Error - show warning but not as critical alert
        html += `<div style="
          margin-bottom: 20px;
          padding: 16px;
          background: rgba(245, 158, 11, 0.15);
          border: 1px solid #F59E0B;
          border-radius: 8px;
          text-align: center;
        ">`;
        html += `<div style="
          font-size: 16px;
          font-weight: 600;
          color: #F59E0B;
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        ">`;
        html += `<span>⚠️</span>`;
        html += `<span>${escapeHtml(verdict)}</span>`;
        html += `</div>`;
        html += `<div style="
          font-size: 13px;
          color: var(--text-secondary);
        ">Unable to determine cloaking status due to network issues</div>`;
        html += `</div>`;
      } else {
        // RED ALERT Banner if cloaking detected
        if (isCloaking) {
          html += `<div style="
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #EF4444;
            border-radius: 8px;
            animation: pulseRed 2s infinite;
            text-align: center;
          ">`;
          html += `<div style="
            font-size: 20px;
            font-weight: 700;
            color: #EF4444;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
          ">`;
          html += `<span>⚠️</span>`;
          html += `<span>EVASION DETECTED</span>`;
          html += `</div>`;
          html += `<div style="
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
          ">This site hides from security bots!</div>`;
          html += `<div style="
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
          ">${escapeHtml(verdict)}</div>`;
          html += `</div>`;
        }
        
        // Comparison Table
        html += `<div style="margin-bottom: 16px;">`;
        html += `<div style="
          font-size: 13px;
          color: var(--text-secondary);
          font-weight: 500;
          margin-bottom: 12px;
        ">Response Comparison:</div>`;
        html += `<div style="
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 12px;
        ">`;
        
        // Mobile Result
        html += `<div style="
          padding: 12px;
          background: rgba(17, 25, 40, 0.6);
          border: 1px solid ${isCloaking && mobileResult.content_size > (botResult.content_size || 0) * 1.5 ? 'rgba(239, 68, 68, 0.5)' : 'rgba(148, 163, 184, 0.2)'};
          border-radius: 8px;
        ">`;
        html += `<div style="
          font-size: 12px;
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 8px;
        ">📱 View as iPhone</div>`;
        html += `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Status: <strong>${mobileResult.status_code || 'N/A'}</strong></div>`;
        html += `<div style="font-size: 11px; color: var(--text-secondary);">Size: <strong>${(mobileResult.content_size || 0).toLocaleString()} bytes</strong></div>`;
        if (mobileResult.error) {
          html += `<div style="font-size: 10px; color: #EF4444; margin-top: 4px;">Error: ${escapeHtml(mobileResult.error)}</div>`;
        }
        html += `</div>`;
        
        // Desktop Result
        html += `<div style="
          padding: 12px;
          background: rgba(17, 25, 40, 0.6);
          border: 1px solid ${isCloaking && desktopResult.content_size > (botResult.content_size || 0) * 1.5 ? 'rgba(239, 68, 68, 0.5)' : 'rgba(148, 163, 184, 0.2)'};
          border-radius: 8px;
        ">`;
        html += `<div style="
          font-size: 12px;
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 8px;
        ">💻 View as Desktop</div>`;
        html += `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Status: <strong>${desktopResult.status_code || 'N/A'}</strong></div>`;
        html += `<div style="font-size: 11px; color: var(--text-secondary);">Size: <strong>${(desktopResult.content_size || 0).toLocaleString()} bytes</strong></div>`;
        if (desktopResult.error) {
          html += `<div style="font-size: 10px; color: #EF4444; margin-top: 4px;">Error: ${escapeHtml(desktopResult.error)}</div>`;
        }
        html += `</div>`;
        
        // Bot Result
        html += `<div style="
          padding: 12px;
          background: rgba(17, 25, 40, 0.6);
          border: 1px solid rgba(148, 163, 184, 0.2);
          border-radius: 8px;
        ">`;
        html += `<div style="
          font-size: 12px;
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 8px;
        ">🤖 View as Bot</div>`;
        html += `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Status: <strong>${botResult.status_code || 'N/A'}</strong></div>`;
        html += `<div style="font-size: 11px; color: var(--text-secondary);">Size: <strong>${(botResult.content_size || 0).toLocaleString()} bytes</strong></div>`;
        if (botResult.error) {
          html += `<div style="font-size: 10px; color: #EF4444; margin-top: 4px;">Error: ${escapeHtml(botResult.error)}</div>`;
        }
        html += `</div>`;
        
        html += `</div>`;
        html += `</div>`;
        
        // Deviation Score
        html += `<div style="
          margin-top: 16px;
          padding: 12px;
          background: ${isCloaking ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'};
          border-left: 3px solid ${isCloaking ? '#EF4444' : '#22C55E'};
          border-radius: 8px;
        ">`;
        html += `<div style="
          font-size: 12px;
          color: var(--text-primary);
          font-weight: 500;
        ">`;
        html += `<span style="color: ${isCloaking ? '#EF4444' : '#22C55E'}; font-weight: 600;">Deviation Score: ${deviationScore.toFixed(1)}%</span>`;
        html += `</div>`;
        html += `<div style="
          font-size: 11px;
          color: var(--text-secondary);
          margin-top: 4px;
        ">${escapeHtml(verdict)}</div>`;
        html += `</div>`;
        
        // Visual Evidence Section - Always show, even if empty
        const visualsHtml = renderCloakingVisuals(mobileResult, desktopResult, botResult);
        html += visualsHtml;
      }
      
      cloakingContent.innerHTML = html;
      
      // Trigger red alert animation if cloaking detected
      if (isCloaking) {
        const alertBanner = cloakingContent.querySelector('[style*="pulseRed"]');
        if (alertBanner) {
          // Add pulsing animation
          alertBanner.style.animation = 'pulseRed 2s infinite';
        }
      }
    };
    
    // Function to render cloaking visuals
    function renderCloakingVisuals(mobileResult, desktopResult, botResult) {
      const mobileHtml = mobileResult.safe_html || '';
      const desktopHtml = desktopResult.safe_html || '';
      const botHtml = botResult.safe_html || '';
      const mobileError = mobileResult.error || (mobileResult.content_size === -1);
      const desktopError = desktopResult.error || (desktopResult.content_size === -1);
      const botError = botResult.error || (botResult.content_size === -1);
      
      let html = '';
      
      // Visual Evidence Section
      html += `<div style="
        margin-top: 30px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
      ">`;
      html += `<div style="
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      ">`;
      html += `<span>🔍</span>`;
      html += `<span>Visual Evidence</span>`;
      html += `</div>`;
      html += `<div style="
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 24px;
        align-items: start;
      ">`;
      
      // 📱 Victim View (Mobile)
      html += `<div style="
        display: flex;
        flex-direction: column;
        align-items: center;
      ">`;
      html += `<div style="
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        text-align: center;
      ">📱 Victim View (Mobile)</div>`;
      
      if (mobileHtml && !mobileError) {
        html += `<div style="
          width: 320px;
          height: 550px;
          border: 8px solid #333;
          border-radius: 20px;
          padding: 0;
          overflow: hidden;
          background: #000;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
          margin: auto;
        ">`;
        html += `<iframe 
          sandbox="allow-same-origin" 
          srcdoc="${mobileHtml.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
          style="
            width: 100%;
            height: 100%;
            border: none;
            background: white;
          "
          title="Mobile View">
        </iframe>`;
        html += `</div>`;
      } else {
        // Empty state - Connection Failed
        html += `<div style="
          width: 320px;
          height: 550px;
          border: 8px solid #333;
          border-radius: 20px;
          background: #1a1a1a;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: auto;
        ">`;
        html += `<div style="
          text-align: center;
          color: var(--text-secondary);
          padding: 20px;
        ">`;
        html += `<div style="font-size: 48px; margin-bottom: 12px;">🚫</div>`;
        html += `<div style="font-size: 14px; font-weight: 500;">Connection Failed</div>`;
        html += `</div>`;
        html += `</div>`;
      }
      html += `</div>`;
      
      // 💻 Employee View (Desktop)
      html += `<div style="
        display: flex;
        flex-direction: column;
      ">`;
      html += `<div style="
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        text-align: center;
      ">💻 Employee View (Desktop)</div>`;
      
      if (desktopHtml && !desktopError) {
        html += `<div style="
          width: 100%;
          height: 400px;
          border: 1px solid #ccc;
          border-radius: 8px;
          overflow: hidden;
          background: white;
        ">`;
        html += `<iframe 
          sandbox="allow-same-origin" 
          srcdoc="${desktopHtml.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
          style="
            width: 100%;
            height: 100%;
            border: none;
          "
          title="Desktop View">
        </iframe>`;
        html += `</div>`;
      } else {
        // Empty state - Connection Failed
        html += `<div style="
          width: 100%;
          height: 400px;
          border: 1px solid #ccc;
          border-radius: 8px;
          background: var(--bg-light);
          display: flex;
          align-items: center;
          justify-content: center;
        ">`;
        html += `<div style="
          text-align: center;
          color: var(--text-secondary);
        ">`;
        html += `<div style="font-size: 48px; margin-bottom: 12px;">🚫</div>`;
        html += `<div style="font-size: 14px; font-weight: 500;">Connection Failed</div>`;
        html += `</div>`;
        html += `</div>`;
      }
      html += `</div>`;
      
      // 🤖 Scanner View (Bot) - with grayscale filter
      html += `<div style="
        display: flex;
        flex-direction: column;
      ">`;
      html += `<div style="
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        text-align: center;
      ">🤖 Scanner View (Bot)</div>`;
      
      if (botHtml && !botError) {
        html += `<div style="
          width: 100%;
          height: 400px;
          border: 1px solid #ccc;
          border-radius: 8px;
          overflow: hidden;
          background: white;
          filter: grayscale(100%);
        ">`;
        html += `<iframe 
          sandbox="allow-same-origin" 
          srcdoc="${botHtml.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
          style="
            width: 100%;
            height: 100%;
            border: none;
          "
          title="Bot View">
        </iframe>`;
        html += `</div>`;
      } else {
        // Empty state - Connection Failed
        html += `<div style="
          width: 100%;
          height: 400px;
          border: 1px solid #ccc;
          border-radius: 8px;
          background: var(--bg-light);
          display: flex;
          align-items: center;
          justify-content: center;
          filter: grayscale(100%);
        ">`;
        html += `<div style="
          text-align: center;
          color: var(--text-secondary);
        ">`;
        html += `<div style="font-size: 48px; margin-bottom: 12px;">🚫</div>`;
        html += `<div style="font-size: 14px; font-weight: 500;">Connection Failed</div>`;
        html += `</div>`;
        html += `</div>`;
      }
      html += `</div>`;
      
      html += `</div>`;
      html += `</div>`;
      
      return html;
    }
    
    // Function to send AI feedback
    window.sendAIFeedback = window.sendAIFeedback || function(domain, feedback) {
      fetch('/api/ai/feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ domain: domain, feedback: feedback })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show toast notification
          showToastNotification(data.message || 'Thank you! Model updated.', 'success');
        } else {
          showToastNotification('Error saving feedback: ' + (data.error || 'Unknown error'), 'error');
        }
      })
      .catch(error => {
        console.error('Feedback error:', error);
        showToastNotification('Failed to send feedback. Please try again.', 'error');
      });
    };
    
    // Function to show toast notification
    function showToastNotification(message, type) {
      // Remove existing toast if any
      const existingToast = document.getElementById('ai-feedback-toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.id = 'ai-feedback-toast';
      toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 16px 20px;
        background: ${type === 'success' ? 'rgba(34, 197, 94, 0.95)' : 'rgba(239, 68, 68, 0.95)'};
        border: 1px solid ${type === 'success' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)'};
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 10002;
        animation: slideInUp 0.3s ease;
        max-width: 400px;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'slideOutDown 0.3s ease';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('dossier-modal');
      if (event.target === modal && typeof window.closeDossier === 'function') {
        window.closeDossier();
      }
    });
  </script>

  {# Add spin animation for loading icon #}
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
      }
    }
    @keyframes slideInUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes slideOutDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(100px);
        opacity: 0;
      }
    }
    @keyframes pulseRed {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        border-color: #EF4444;
      }
      50% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        border-color: #F87171;
      }
    }
  </style>

  {# OSINT Dossier Modal - Redesigned - Moved outside email-report-container to fix visibility issue #}
  <div id="dossier-modal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(4, 7, 15, 0.95);
    backdrop-filter: blur(8px);
    z-index: 10001;
    overflow-y: auto;
    animation: fadeIn 0.3s ease;
  ">
    <div style="
      max-width: 1000px;
      margin: 30px auto;
      background: linear-gradient(145deg, rgba(10, 18, 32, 0.98), rgba(17, 25, 40, 0.95));
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(168, 85, 247, 0.2);
      padding: 0;
      overflow: hidden;
      animation: slideUp 0.4s ease;
    ">
      {# Header #}
      <div style="
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(139, 92, 246, 0.1));
        border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        padding: 24px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #A855F7, #9333EA);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
          ">
            <i data-feather="target" style="width: 24px; height: 24px; color: white;"></i>
          </div>
          <div>
            <h2 style="
              margin: 0;
              color: var(--text-primary);
              font-size: 24px;
              font-weight: 700;
              letter-spacing: 0.5px;
            ">Domain Intelligence Dossier</h2>
            <p style="
              margin: 4px 0 0 0;
              color: rgba(168, 85, 247, 0.8);
              font-size: 13px;
              font-weight: 500;
            ">OSINT Active Reconnaissance Report</p>
          </div>
        </div>
        <button onclick="window.closeDossier && window.closeDossier()" style="
          background: rgba(148, 163, 184, 0.1);
          border: 1px solid rgba(148, 163, 184, 0.2);
          color: var(--text-secondary);
          padding: 10px 16px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 8px;
        " onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.3)'; this.style.color='#EF4444';" onmouseout="this.style.background='rgba(148, 163, 184, 0.1)'; this.style.borderColor='rgba(148, 163, 184, 0.2)'; this.style.color='var(--text-secondary)';">
          <i data-feather="x" style="width: 18px; height: 18px;"></i>
          Close
        </button>
      </div>
      
      {# Content #}
      <div id="dossier-content" style="padding: 30px; font-size: 14px; line-height: 1.7;">
        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary);">
          <div style="
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <i data-feather="loader" style="width: 32px; height: 32px; animation: spin 1s linear infinite; color: #A855F7;"></i>
          </div>
          <p style="margin: 0; font-size: 15px; font-weight: 500;">Loading intelligence data...</p>
        </div>
      </div>
    </div>
  </div>

</body>
</html>